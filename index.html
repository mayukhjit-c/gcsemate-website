
<!DOCTYPE html>
<html lang="en">
<head>
<meta name="google-adsense-account" content="ca-pub-3142302168894001">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3142302168894001"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCSEMate - Your Ultimate GCSE Revision Partner</title>
    <meta name="description" content="Your ultimate partner for GCSE success. Access free revision notes, past papers, and study guides for Maths, Science, English, and more. Ace your exams with GCSEMate!">
    <link rel="preconnect" href="https://drive.google.com">
    <meta name="keywords" content="GCSE, revision, study, exams, past papers, study notes, GCSEMate, AQA, Edexcel, OCR, Maths, Science, English, History, Geography, Videos, Blog, FAQ, Help">
    <meta name="author" content="GCSEMate">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#2563eb">
    <link rel="canonical" href="/">
    <!-- Open Graph -->
    <meta property="og:title" content="GCSEMate - Your Ultimate GCSE Revision Partner">
    <meta property="og:description" content="Ace your exams with organized revision notes, past papers, videos, and more.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://placehold.co/1200x630/3B82F6/FFFFFF?text=GCSEMate">

    <link rel="icon" type="image/png" href="gcsemate favicon.png">
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/3B82F6/FFFFFF?text=G" data-fallback-favicon>
    <script>
    (function(){
        try{
            var primary = 'gcsemate favicon.png';
            var img = new Image();
            img.onerror = function(){
                var alt = document.querySelector('link[data-fallback-favicon]');
                if(!alt) return;
                document.querySelectorAll('link[rel="icon"]').forEach(function(n){ n.parentNode.removeChild(n); });
                document.head.appendChild(alt.cloneNode(true));
            };
            img.src = primary;
        }catch(_){}
    })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://apis.google.com" crossorigin>
    <link rel="dns-prefetch" href="https://pagead2.googlesyndication.com">
    <link rel="dns-prefetch" href="https://static.cloudflareinsights.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.google.com/recaptcha/api.js?render=6LcU7aQrAAAAANXnNxEwnLlMI26R5AkUOdnDg7Wk" async defer></script>
    
    <style>
        :root {
            /* Default accent: Tailwind blue-500 rgb */
            --accent-50: 239 246 255;
            --accent-100: 219 234 254;
            --accent-300: 147 197 253;
            --accent-400: 96 165 250;
            --accent-500: 59 130 246;
            --accent-600: 37 99 235;
            --accent-700: 29 78 216;
        }
        /* Base styles for a polished look */
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-feature-settings: 'kern' 1, 'liga' 1, 'calt' 1;
            /* Respect safe areas on iOS / notches */
            padding-top: env(safe-area-inset-top, 0);
            padding-right: env(safe-area-inset-right, 0);
            padding-bottom: env(safe-area-inset-bottom, 0);
            padding-left: env(safe-area-inset-left, 0);
        }
        
        /* Performance optimizations */
        * {
            box-sizing: border-box;
        }
        
        /* Optimize animations for GPU acceleration */
        .gpu-accelerated {
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000px;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        /* Improve layout consistency and resizing */
        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; }
        /* Custom scrollbar for a modern feel */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        /* Utility to hide scrollbars for overflow regions */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Enhanced Loader animations */
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        
        /* Professional dots spinner for preview loading */
        .dots-spinner {
            display: inline-flex;
            gap: 4px;
            align-items: center;
        }
        .dots-spinner i {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: dot-pulse 1.4s ease-in-out infinite both;
        }
        .dots-spinner i:nth-child(1) { animation-delay: -0.32s; }
        .dots-spinner i:nth-child(2) { animation-delay: -0.16s; }
        .dots-spinner i:nth-child(3) { animation-delay: 0s; }
        
        @keyframes spin {
            0% { transform: rotate(0deg) translateZ(0); }
            100% { transform: rotate(360deg) translateZ(0); }
        }
        
        @keyframes dot-pulse {
            0%, 80%, 100% {
                transform: scale(0.8) translateZ(0);
                opacity: 0.6;
            }
            40% {
                transform: scale(1.2) translateZ(0);
                opacity: 1;
            }
        }
        
        /* Skeleton loading animation */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Smooth focus ring */
        .focus-ring {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
            transition: box-shadow 0.2s ease;
        }
        
        /* Premium shadows */
        .shadow-premium {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .shadow-premium-lg {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Optimized transitions for better UX */
        .transition-all { 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: auto;
        }
        .transition-transform { 
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }
        .transition-opacity { 
            transition: opacity 0.3s ease-in-out;
            will-change: opacity;
        }
        .transition-height { 
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: max-height;
        }
        
        /* Ultra-smooth transitions for premium feel */
        .transition-smooth {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: auto;
        }
        
        .transition-bounce {
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            will-change: auto;
        }
        
        /* Enhanced hover effects with GPU acceleration */
        .hover-lift {
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                        box-shadow 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform, box-shadow;
        }
        
        .hover-lift:hover:not(:disabled) {
            transform: translateY(-4px) translateZ(0);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
        }
        
        .hover-scale {
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
        }
        
        .hover-scale:hover:not(:disabled) {
            transform: scale(1.05) translateZ(0);
        }
        
        /* Premium hover effects */
        .hover-glow:hover {
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
        }
        
        .hover-float {
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            will-change: transform;
        }
        
        .hover-float:hover {
            transform: translateY(-8px) translateZ(0);
        }
        
        /* Premium button styles */
        .btn-primary {
            background: linear-gradient(135deg, rgb(var(--accent-600)), rgb(var(--accent-700)));
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.875rem 1.75rem;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            will-change: transform, box-shadow;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, rgb(var(--accent-700)), rgb(var(--accent-600)));
            transform: translateY(-2px) translateZ(0);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:active {
            transform: translateY(0) translateZ(0);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #374151;
            font-weight: 500;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Premium card hover effects */
        .card-hover {
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(255, 255, 255, 0.2);
            will-change: transform, box-shadow, border-color;
            backface-visibility: hidden;
        }
        
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02) translateZ(0);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.6);
        }
        
        /* Glass morphism effect */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .glass-effect:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        /* Professional focus states */
        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 0 0 2px rgb(var(--accent-500));
        }
        
        /* Loading states */
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Button loading states */
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Disabled state improvements */
        button:disabled,
        input:disabled,
        select:disabled,
        textarea:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* Better focus indicators */
        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 0 0 2px rgb(var(--accent-500));
        }
        
        /* Improved hover states */
        .hover-lift:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .hover-scale:hover:not(:disabled) {
            transform: scale(1.02);
        }
        
        /* Performance optimizations */
        .will-change-transform { will-change: transform; }
        .will-change-opacity { will-change: opacity; }
        .gpu-accelerated { transform: translateZ(0); }
        
        /* Lazy loading optimization */
        .lazy-image {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .lazy-image.loaded {
            opacity: 1;
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .card-hover {
                border-width: 2px;
                border-color: #000;
            }
            .btn-primary {
                border: 2px solid #000;
            }
        }
        /* Active navigation link style */
        .nav-link.active {
            color: #2563eb;
            font-weight: 700;
            position: relative;
            background-color: rgb(var(--accent-50));
            border-radius: 0.5rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        /* Remove any border styling for active nav links */
        .nav-link.active::before,
        .nav-link.active::after {
            display: none;
        }
        
        /* Ensure no borders on any nav links */
        .nav-link {
            border: none !important;
        }
        /* Kill any decorative pseudo-elements that may add vertical bars */
        .nav-link::before,
        .nav-link::after { content: none !important; display: none !important; }
        /* Remove focus outlines for cleaner look; color handles the state */
        .nav-link:focus { outline: none !important; box-shadow: none !important; }
        
        .nav-link:hover {
            border: none !important;
        }
        
        .nav-link.active {
            border: none !important;
        }
        /* Prose styles for text content pages */
        .prose { max-width: 65ch; }
        .prose-lg { font-size: 1.125rem; line-height: 1.777; }
        .prose h2 { font-size: 2.25rem; line-height: 2.5rem; margin-bottom: 1rem; font-weight: 800; }
        .prose h3 { font-size: 1.5rem; line-height: 2rem; margin-top: 2rem; margin-bottom: 1rem; font-weight: 700; }
        .prose p { margin-bottom: 1.25em; }
        .prose blockquote { border-left-width: 4px; border-left-color: #3b82f6; padding-left: 1rem; font-style: italic; }
        .prose img { border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }

        /* Accent utility overrides for existing Tailwind blue classes */
        .text-blue-600 { color: rgb(var(--accent-600)) !important; }
        .text-blue-700 { color: rgb(var(--accent-700)) !important; }
        .bg-blue-50 { background-color: rgb(var(--accent-50)) !important; }
        .bg-blue-100 { background-color: rgb(var(--accent-100)) !important; }
        .bg-blue-600 { background-color: rgb(var(--accent-600)) !important; }
        .hover\:bg-blue-700:hover { background-color: rgb(var(--accent-700)) !important; }
        .focus\:ring-blue-300:focus { --tw-ring-color: rgb(var(--accent-300)) !important; }
        .focus\:ring-blue-400:focus { --tw-ring-color: rgb(var(--accent-400)) !important; }
        .ring-blue-300 { --tw-ring-color: rgb(var(--accent-300)) !important; }
        .ring-blue-400 { --tw-ring-color: rgb(var(--accent-400)) !important; }
        .border-blue-200 { border-color: rgb(var(--accent-100)) !important; }
        .border-blue-300 { border-color: rgb(var(--accent-300)) !important; }

        /* Premium UI Animations */
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateZ(0); } 
            to { opacity: 1; transform: translateZ(0); } 
        }
        
        /* iOS‑like ultra-smooth page transitions */
        .page-enter-modern { animation: elevateIn 520ms cubic-bezier(0.22, 1, 0.36, 1) both; will-change: transform, opacity; }
        .page-leave-modern { animation: elevateOut 320ms ease both; will-change: transform, opacity; }
        @keyframes elevateIn {
            0% { opacity: 0; transform: translateY(14px) scale(0.985); }
            60% { opacity: 1; transform: translateY(0) scale(1.002); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes elevateOut {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(6px) scale(0.992); }
        }

        /* AOS (Animate On Scroll) micro‑library */
        [data-animate] { opacity: 1; will-change: transform, opacity; }
        .aos-animate { opacity: 1; }
        .aos-fade-up { animation: fadeUp 680ms cubic-bezier(0.22, 1, 0.36, 1) both; }
        .aos-blur-in { animation: fadeUp 720ms cubic-bezier(0.22, 1, 0.36, 1) both; }
        .aos-zoom-in { animation: zoomIn 620ms cubic-bezier(0.34, 1.56, 0.64, 1) both; }
        .aos-slide-right { animation: slideRight 720ms cubic-bezier(0.22, 1, 0.36, 1) both; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes blurIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes zoomIn { 0% { opacity: 0; transform: scale(0.96); } 70% { opacity: 1; transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes slideRight { from { opacity: 0; transform: translateX(-18px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { 
            from { opacity: 1; transform: translateZ(0); } 
            to { opacity: 0; transform: translateZ(0); } 
        }
        @keyframes slideInUp { 
            from { transform: translateY(30px) translateZ(0); opacity: 0; } 
            to { transform: translateY(0) translateZ(0); opacity: 1; } 
        }
        @keyframes slideInDown { 
            from { transform: translateY(-30px) translateZ(0); opacity: 0; } 
            to { transform: translateY(0) translateZ(0); opacity: 1; } 
        }
        @keyframes slideInLeft { 
            from { transform: translateX(-30px) translateZ(0); opacity: 0; } 
            to { transform: translateX(0) translateZ(0); opacity: 1; } 
        }
        @keyframes slideInRight { 
            from { transform: translateX(30px) translateZ(0); opacity: 0; } 
            to { transform: translateX(0) translateZ(0); opacity: 1; } 
        }
        @keyframes pop { 
            0% { transform: scale(0.8) translateZ(0); } 
            50% { transform: scale(1.05) translateZ(0); } 
            100% { transform: scale(1) translateZ(0); } 
        }
        @keyframes bounce { 
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); } 
            40%, 43% { transform: translate3d(0, -8px, 0); } 
            70% { transform: translate3d(0, -4px, 0); } 
            90% { transform: translate3d(0, -2px, 0); } 
        }
        @keyframes pulse { 
            0% { transform: scale(1) translateZ(0); } 
            50% { transform: scale(1.05) translateZ(0); } 
            100% { transform: scale(1) translateZ(0); } 
        }
        
        .fade-in { 
            animation: fadeIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; 
            will-change: opacity, transform; 
        }
        .slide-in-up { 
            animation: slideInUp 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; 
            will-change: transform, opacity; 
        }
        .slide-in-down { 
            animation: slideInDown 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; 
            will-change: transform, opacity; 
        }
        .slide-in-left { 
            animation: slideInLeft 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; 
            will-change: transform, opacity; 
        }
        .slide-in-right { 
            animation: slideInRight 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; 
            will-change: transform, opacity; 
        }
        .page-transition-enter { 
            animation: slideInUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; 
            will-change: transform, opacity; 
        }
        .bounce { animation: bounce 1s ease-in-out; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        /* Star icon animation */
        .star-icon { transition: transform 0.2s ease, color 0.2s ease; position: relative; }
        .star-icon.starred { color: #facc15; transform: scale(1.15); }
        .star-icon:hover { transform: scale(1.35); }
        .star-icon.pop-animation { animation: pop 0.28s ease-out forwards; }
        /* Sparkle burst for starring */
        .sparkle-burst { position: absolute; inset: 0; pointer-events: none; }
        .sparkle-burst span { position: absolute; width: 6px; height: 6px; border-radius: 9999px; background: #fde68a; opacity: 0; }
        @keyframes sparkleOut { 0% { transform: translate(0,0) scale(0.4); opacity: 0.9; } 100% { transform: translate(var(--tx), var(--ty)) scale(0.6); opacity: 0; } }
        /* Aspect ratio for embeds */
        .aspect-w-16 { position: relative; padding-bottom: 56.25%; }
        .aspect-h-9 { position: relative; padding-bottom: 56.25%; height: 0; }
        .aspect-w-16 > iframe, .aspect-h-9 > iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        /* Calendar styles */
        .calendar-day.today { background-color: #bfdbfe; color: #1e40af; font-weight: bold; }
        .calendar-day.has-event { position: relative; }
        .calendar-day.has-event::after {
            content: ''; position: absolute; bottom: 6px; left: 50%;
            transform: translateX(-50%); width: 6px; height: 6px;
            border-radius: 50%; background-color: #3b82f6;
        }
        .calendar-day.has-global-event::after { background-color: #16a34a; }
        /* Landing Page Specific Animations */
        .animate-hero-title { animation: slideInUp 0.8s ease-out 0.2s forwards; opacity: 0; }
        .animate-hero-subtitle { animation: slideInUp 0.8s ease-out 0.4s forwards; opacity: 0; }
        .animate-hero-buttons { animation: slideInUp 0.8s ease-out 0.6s forwards; opacity: 0; }
        .animate-feature-card { animation: slideInUp 0.7s ease-out forwards; opacity: 0; }
        /* Clock styles */
        /* Gmail-style indeterminate progress bar */
        .progress-bar { position: relative; height: 6px; overflow: hidden; border-radius: 9999px; background: #e5e7eb; }
        .progress-bar .bar { position: absolute; height: 100%; background: #2563eb; will-change: left, right; }
        .progress-bar .bar1 { animation: indeterminate1 2.1s cubic-bezier(0.65, 0.815, 0.735, 0.395) infinite; }
        .progress-bar .bar2 { animation: indeterminate2 2.1s cubic-bezier(0.165, 0.84, 0.44, 1) infinite; background: rgba(37, 99, 235, 0.7); }
        @keyframes indeterminate1 {
            0% { left: -35%; right: 100%; }
            60% { left: 100%; right: -90%; }
            100% { left: 100%; right: -90%; }
        }
        @keyframes indeterminate2 {
            0% { left: -200%; right: 100%; }
            60% { left: 107%; right: -8%; }
            100% { left: 107%; right: -8%; }
        }
        /* Subtle floating animation for transparent PNG logo */
        .animate-logo { animation: logoFloat 6s ease-in-out infinite; }
        @keyframes logoFloat {
            0% { transform: translateY(8px) scale(1); filter: drop-shadow(0 6px 12px rgba(37,99,235,0.15)); opacity: .95; }
            50% { transform: translateY(-2px) scale(1.02); filter: drop-shadow(0 10px 18px rgba(37,99,235,0.22)); opacity: 1; }
            100% { transform: translateY(8px) scale(1); filter: drop-shadow(0 6px 12px rgba(37,99,235,0.15)); opacity: .95; }
        }
        /* Disable any Tailwind backdrop blur utilities globally (no blur UX) */
        .backdrop-blur, .backdrop-blur-sm, .backdrop-blur-md, .backdrop-blur-lg, .backdrop-blur-xl, [class*="backdrop-blur-"] {
            -webkit-backdrop-filter: none !important;
            backdrop-filter: none !important;
        }

        /* Seamless page loading overlay */
        #page-loading-overlay { background: rgba(255,255,255,0.86); opacity: 0; transition: opacity 220ms ease; pointer-events: none; display: flex; align-items: center; justify-content: center; }
        #page-loading-overlay.visible { opacity: 1; pointer-events: auto; }
        .loading-orb { width: 54px; height: 54px; border-radius: 9999px; border: 3px solid rgba(59,130,246,0.15); border-top-color: rgb(var(--accent-600)); animation: spin 820ms linear infinite; }
        .loading-pulse { width: 12px; height: 12px; border-radius: 9999px; background: rgb(var(--accent-600)); animation: pulseDot 900ms ease-in-out infinite; }
        .loading-pulse:nth-child(2) { animation-delay: 120ms; }
        .loading-pulse:nth-child(3) { animation-delay: 240ms; }
        @keyframes pulseDot { 0%, 100% { transform: translateY(0); opacity: .55; } 50% { transform: translateY(-6px); opacity: 1; } }

        /* Brand polish: subtle gradients and hover states */
        .brand-gradient { background-image: linear-gradient(135deg, rgba(var(--accent-50),1) 0%, rgba(var(--accent-100),1) 100%); }
        .hover-raise { transition: transform .32s cubic-bezier(.22,1,.36,1), box-shadow .32s ease; }
        .hover-raise:hover { transform: translateY(-4px); box-shadow: 0 14px 30px rgba(0,0,0,.08); }
        .hover-tint:hover { background-color: rgba(var(--accent-50), .8); }
        a.nav-link { transition: color .2s ease, background-color .2s ease; border-radius: .5rem; padding-left: .5rem; padding-right: .5rem; }
        a.nav-link:hover { background-color: rgba(var(--accent-50), .7); }
        
        /* Mobile menu optimizations */
        #mobile-menu { padding-top: env(safe-area-inset-top, 0); }
        #mobile-menu .nav-link { min-height: 56px; letter-spacing: .2px; justify-content: center; text-align: center; }

        /* Low-spec mode tuning for ultra-smoothness */
        .low-spec .hover-raise:hover { transform: none; box-shadow: 0 8px 18px rgba(0,0,0,.06); }
        .low-spec .page-enter-modern { animation-duration: 360ms; }
        .low-spec .page-leave-modern { animation-duration: 240ms; }
        #dashboard-clock {
            font-feature-settings: 'tnum'; /* Tabular nums for non-jumping clock */
            font-family: 'SF Pro Text', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
        }
        /* Custom Tooltip */
        .custom-tooltip {
            position: absolute;
            background-color: #1f2937;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.875rem;
            z-index: 100;
            opacity: 0;
            transform: translateY(-4px);
            transition: opacity 0.18s ease-out, transform 0.18s ease-out;
            will-change: opacity, transform;
            pointer-events: none;
            white-space: nowrap;
        }
        .custom-tooltip.show { opacity: 1; transform: translateY(0); }
        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10010; /* above modals */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
         .toast {
             padding: 12px 16px;
             border-radius: 10px;
             color: #111827;
             font-weight: 600;
             box-shadow: 0 6px 18px rgba(0,0,0,0.12);
             background-color: #fff;
             border: 1px solid rgba(255,255,255,0.7);
             backdrop-filter: blur(8px);
             animation: toastIn 0.18s ease-out;
             will-change: opacity, transform;
         }
         .toast.success { background: rgba(16,185,129,0.9); color: white; }
         .toast.error { background: rgba(239,68,68,0.95); color: white; }
         .toast.warning { background: rgba(245,158,11,0.95); color: #111827; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(6px); } }
        /* Skeleton Loader Shimmer Effect */
        .skeleton {
            background-color: #e5e7eb;
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
        }
        .skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transform: translateX(-100%);
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }
        /* Input search inline spinner (dots) */
        .dots-spinner { display: inline-flex; gap: 3px; align-items: center; }
        .dots-spinner i { width: 4px; height: 4px; border-radius: 9999px; background: rgb(var(--accent-600)); animation: dotPulse 1s infinite ease-in-out; }
        .dots-spinner i:nth-child(2) { animation-delay: 0.15s; }
        .dots-spinner i:nth-child(3) { animation-delay: 0.3s; }
        @keyframes dotPulse { 0%, 80%, 100% { opacity: .2; transform: scale(1); } 40% { opacity: 1; transform: scale(1.6); } }
        /* FAQ Accordion */
        .faq-item .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.28s ease, padding 0.2s ease;
            will-change: max-height;
            padding: 0 1.25rem 0 1.25rem; /* match px-5 to keep layout stable */
            margin: 0;
        }
        .faq-item.open .faq-answer { transition: max-height 0.32s ease, padding 0.2s ease; }
        .faq-item .faq-arrow {
            transition: transform 0.3s ease-in-out;
        }
        .faq-item.open .faq-arrow {
            transform: rotate(180deg);
        }
        /* Highlighting for FAQ search */
        .faq-item[data-hidden="true"] { display: none; }

        /* Hide visible reCAPTCHA badge while keeping protection active */
        .grecaptcha-badge { visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; }

        /* Page transitions */
        .page-transition-enter { animation: fadeIn 0.22s ease-out both; }
        .page-transition-leave { animation: fadeOut 0.18s ease-in both; }

        /* Respect users who prefer reduced motion */
        @media (prefers-reduced-motion: reduce) {
            * { animation: none !important; transition: none !important; }
            /* Ensure elements that normally fade in via animation are visible */
            .animate-hero-title,
            .animate-hero-subtitle,
            .animate-hero-buttons,
            .animate-feature-card,
            .animate-logo { opacity: 1 !important; }
        }
        
        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            /* Ensure minimum touch target size */
            button, a, [role="button"] {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Improve text readability on mobile */
            .text-sm { font-size: 0.875rem; }
            .text-base { font-size: 1rem; }
            .text-lg { font-size: 1.125rem; }
            
            /* Better spacing for mobile */
            .p-4 { padding: 1rem; }
            .p-6 { padding: 1.5rem; }
            .p-8 { padding: 2rem; }
            
            /* Ensure buttons are visible and properly sized */
            .btn-primary, .btn-secondary {
                min-height: 56px;
                font-size: 1rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Improve mobile menu visibility and interaction */
            #mobile-menu {
                display: none;
                transform: translateX(100%) translateZ(0);
                opacity: 0;
                transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                            opacity 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
                will-change: transform, opacity;
                backface-visibility: hidden;
            }
            
            #mobile-menu:not(.hidden) {
                display: block;
                transform: translateX(0) translateZ(0);
                opacity: 1;
            }
            
            #mobile-menu .nav-link {
                min-height: 56px;
                display: flex;
                align-items: center;
                font-size: 1.125rem;
                touch-action: manipulation;
                transition: all 0.2s ease;
            }
            
            #mobile-menu .nav-link:active {
                transform: scale(0.98);
                background-color: rgba(59, 130, 246, 0.1);
            }
            
            /* Better file browser on mobile */
            #file-list .grid {
                gap: 0.75rem;
            }
            
            /* Improve form inputs on mobile */
            input, select, textarea {
                font-size: 16px !important; /* Prevents zoom on iOS */
                min-height: 44px;
            }
            
            /* Landing page specific mobile improvements */
            .animate-hero-buttons {
                width: 100%;
                max-width: 100%;
            }
            
            .animate-hero-buttons button {
                width: 100%;
                max-width: 320px;
                margin: 0 auto;
            }
            
            /* Better mobile navigation */
            nav a {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Improve mobile card interactions */
            .card-hover {
                touch-action: manipulation;
            }
            
            .card-hover:active {
                transform: scale(0.98);
            }
            
            /* Better mobile scrolling */
            .overflow-y-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Improve mobile focus states */
            .focus-ring:focus {
                outline: none;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            }
        }
        /* Tablet optimizations */
        @media (max-width: 1024px) and (min-width: 769px) {
            .p-8 { padding: 1.75rem; }
            .grid.gap-8 { gap: 1.25rem; }
            #page-content { scroll-snap-type: y proximity; }
            .page { scroll-snap-align: start; }
        }
        /* Foldable hint (where supported) */
        @media (spanning: single-fold-vertical) {
            #page-content { column-gap: 24px; }
            .page { padding-left: 12px; padding-right: 12px; }
        }
        
        /* Optimized mobile menu animation */
        @keyframes slideInFromRight {
            from {
                transform: translateX(100%) translateZ(0);
                opacity: 0;
            }
            to {
                transform: translateX(0) translateZ(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutToRight {
            from {
                transform: translateX(0) translateZ(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%) translateZ(0);
                opacity: 0;
            }
        }
        
        /* Staggered animation delays for list items */
        .stagger-1 { animation-delay: 0.1s; }
        .stagger-2 { animation-delay: 0.2s; }
        .stagger-3 { animation-delay: 0.3s; }
        .stagger-4 { animation-delay: 0.4s; }
        .stagger-5 { animation-delay: 0.5s; }
        
        /* High contrast mode for better accessibility */
        @media (prefers-contrast: high) {
            .btn-primary {
                border: 2px solid #000;
                background-color: #000;
                color: #fff;
            }
            
            .btn-secondary {
                border: 2px solid #000;
                background-color: #fff;
                color: #000;
            }
            
            .card-hover {
                border: 2px solid #000;
            }
            
            .nav-link {
                border: 1px solid transparent;
            }
            
            .nav-link:hover,
            .nav-link:focus {
                border-color: #000;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .card-hover:hover {
                transform: none;
            }
            
            .hover-lift:hover {
                transform: none;
            }
            
            .hover-scale:hover {
                transform: none;
            }
        }
        
        /* Branded video overlay */
        .video-brand-wrapper { position: relative; background-color: #000; }
        .video-brand-watermark { position: absolute; top: 8px; left: 8px; opacity: .7; pointer-events: none; }
        .video-brand-controls { position: absolute; right: 8px; bottom: 8px; display: flex; gap: 6px; }
        :fullscreen .video-brand-watermark { opacity: .85; }
    </style>
    </head>
    <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <a href="#page-content" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 focus:z-[20001] focus:px-4 focus:py-2 focus:rounded-md focus:bg-blue-600 focus:text-white">Skip to main content</a>
    <div class="fixed inset-0 -z-50 bg-white bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:24px_24px]"></div>
    <!-- Loading Overlay -->
    <div id="app-loading" class="fixed inset-0 z-[20000] flex flex-col items-center justify-center bg-white">
        <img src="gcsemate%20new.png" alt="GCSEMate Logo" class="h-16 w-auto mb-6 animate-logo drop-shadow-[0_6px_12px_rgba(37,99,235,0.25)]" loading="eager" decoding="async" onerror="if(!this.dataset.fallback){this.dataset.fallback='imghippo'; this.src='https://i.imghippo.com/files/IxF8202tcg.jpg';} else { this.onerror=null; this.src='https://placehold.co/220x64/3B82F6/FFFFFF?text=GCSEMate'; }" style="opacity:0; transform: translateY(8px); transition: opacity .35s ease-out, transform .35s cubic-bezier(0.22, 1, 0.36, 1);">
        <div class="w-[300px] max-w-[80vw] progress-bar">
            <div class="bar bar1"></div>
            <div class="bar bar2"></div>
        </div>
        <p class="mt-4 text-sm text-gray-500">Loading GCSEMate…</p>
    </div>
    <div class="absolute top-0 left-0 w-full h-full bg-white bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:32px_32px] -z-10"></div>
    <div class="absolute inset-0 -z-20 h-full w-full bg-gradient-to-br from-blue-50 to-indigo-100"></div>
    <!-- Subtle site-wide watermark -->
    <div id="site-watermark" aria-hidden="true" class="fixed bottom-4 right-4 z-[60] select-none pointer-events-none">
        <img src="gcsemate%20new.png" alt="" class="h-8 w-auto opacity-10 grayscale">
    </div>
    <div id="landing-page" class="hidden w-full max-w-6xl mx-auto p-4 sm:p-6 lg:p-8 text-center fade-in">
        <header class="flex justify-between items-center py-4">
             <img src="gcsemate%20new.png" alt="GCSEMate Logo" class="h-10 w-auto drop-shadow-[0_4px_10px_rgba(37,99,235,0.25)]" onerror="if(!this.dataset.fallback){this.dataset.fallback='imghippo'; this.src='https://i.imghippo.com/files/IxF8202tcg.jpg';} else { this.onerror=null; this.src='https://placehold.co/160x40/3B82F6/FFFFFF?text=GCSEMate'; }">
              <div>
                  <button onclick="showAuthPage(true)" class="text-sm font-semibold text-gray-700 hover:text-blue-600 transition-colors mr-4">Login</button>
                  <button onclick="showAuthPage(false)" class="btn-primary hover-lift transition-all">Sign Up Free</button>
              </div>
        </header>
        <main class="mt-16 sm:mt-24">
            <div class="animate-hero-title">
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-gray-900 tracking-tight">
                    Stop Searching, <span class="text-blue-600">Start Revising.</span>
                </h1>
            </div>
            <div class="animate-hero-subtitle">
                <p class="mt-4 max-w-2xl mx-auto text-lg sm:text-xl text-gray-600">
                    GCSEMate is the all-in-one digital hub that organizes your entire academic life. All your subjects, notes, past papers, and resources—perfectly structured and instantly accessible.
                </p>
            </div>
            <div class="mt-8 flex flex-col sm:flex-row justify-center items-center gap-4 animate-hero-buttons px-4 sm:px-0">
                <button onclick="showAuthPage(false)" class="w-full sm:w-auto px-6 sm:px-8 py-4 text-base font-bold text-white bg-blue-600 rounded-xl shadow-lg hover:bg-blue-700 transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 min-h-[56px] flex items-center justify-center" data-tooltip="Create your free account now">
                    Get Started for Free
                </button>
                <button onclick="showAuthPage(true)" class="w-full sm:w-auto px-6 sm:px-8 py-4 text-base font-bold text-blue-700 bg-transparent rounded-xl hover:bg-blue-50 transition-colors border-2 border-blue-600 min-h-[56px] flex items-center justify-center">
                    Login
                </button>
            </div>
            <div class="mt-20 sm:mt-32">
                <h2 class="text-3xl font-bold text-gray-800 tracking-tight">Everything you will need to ace your exams!</h2>
                <p class="mt-3 text-gray-500">The ultimate toolkit designed by a student, for students.</p>
                <div class="mt-12 grid gap-8 md:grid-cols-3">
                    <div class="p-8 bg-white/50 backdrop-blur-xl rounded-2xl shadow-lg card-hover animate-feature-card" style="animation-delay: 0.1s;">
                        <div class="inline-flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 text-blue-600 transition-transform duration-300">
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        </div>
                        <h3 class="mt-6 text-xl font-bold text-gray-900">Centralised Hub</h3>
                        <p class="mt-2 text-gray-600">Say goodbye to scattered files. Access all your subjects and resources from one beautifully organized dashboard.</p>
                    </div>
                    <div class="p-8 bg-white/50 backdrop-blur-xl rounded-2xl shadow-lg card-hover animate-feature-card" style="animation-delay: 0.2s;">
                         <div class="inline-flex items-center justify-center h-12 w-12 rounded-full bg-green-100 text-green-600 transition-transform duration-300">
                             <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                         </div>
                        <h3 class="mt-6 text-xl font-bold text-gray-900">Seamless Previews</h3>
                        <p class="mt-2 text-gray-600">Instantly preview PDFs, documents, and images directly in the app. No more endless downloading and searching.</p>
                    </div>
                    <div class="p-8 bg-white/50 backdrop-blur-xl rounded-2xl shadow-lg card-hover animate-feature-card" style="animation-delay: 0.3s;">
                        <div class="inline-flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 text-yellow-600 transition-transform duration-300">
                           <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                        <h3 class="mt-6 text-xl font-bold text-gray-900">Integrated Calendar</h3>
                        <p class="mt-2 text-gray-600">Keep track of homework, deadlines, and exam dates with a personal and global calendar system.</p>
                    </div>
                </div>
            </div>
        </main>
        <footer class="mt-24 text-center text-gray-500 text-sm">
             <p>© <span id="landing-copyright-year"></span> GCSEMate. All Rights Reserved. | <a href="#" class="hover:underline" onclick="event.preventDefault(); showPrivacyPolicyModal()">Privacy Policy</a> | <a href="#" class="hover:underline" onclick="event.preventDefault(); showTermsOfServiceModal()">Terms of Service</a></p>
             <p class="mt-1 text-xs text-gray-400">This site is protected by reCAPTCHA and the Google <a href="https://policies.google.com/privacy" target="_blank" rel="noopener" class="underline">Privacy Policy</a> and <a href="https://policies.google.com/terms" target="_blank" rel="noopener" class="underline">Terms of Service</a> apply.</p>
        </footer>
    </div>
    
    <div id="email-verify-page" class="hidden w-full max-w-md fade-in text-center">
        <div class="bg-white/70 backdrop-blur-xl rounded-2xl shadow-xl p-8 border border-white/30">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-green-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Verify Your Email</h2>
            <p id="verification-email-display" class="text-gray-600 mb-6">We've sent a verification link to your email address. Please check your spam/junk folder and inbox and click the link to activate your account.</p>
            <div class="flex flex-col gap-3">
                <button onclick="resendVerificationEmail()" id="resend-verification-btn" class="w-full px-6 py-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors">Resend Verification Email</button>
                <button onclick="handleLogout()" class="w-full px-6 py-3 rounded-lg bg-gray-200 text-gray-800 font-bold hover:bg-gray-300 transition-colors">Back to Login</button>
            </div>
             <p id="resend-message" class="text-sm text-green-600 mt-4 h-4"></p>
        </div>
    </div>
    <div id="login-page" class="hidden w-full max-w-sm fade-in">
        <div class="bg-white/70 backdrop-blur-xl rounded-2xl shadow-xl p-8 border border-white/30">
            <div class="flex justify-center items-center mb-4">
                <img src="gcsemate%20new.png" alt="GCSEMate Logo" class="w-40 drop-shadow-[0_6px_14px_rgba(37,99,235,0.25)]" data-tooltip="Welcome to GCSEMate" onerror="if(!this.dataset.fallback){this.dataset.fallback='imghippo'; this.src='https://i.imghippo.com/files/IxF8202tcg.jpg';} else { this.onerror=null; this.src='https://placehold.co/160x40/3B82F6/FFFFFF?text=GCSEMate'; }">
            </div>
            <h2 id="form-title" class="text-center text-gray-700 mb-6 text-xl">Your Ultimate Revision Hub</h2>
            <form id="login-form" class="space-y-4" onsubmit="event.preventDefault(); handleLogin();">
                <!-- reCAPTCHA v3 runs invisibly; no widget needed -->
                <div id="recaptcha-container" class="hidden"></div>
                <div>
                    <label for="email" class="sr-only">Email address</label>
                    <input id="email" type="email" placeholder="Email" autocomplete="email" required class="w-full p-3 rounded-lg border border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all" data-tooltip="Enter your email" aria-describedby="email-error">
                    <div id="email-error" class="text-red-600 text-sm mt-1 h-4" role="alert" aria-live="polite"></div>
                </div>
                <div class="relative">
                    <label for="password" class="sr-only">Password</label>
                    <input id="password" type="password" placeholder="Password" autocomplete="current-password" required class="w-full p-3 rounded-lg border border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all" data-tooltip="Enter your password" aria-describedby="password-error">
                    <button type="button" id="show-password-btn" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-400 rounded-l-none" data-tooltip="Show/Hide password" aria-label="Toggle password visibility">
                        <svg id="eye-open" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        <svg id="eye-closed" class="h-5 w-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .946-3.11 3.586-5.416 6.66-6.325M16.5 5.5c2.25 1.06 4.103 2.9 5.042 5.5-1.274 4.057-5.064 7-9.542 7a10.02 10.02 0 01-2.09-.25M9 12a3 3 0 116 0 3 3 0 01-6 0z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18"></path></svg>
                    </button>
                    <div id="password-error" class="text-red-600 text-sm mt-1 h-4" role="alert" aria-live="polite"></div>
                </div>
                <div class="flex justify-between items-center text-sm">
                    <label class="flex items-center text-gray-600 select-none">
                        <input id="remember-me" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-tooltip="Keep me logged in">
                        <span class="ml-2">Remember Me</span>
                    </label>
                    <a href="#" onclick="event.preventDefault(); showPasswordResetModal()" class="font-semibold text-blue-600 hover:underline">Forgot Password?</a>
                </div>
                <button type="submit" id="login-button" class="w-full p-4 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition-all transform hover:scale-105 text-lg" data-tooltip="Click to log in">Login</button>
                <p id="auth-error" class="text-red-500 text-sm text-center h-4"></p>
                <p class="text-center text-sm text-gray-600">Don't have an account? <a href="#" id="show-register-form" class="font-semibold text-blue-600 hover:underline">Register</a></p>
            </form>
            <form id="register-form" class="hidden space-y-4" onsubmit="event.preventDefault(); handleRegister();">
                <div>
                    <label for="register-displayname" class="sr-only">Full Name</label>
                    <input id="register-displayname" type="text" placeholder="Your Name" required class="w-full p-3 rounded-lg border border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all" data-tooltip="Enter your full name" aria-describedby="register-name-error">
                    <div id="register-name-error" class="text-red-600 text-sm mt-1 h-4" role="alert" aria-live="polite"></div>
                </div>
                <div>
                    <label for="register-email" class="sr-only">Email address</label>
                    <input id="register-email" type="email" placeholder="Email" autocomplete="email" required class="w-full p-3 rounded-lg border border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all" data-tooltip="Choose an email" aria-describedby="register-email-error">
                    <div id="register-email-error" class="text-red-600 text-sm mt-1 h-4" role="alert" aria-live="polite"></div>
                </div>
                <div>
                    <label for="register-password" class="sr-only">Password</label>
                    <input id="register-password" type="password" placeholder="Password (min. 6 characters)" autocomplete="new-password" required class="w-full p-3 rounded-lg border border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all" data-tooltip="Choose a password" aria-describedby="register-password-error">
                    <div id="register-password-error" class="text-red-600 text-sm mt-1 h-4" role="alert" aria-live="polite"></div>
                </div>
                <p class="text-xs text-gray-500 text-center">By creating an account, you agree to our <a href="#" onclick="event.preventDefault(); showTermsOfServiceModal()" class="font-semibold text-blue-600 hover:underline">Terms of Service</a> and <a href="#" onclick="event.preventDefault(); showPrivacyPolicyModal()" class="font-semibold text-blue-600 hover:underline">Privacy Policy</a>.</p>
                <button type="submit" id="register-button" class="w-full p-4 rounded-lg bg-green-600 text-white font-bold hover:bg-green-700 transition-all transform hover:scale-105 text-lg" data-tooltip="Click to create your account">Create Free Account</button>
                <p id="register-error" class="text-red-500 text-sm text-center h-4"></p>
                <p class="text-center text-sm text-gray-600">Already have an account? <a href="#" id="show-login-form" class="font-semibold text-blue-600 hover:underline">Login</a></p>
            </form>
        </div>
    </div>
    <div id="main-app" class="hidden w-full h-screen bg-white/70 backdrop-blur-xl flex flex-col border border-white/30 rounded-xl shadow-2xl overflow-hidden">
        <div id="event-countdown-banner" class="hidden"></div>
        <div id="site-announcement-banner" class="hidden"></div>
        
        <header class="bg-white/50 backdrop-blur-lg p-4 border-b border-gray-200/50 text-gray-800 flex items-center flex-wrap lg:flex-nowrap gap-3 flex-shrink-0 relative">
            <div class="flex-shrink-0">
                <img src="gcsemate%20new.png" alt="GCSEMate Logo" class="h-10 w-auto drop-shadow-[0_4px_10px_rgba(37,99,235,0.25)]" loading="lazy" decoding="async" onerror="if(!this.dataset.fallback){this.dataset.fallback='imghippo'; this.src='https://i.imghippo.com/files/IxF8202tcg.jpg';} else { this.onerror=null; this.src='https://placehold.co/160x40/3B82F6/FFFFFF?text=GCSEMate'; }">
            </div>
            <nav class="hidden lg:flex flex-1 justify-center items-center flex-wrap gap-x-4 xl:gap-x-6 2xl:gap-x-8 gap-y-2 text-sm font-semibold px-4 min-w-0 overflow-x-auto whitespace-nowrap no-scrollbar">
                <a href="#" class="nav-link py-2 hover:text-blue-600 transition-colors flex-shrink-0" data-page="subject-dashboard-page" data-tooltip="View your subjects">Subjects</a>
                <a href="#" class="nav-link py-2 hover:text-blue-600 transition-colors flex-shrink-0" data-page="videos-page" data-tooltip="View Videos">Videos</a>
                 <a href="#" class="nav-link py-2 hover:text-blue-600 transition-colors flex-shrink-0" data-page="gcsemategpt-page" data-tooltip="Try our AI tutor">GCSEMateGPT</a>
                <a href="#" class="nav-link py-2 hover:text-blue-600 transition-colors flex-shrink-0" data-page="blog-page" data-tooltip="View Blog">Blog</a>
                <a href="#" class="nav-link py-2 hover:text-blue-600 transition-colors flex-shrink-0" data-page="calendar-page" data-tooltip="View Calendar">Calendar</a>
                <a href="#" id="useful-links-nav" class="nav-link py-2 hover:text-blue-600 transition-colors flex-shrink-0" data-page="useful-links-page" data-tooltip="Useful Links">Useful Links</a>
                <a href="#" class="nav-link py-2 hover:text-blue-600 transition-colors flex-shrink-0" data-page="about-page" data-tooltip="Learn about us">About Us</a>
                <a href="#" class="nav-link py-2 hover:text-blue-600 transition-colors flex-shrink-0" data-page="features-page" data-tooltip="See our features and pricing">Features & Pricing</a>
                <a href="#" class="nav-link py-2 hover:text-blue-600 transition-colors flex-shrink-0" data-page="help-page" data-tooltip="Get help and see FAQs">Help/FAQ</a>
            </nav>
            <div class="hidden lg:flex items-center min-w-0 flex-shrink-0 gap-3">
                <span id="welcome-message" class="text-xs xl:text-sm mr-3 font-semibold text-gray-700 truncate max-w-[14ch] xl:max-w-[24ch]"></span>
                <img id="profile-picture" src="" alt="PFP" class="w-8 h-8 rounded-full border-2 border-white shadow-sm mr-4 flex-shrink-0">
                <a href="#" class="nav-link text-sm font-semibold py-2 hover:text-blue-600 transition-colors flex-shrink-0" data-page="account-settings-page" data-tooltip="Manage your account">Account</a>
                <button id="logout-button" class="ml-4 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg shadow-sm transition-colors flex-shrink-0" data-tooltip="End your session">Logout</button>
            </div>
            <div class="lg:hidden flex items-center ml-auto">
                <button id="hamburger-button" class="p-3 rounded-lg text-gray-700 hover:text-gray-900 hover:bg-gray-100 transition-colors border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" aria-label="Open navigation menu" aria-expanded="false" aria-controls="mobile-menu">
                    <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-16 6h16"></path>
                    </svg>
                </button>
            </div>
        </header>
        <div id="mobile-menu" class="hidden lg:hidden fixed inset-0 bg-white z-50 overflow-y-auto overscroll-contain" role="dialog" aria-modal="true" aria-labelledby="mobile-menu-title">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 bg-white sticky top-0">
                <img src="gcsemate%20new.png" alt="GCSEMate Logo" class="h-10 w-auto drop-shadow-[0_4px_10px_rgba(37,99,235,0.25)]" loading="lazy" decoding="async" onerror="if(!this.dataset.fallback){this.dataset.fallback='imghippo'; this.src='https://i.imghippo.com/files/IxF8202tcg.jpg';} else { this.onerror=null; this.src='https://placehold.co/160x40/3B82F6/FFFFFF?text=GCSEMate'; }">
                <button id="close-menu-button" class="p-3 rounded-lg text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" aria-label="Close navigation menu">
                    <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <nav class="flex flex-col p-6 space-y-3" role="navigation" aria-label="Main navigation">
                <a href="#" class="nav-link w-full text-left px-4 py-4 text-lg font-semibold text-gray-800 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors min-h-[56px] flex items-center focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" data-page="subject-dashboard-page" tabindex="0">📚 Subjects</a>
                <a href="#" class="nav-link w-full text-left px-4 py-4 text-lg font-semibold text-gray-800 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors min-h-[56px] flex items-center focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" data-page="videos-page" tabindex="0">🎥 Videos</a>
                <a href="#" class="nav-link w-full text-left px-4 py-4 text-lg font-semibold text-gray-800 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors min-h-[56px] flex items-center focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" data-page="gcsemategpt-page" tabindex="0">🤖 GCSEMateGPT</a>
                <a href="#" class="nav-link w-full text-left px-4 py-4 text-lg font-semibold text-gray-800 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors min-h-[56px] flex items-center focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" data-page="blog-page" tabindex="0">📝 Blog</a>
                <a href="#" class="nav-link w-full text-left px-4 py-4 text-lg font-semibold text-gray-800 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors min-h-[56px] flex items-center focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" data-page="calendar-page" tabindex="0">📅 Calendar</a>
                <a href="#" class="nav-link w-full text-left px-4 py-4 text-lg font-semibold text-gray-800 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors min-h-[56px] flex items-center focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" data-page="useful-links-page" tabindex="0">🔗 Useful Links</a>
                <a href="#" class="nav-link w-full text-left px-4 py-4 text-lg font-semibold text-gray-800 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors min-h-[56px] flex items-center focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" data-page="about-page" tabindex="0">ℹ️ About Us</a>
                <a href="#" class="nav-link w-full text-left px-4 py-4 text-lg font-semibold text-gray-800 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors min-h-[56px] flex items-center focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" data-page="features-page" tabindex="0">⭐ Features & Pricing</a>
                <a href="#" class="nav-link w-full text-left px-4 py-4 text-lg font-semibold text-gray-800 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors min-h-[56px] flex items-center focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" data-page="help-page" tabindex="0">❓ Help/FAQ</a>
            </nav>
            <div class="flex flex-col p-6 border-t border-gray-200 space-y-4 bg-gray-50">
                <a href="#" class="nav-link w-full text-left px-4 py-4 text-lg font-semibold text-gray-800 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-colors min-h-[56px] flex items-center focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2" data-page="account-settings-page" tabindex="0">⚙️ Account</a>
                <button id="mobile-logout-button" class="w-full px-4 py-4 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition-colors text-lg min-h-[56px] flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2" tabindex="0">🚪 Logout</button>
            </div>
        </div>
        <main id="page-content" class="flex-grow overflow-y-auto bg-transparent">
            <button id="scroll-top" class="hidden fixed bottom-6 right-6 z-[1000] p-3 rounded-full shadow-lg bg-blue-600 text-white hover:bg-blue-700 transition-all" aria-label="Scroll to top">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8l-6 6h12z"/></svg>
            </button>
            <div id="page-container" class="relative">
                <div id="subject-dashboard-page" class="page p-8 max-w-7xl mx-auto">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                        <h2 class="text-3xl font-bold text-gray-800">Your Subjects</h2>
                        <div id="dashboard-clock" class="bg-white/50 backdrop-blur-lg p-3 rounded-xl shadow-md border border-white/30 text-center">
                            <p id="clock-time" class="text-2xl font-bold text-gray-800 tracking-wider"></p>
                            <p id="clock-date" class="text-xs text-gray-500 font-semibold uppercase tracking-widest"></p>
                        </div>
                    </div>
                    <div id="subject-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6"></div>
                </div>
                <div id="gcsemategpt-page" class="page hidden p-8 max-w-5xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">GCSEMateGPT</h2>
                    <p class="text-gray-600 mb-6">A premium, GPT‑5 compatible ChatGPT bot tailored for GCSE success — live exam dates, exam board specs, past papers, model answers, flashcards, and focussed study plans across AQA, Edexcel, OCR and WJEC/Eduqas.</p>
                    <div class="bg-white/60 border border-white/30 backdrop-blur-lg rounded-2xl shadow-xl p-6">
                        <div class="flex flex-col items-center text-center gap-4">
                            <span class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" class="h-9 w-9" aria-hidden="true">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z"/>
                                </svg>
                            </span>
                            <h3 class="text-2xl font-bold text-gray-800">Open GCSEMateGPT in a new tab</h3>
                            <p class="text-gray-600 max-w-2xl">For security and privacy reasons, ChatGPT restricts embedding. We’ll open our official bot in a new tab. If it doesn’t open automatically, use the button below.</p>
                            <a href="https://chatgpt.com/g/g-689dd7ee68b481919d8674165481d252-gcsemate-gcse-ai-tutor" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center px-6 py-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400" aria-label="Open GCSEMateGPT in a new tab" tabindex="0" onclick="try{window.open('https://chatgpt.com/g/g-689c8023169c81919c80f2a7ccf685a4-gcsemate-gcse-ai-tutor','_blank','noopener,noreferrer');}catch(_){}">Open GCSEMateGPT</a>
                            <p class="text-xs text-gray-500">Exclusive access via GCSEMate. Best with the latest ChatGPT features.</p>
                        </div>
                    </div>
                </div>
                <div id="videos-page" class="page hidden p-8 max-w-7xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Revision Video Playlists</h2>
                     <div id="add-playlist-form-container" class="hidden bg-white/50 p-6 rounded-xl shadow-md border border-white/30 mb-8">
                         <h3 class="text-xl font-semibold mb-4">Add New YouTube Playlist</h3>
                         <form id="add-playlist-form" class="space-y-4" onsubmit="event.preventDefault(); handleAddPlaylist();">
                             <input id="playlist-title" type="text" placeholder="Playlist Title (e.g., 'AQA Physics Paper 1')" required class="w-full p-3 rounded-lg border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500" data-tooltip="Enter a descriptive title for the playlist">
                             <input id="playlist-url" type="url" placeholder="YouTube Playlist URL" required class="w-full p-3 rounded-lg border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500" data-tooltip="Enter the full YouTube playlist URL">
                             <label class="flex items-center text-sm text-gray-700 select-none">
                                 <input id="playlist-sync-confirm" type="checkbox" required class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                 <span class="ml-2">I confirm this playlist is for all paid users.</span>
                             </label>
                             <button type="submit" class="p-3 w-full rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors" data-tooltip="Save the new playlist">Add Playlist</button>
                         </form>
                         <p id="add-playlist-message" class="text-sm mt-2 h-4"></p>
                     </div>
                    <div id="playlist-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        </div>
                </div>
                <div id="blog-page" class="page hidden p-8 max-w-7xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">The GCSEMate Blog</h2>
                    <div id="add-blog-post-form-container" class="hidden bg-white/50 p-6 rounded-xl shadow-md border border-white/30 mb-8">
                        <h3 id="blog-form-title" class="text-xl font-semibold mb-4">Create New Blog Post</h3>
                        <form id="add-blog-post-form" class="space-y-4" onsubmit="event.preventDefault(); handleSaveBlogPost();">
                            <input type="hidden" id="blog-post-id">
                            <input id="blog-post-title" type="text" placeholder="Post Title" required class="w-full p-3 rounded-lg border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input id="blog-post-image" type="url" placeholder="Optional: Image URL" class="w-full p-3 rounded-lg border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <textarea id="blog-post-content" placeholder="Write your blog content here... Supports basic HTML." required class="w-full p-3 rounded-lg border-gray-300/50 bg-white/50 h-64 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            <div class="flex justify-end gap-3">
                                <button type="button" onclick="resetBlogPostForm()" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Save Post</button>
                            </div>
                        </form>
                        <p id="add-blog-post-message" class="text-sm mt-2 h-4"></p>
                    </div>
                    <div id="blog-post-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        </div>
                </div>
                <div id="calendar-page" class="page hidden p-8 max-w-7xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Calendar</h2>
                        <div class="flex items-center space-x-2">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors" data-tooltip="Previous Month"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                            <h3 id="month-year-header" class="text-xl font-semibold text-gray-700 w-40 text-center"></h3>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors" data-tooltip="Next Month"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                            <select id="calendar-year-select" class="ml-2 rounded-lg border-gray-300/60 bg-white/70 px-2 py-1 text-sm"></select>
                        </div>
                    </div>
                    <div class="bg-white/50 p-4 rounded-xl shadow-md border border-white/30">
                        <div id="calendar-grid" class="grid grid-cols-7 gap-px"></div>
                    </div>
                </div>
                <div id="useful-links-page" class="page hidden p-8 max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Useful Links</h2>
                    <div id="add-link-form-container" class="hidden bg-white/50 p-6 rounded-xl shadow-md border border-white/30 mb-8">
                        <h3 class="text-xl font-semibold mb-4">Add a New Link or Video</h3>
                        <div class="space-y-4">
                            <input id="link-title" type="text" placeholder="Title (e.g., 'BBC Bitesize Physics')" class="w-full p-3 rounded-lg border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500" data-tooltip="Enter the title for the link">
                            <input id="link-url" type="url" placeholder="URL (Standard link or YouTube video/playlist)" class="w-full p-3 rounded-lg border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500" data-tooltip="Enter the full URL">
                            <button id="add-link-btn" class="p-3 w-full rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors" data-tooltip="Save the new link">Add Link</button>
                        </div>
                        <p id="add-link-message" class="text-sm mt-2 h-4"></p>
                    </div>
                    <div class="bg-white/50 p-6 rounded-xl shadow-md border border-white/30">
                        <h3 class="text-xl font-semibold mb-4">Saved Links & Resources</h3>
                        <div id="links-container" class="space-y-4"></div>
                    </div>
                </div>
                <div id="file-browser-page" class="page hidden h-full flex flex-col">
                    <div id="breadcrumb" class="p-3 border-b border-gray-200/50 text-sm flex-shrink-0 text-gray-800 bg-gray-100/30"></div>
                    <div id="file-browser-controls" class="p-3 border-b border-gray-200/50 flex-shrink-0 bg-gray-50/20 flex flex-col sm:flex-row items-center gap-3">
                        <div class="relative flex-grow w-full sm:w-auto">
                            <input type="search" id="file-search-input" placeholder="Search in folder..." class="pl-10 pr-4 py-3 w-full rounded-lg border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 text-base">
                            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                        <div class="flex items-center gap-3 w-full sm:w-auto">
                             <select id="file-sort-select" class="rounded-lg border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 py-3 px-3 text-base">
                                <option value="az">Sort A-Z</option>
                                <option value="za">Sort Z-A</option>
                            </select>
                            <div id="view-toggle" class="flex items-center rounded-lg border border-gray-300/50 bg-white/50 p-1">
                                <button class="view-btn p-2 rounded-md hover:bg-gray-100 transition-colors" data-view="list" data-tooltip="List View">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                                </button>
                                <button class="view-btn p-2 rounded-md hover:bg-gray-100 transition-colors" data-view="grid" data-tooltip="Grid View">
                                     <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="file-list" class="p-4 overflow-y-auto flex-grow" aria-live="polite" aria-busy="false"></div>
                </div>
                <div id="account-settings-page" class="page hidden p-8 max-w-7xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Account Management</h2>
                    <div id="admin-panel" class="hidden space-y-10">
                        <div class="bg-white/50 p-8 rounded-xl shadow-lg border border-white/30">
                            <h3 class="text-2xl font-bold mb-6 text-gray-800">User Accounts</h3>
                            <div id="user-management-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-1 gap-10">
                            <div class="bg-white/50 p-8 rounded-xl shadow-lg border border-white/30">
                                <h3 class="text-2xl font-bold mb-6 text-gray-800">Site-Wide Announcement</h3>
                                <textarea id="announcement-text" placeholder="Enter announcement text here..." class="w-full p-3 rounded-lg border border-gray-300/50 bg-white/50 h-40"></textarea>
                                <div class="flex space-x-2 mt-4">
                                    <button id="post-announcement-btn" class="flex-grow p-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700">Post Banner</button>
                                    <button id="clear-announcement-btn" class="flex-grow p-3 rounded-lg bg-gray-600 text-white font-bold hover:bg-gray-700">Clear Banner</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="user-settings-panel" class="hidden bg-white/50 p-8 rounded-xl shadow-lg border border-white/30 max-w-lg mx-auto">
                        <h3 class="text-2xl font-bold mb-6 text-gray-800">Your Account</h3>
                        <form id="user-details-form" class="space-y-4" onsubmit="event.preventDefault(); handleUpdateUserSettings();">
                            <div>
                                <label for="user-displayname" class="block text-sm font-medium text-gray-700">Display Name</label>
                                <input id="user-displayname" type="text" required class="mt-1 w-full p-3 rounded-lg border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            </div>
                             <div>
                                <label for="user-email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input id="user-email" type="email" required disabled class="mt-1 w-full p-3 rounded-lg border-gray-300/50 bg-gray-200/50 text-gray-500 cursor-not-allowed">
                            </div>
                             <div>
                                <label for="user-password" class="block text-sm font-medium text-gray-700">New Password (optional)</label>
                                <input id="user-password" type="password" placeholder="Leave blank to keep current password" class="mt-1 w-full p-3 rounded-lg border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            </div>
                            <button type="submit" class="w-full p-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors">Save Changes</button>
                            <p id="user-settings-message" class="text-sm text-center h-4"></p>
                        </form>
                        <div class="mt-8 pt-6 border-t border-gray-200 space-y-3">
                            <h4 class="text-lg font-semibold text-gray-800">Appearance</h4>
                            <div class="flex items-center gap-3">
                                <label for="accent-picker" class="text-sm text-gray-700">Accent colour</label>
                                <input id="accent-picker" type="color" aria-label="Accent color" class="w-9 h-9 rounded cursor-pointer border border-gray-300/70 bg-white" />
                                <button id="reset-accent" class="px-3 py-1.5 rounded-md bg-gray-200 text-gray-800 text-xs font-semibold hover:bg-gray-300" aria-label="Reset accent colour">Reset</button>
                            </div>
                        </div>
                        <div class="mt-8 pt-6 border-t border-gray-200 space-y-4">
                              <div>
                                <h4 class="text-lg font-semibold text-gray-800">Account Actions</h4>
                                <p class="text-sm text-gray-500 mt-1">Manage your account security and data.</p>
                            </div>
                            <button onclick="showPasswordResetModal(currentUser.email)" class="w-full p-3 rounded-lg bg-yellow-500 text-white font-bold hover:bg-yellow-600 transition-colors">Reset Password</button>
                             <div class="mt-6 pt-6 border-t border-red-200">
                                <h4 class="text-lg font-semibold text-red-700">Danger Zone</h4>
                                <p class="text-sm text-red-500 mt-1">This action is permanent and cannot be undone.</p>
                                <button onclick="showDeleteAccountModal()" class="mt-4 w-full p-3 rounded-lg bg-red-600 text-white font-bold hover:bg-red-700 transition-colors">Delete My Account</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="about-page" class="page hidden p-8 max-w-4xl mx-auto text-gray-800">
                    <div class="prose prose-lg max-w-none">
                        <h2 class="text-4xl font-extrabold text-gray-900 mb-4 text-center">The GCSEMate Story</h2>
                        <p class="text-center text-xl text-gray-600">From a student's frustration to a nationwide tool.</p>
                        <figure class="my-8">
                            <img src="https://images.unsplash.com/photo-1524178232363-1fb2b075b655?q=80&w=2070&auto=format&fit=crop" alt="A group of students studying together in a library." class="rounded-xl shadow-lg w-full h-auto">
                            <figcaption class="text-center text-gray-500 mt-2">Built by a student, for students.</figcaption>
                        </figure>
                        <h3>The Spark of an Idea</h3>
                        <p>GCSEMate wasn't born in a boardroom; it was conceived during late-night revision sessions. As a Year 10 student, our founder found himself drowning in a sea of digital chaos. Revision notes were in one app, past papers downloaded into another folder, useful websites were lost in a long list of bookmarks, and collaborating with friends meant endless email chains. He knew there had to be a better way. Armed with a passion for coding and a clear problem to solve, he began building the first version of GCSEMate.</p>
                        
                        <h3>Our Mission: Simplify to Succeed</h3>
                        <p>This journey started with a simple idea: to empower fellow students to cut through the revision clutter and achieve their full potential. We believe that your focus should be on learning, not on fighting with disorganized files. GCSEMate eliminates the friction of traditional study methods by providing a single, intelligent source of truth for all subjects, curated and organized for maximum impact. Every feature is built with the student experience at its core, ensuring GCSEMate is a tool that genuinely helps, not hinders, your path to success.</p>
                        
                        <h3>Built by Students, For Students</h3>
                        <p>What makes GCSEMate different isn't just the technology—it's the understanding. Our team consists of current and recent GCSE students who have lived through the stress, the late nights, and the overwhelming feeling of not knowing where to start. We've felt the frustration of finding the perfect revision guide only to lose it in a folder maze, or discovering an amazing YouTube explanation but forgetting to bookmark it. This isn't theoretical for us; it's personal.</p>
                        
                        <h3>The Technology Behind the Magic</h3>
                        <p>Behind the clean interface lies a carefully crafted system designed for speed, reliability, and accessibility. We've integrated with Google Drive's powerful API to provide seamless file access, built intelligent search functionality to help you find exactly what you need, and implemented progressive web app technology so GCSEMate works perfectly on any device. Our AI tutor, GCSEMateGPT, is specifically trained on GCSE curricula to provide targeted, exam-focused assistance.</p>
                        
                        <h3>Privacy and Security First</h3>
                        <p>We understand that your study materials and personal information are precious. That's why GCSEMate is built with privacy by design. We use industry-standard encryption, minimal data collection practices, and transparent policies. You own your data, and we're simply here to help you organize and access it more effectively. Our authentication system is secure, our servers are protected, and your trust is our top priority.</p>
                        
                        <h3>Looking Forward</h3>
                        <p>This is just the beginning. We're constantly listening to feedback from our community of users, implementing new features, and refining existing ones. From interactive revision tools to collaborative study spaces, from AI-powered study plans to comprehensive progress tracking—we're building the future of digital education, one feature at a time. Join us on this journey to make GCSE success accessible to everyone.</p>
                    </div>
                </div>
                <div id="features-page" class="page hidden p-8 max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Features & Pricing</h2>
                    <div class="mb-6 p-4 rounded-xl bg-white/70 border border-white/40">
                        <p class="text-gray-700 leading-relaxed">
                            GCSEMate is built to open education for everyone — regardless of monetary status. Most features are free, and our <span class="font-semibold text-blue-700">Pro</span> plan costs less than a cookie: it sustains hosting and keeps the lights on. If you can’t afford it, reach out — education shouldn’t hide behind a paywall. Also, we added a joke jar in the codebase; every time you laugh, it auto-increments. Totally scientific.
                        </p>
                    </div>
                    <div class="grid md:grid-cols-3 gap-8 text-center">
                        <div class="bg-white/50 p-6 rounded-xl shadow-md border border-white/30 backdrop-blur-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-blue-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg><h3 class="text-xl font-semibold">Centralized Subject Hubs</h3><p class="mt-2 text-gray-600">Access all your notes, past papers, and resources for every subject, neatly organized in one place.</p></div>
                        <div class="bg-white/50 p-6 rounded-xl shadow-md border border-white/30 backdrop-blur-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-yellow-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg><h3 class="text-xl font-semibold">File Starring & Download</h3><p class="mt-2 text-gray-600">Pin your most important files to the top of any folder and download them with a single click.</p></div>
                        <div class="bg-white/50 p-6 rounded-xl shadow-md border border-white/30 backdrop-blur-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-green-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg><h3 class="text-xl font-semibold">Seamless Previews</h3><p class="mt-2 text-gray-600">Preview documents, images, and PDFs directly within the app without needing to download them first.</p></div>
                    </div>
                    <div class="mt-12 bg-white/70 border border-white/30 rounded-2xl shadow-xl overflow-hidden">
                        <div class="p-6 border-b border-gray-200/60 text-center">
                            <h3 class="text-2xl font-bold text-gray-800">Free vs Pro</h3>
                            <p class="text-gray-600">Choose the plan that supports your goals. Upgrade any time.</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm" id="pricing-compare">
                                <thead class="bg-gray-50/70">
                                    <tr>
                                        <th class="px-4 py-3">Feature</th>
                                        <th class="px-4 py-3">Free</th>
                                        <th class="px-4 py-3">Pro</th>
                                    </tr>
                                </thead>
                                <tbody id="pricing-compare-body" class="divide-y divide-gray-100">
                                    <tr class="opacity-0 translate-y-2 transition-all duration-500">
                                        <td class="px-4 py-3 font-medium text-gray-800">Subjects Dashboard</td>
                                        <td class="px-4 py-3">Limited</td>
                                        <td class="px-4 py-3 text-green-700 font-semibold">Unlimited</td>
                                    </tr>
                                     <tr class="opacity-0 translate-y-2 transition-all duration-500">
                                         <td class="px-4 py-3 font-medium text-gray-800">GCSEMateGPT (AI Tutor)</td>
                                         <td class="px-4 py-3 text-gray-500">External access</td>
                                         <td class="px-4 py-3 text-green-700 font-semibold">Integrated link + guidance</td>
                                      </tr>
                                    <tr class="opacity-0 translate-y-2 transition-all duration-500">
                                        <td class="px-4 py-3 font-medium text-gray-800">File Browser & Previews</td>
                                        <td class="px-4 py-3">Basic</td>
                                        <td class="px-4 py-3 text-green-700 font-semibold">Full access with Google Docs/Slides/Sheets preview</td>
                                    </tr>
                                    <tr class="opacity-0 translate-y-2 transition-all duration-500">
                                        <td class="px-4 py-3 font-medium text-gray-800">Videos & Playlists</td>
                                        <td class="px-4 py-3">Included</td>
                                        <td class="px-4 py-3 text-green-700 font-semibold">Included</td>
                                    </tr>
                                    <tr class="opacity-0 translate-y-2 transition-all duration-500">
                                        <td class="px-4 py-3 font-medium text-gray-800">Blog Comments</td>
                                        <td class="px-4 py-3 text-gray-500">Read-only</td>
                                        <td class="px-4 py-3 text-green-700 font-semibold">Post and engage</td>
                                    </tr>
                                    <tr class="opacity-0 translate-y-2 transition-all duration-500">
                                        <td class="px-4 py-3 font-medium text-gray-800">Calendar & Events</td>
                                        <td class="px-4 py-3">Personal events</td>
                                        <td class="px-4 py-3 text-green-700 font-semibold">Personal + Global events with countdowns</td>
                                    </tr>
                                     <tr class="opacity-0 translate-y-2 transition-all duration-500">
                                         <td class="px-4 py-3 font-medium text-gray-800">Accessibility</td>
                                         <td class="px-4 py-3">Semantic HTML, skip links, ARIA labels</td>
                                         <td class="px-4 py-3 text-green-700 font-semibold">Everything in Free + higher contrast presets and keyboard flows</td>
                                     </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="p-6 flex flex-col sm:flex-row items-center justify-between gap-4 bg-gradient-to-r from-blue-50/70 to-transparent">
                            <div class="text-gray-700 text-sm">Pro is just <span class="font-bold text-blue-700">£1/month</span>. Cancel anytime.</div>
                            <button class="px-6 py-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition-all transform hover:scale-105" onclick="showPage('checkout-page')">Upgrade to Pro</button>
                        </div>
                    </div>
                    <div class="text-center mt-12 p-8 bg-white/60 rounded-2xl shadow-xl border border-white/30 backdrop-blur-lg">
                        <h3 class="text-2xl font-bold">Get Full Access</h3><p class="text-5xl font-extrabold my-4 text-blue-600">£1<span class="text-xl font-medium text-gray-500">/month</span></p><p class="mb-6 text-gray-600">For less than the price of a coffee, unlock unlimited access to all features and ensure you have the best tools for your GCSE success.</p>
                        <button class="w-full max-w-xs p-4 rounded-lg bg-blue-600 text-white font-bold text-lg hover:bg-blue-700 transition-colors" data-tooltip="Subscribe to get full access" onclick="showPage('checkout-page')">Subscribe Now</button>
                    </div>
                </div>
                <div id="help-page" class="page hidden p-8 max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">Help & Frequently Asked Questions</h2>
                        <div class="bg-white/60 border border-white/30 backdrop-blur-lg rounded-xl p-4 mb-4">
                            <div class="flex flex-col gap-3">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">Keyboard shortcuts</h3>
                                    <ul class="mt-1 text-sm text-gray-700 grid sm:grid-cols-2 gap-1">
                                        <li><span class="font-semibold">?</span>: Open this Help/FAQ</li>
                                        <li><span class="font-semibold">/</span>: Focus file search</li>
                                        <li><span class="font-semibold">g</span> then <span class="font-semibold">d</span>: Go to Dashboard</li>
                                        <li><span class="font-semibold">g</span> then <span class="font-semibold">v</span>: Go to Videos</li>
                                        <li><span class="font-semibold">g</span> then <span class="font-semibold">b</span>: Go to Blog</li>
                                        <li><span class="font-semibold">g</span> then <span class="font-semibold">c</span>: Go to Calendar</li>
                                    <li><span class="font-semibold">g</span> then <span class="font-semibold">g</span>: Go to GCSEMateGPT</li>
                                        
                                        <li><span class="font-semibold">Esc</span>: Close modals/tooltips</li>
                                    </ul>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input id="faq-search" type="search" placeholder="Search FAQs..." class="flex-1 px-3 py-2 rounded-lg border border-gray-300/60 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400" aria-label="Search FAQs" />
                                    <span id="faq-results-count" class="text-xs text-gray-500"></span>
                                </div>
                            </div>
                        </div>
                        <div id="faq-container" class="space-y-4">
                        <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">How do I access my revision files?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>To access files, you need a 'Pro' account. Once upgraded, navigate to the 'Subjects' dashboard and click on any subject card. This will open the file browser for that subject, where you can navigate through folders, preview files, and download what you need.</p>
                            </div>
                        </div>
                        <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">How do I change the accent colour?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>Use the colour picker in the top-right of the header (desktop) to pick your accent colour. Your choice is saved on this device. Click Reset to return to the default blue.</p>
                            </div>
                        </div>
                        <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">Are there keyboard shortcuts?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>Yes! Press <strong>?</strong> anywhere to open this Help/FAQ and see the shortcuts. You can also press <strong>/</strong> to focus the file search, or press <strong>g</strong> followed by a letter to jump to a section (e.g. <strong>d</strong> for dashboard, <strong>v</strong> for videos).</p>
                            </div>
                        </div>
                        <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">Can I preview files without downloading?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>Yes. PDFs and images can be previewed directly in the app. Other file types may open in Google Drive viewer.</p>
                            </div>
                        </div>
                        <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">How do I report an issue or suggest a feature?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>Please email us via the link on the Upgrade page or use the contact option in the footer. We welcome feedback to improve GCSEMate.</p>
                            </div>
                        </div>
                        <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">What is the 'Star' icon for?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>Clicking the star icon next to a file pins it to the top of its current folder. This is a great way to mark important documents like exam papers or key notes for quick access. Starred items are always displayed first in both list and grid views.</p>
                            </div>
                        </div>
                         <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">How does the Calendar work?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>The calendar helps you track important dates. Click on any day to add a personal event, like homework deadlines or revision topics. You can also enable a 'Countdown Banner' for specific events. Admins may add 'Global Events', like exam dates, which appear for all users and are marked with a green dot.</p>
                            </div>
                        </div>
                         <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">Can I upload my own files?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>Currently, file uploading is not a feature for users. The file structure is managed by administrators to ensure all resources are relevant, high-quality, and well-organized for all students. This helps maintain a consistent and reliable revision library.</p>
                            </div>
                        </div>
                         <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">How do I delete my account?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>You can delete your account by going to the 'Account' page. At the bottom, in the 'Danger Zone', you will find a "Delete My Account" button. Please be aware that this action is irreversible and will permanently delete your user profile and any associated personal data, such as calendar events.</p>
                            </div>
                        </div>
                        <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">What file types can I preview?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>GCSEMate supports previewing PDFs, Word documents, Google Docs, Google Slides, Google Sheets, PowerPoint presentations, images (JPEG, PNG, GIF), and text files. If a file can't be previewed directly, you can always open it in Google Drive or download it.</p>
                            </div>
                        </div>
                        <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">Can I access GCSEMate offline?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>GCSEMate requires an internet connection to access files and sync data. However, you can download files locally for offline study. We're working on offline capabilities for basic features in future updates.</p>
                            </div>
                        </div>
                        <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">How accurate is GCSEMateGPT?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>GCSEMateGPT is trained specifically on GCSE curricula and past papers, making it highly accurate for GCSE-level questions. However, always cross-reference important information with official sources and your teachers. It's a powerful study aid, not a replacement for your textbooks.</p>
                            </div>
                        </div>
                        <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">Can I share files with classmates?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>Currently, file sharing happens through Google Drive's sharing features. Click "Open in Google Drive" on any file to access sharing options. We're developing native sharing features for future releases.</p>
                            </div>
                        </div>
                        <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">Is my data safe and private?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>Absolutely. We use industry-standard encryption, minimal data collection, and transparent privacy policies. Your study materials remain in your Google Drive, and we only access metadata necessary for organization. Read our full Privacy Policy for details.</p>
                            </div>
                        </div>
                        <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">Why choose GCSEMate over other study apps?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>GCSEMate is built specifically for UK GCSE students by fellow students who understand the unique challenges. We offer seamless file organization, integrated AI tutoring, affordable pricing (£1/month), and features designed around the actual GCSE curriculum and exam formats.</p>
                            </div>
                        </div>
                        <div class="faq-item bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg">
                            <div class="faq-question flex justify-between items-center p-5 cursor-pointer">
                                <h3 class="font-semibold text-lg text-gray-800">How do I get the most out of GCSEMate?</h3>
                                <svg class="faq-arrow w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div class="faq-answer px-5 pb-5 text-gray-600" style="max-height:0">
                                <p>Start by exploring each subject's file browser, star your most important documents, use the calendar for deadline tracking, engage with GCSEMateGPT for quick explanations, and take advantage of keyboard shortcuts for faster navigation. Regular use builds familiarity and efficiency.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="checkout-page" class="page hidden p-8 max-w-lg mx-auto text-center">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Upgrade to Pro</h2>
                    <div class="bg-white/50 p-8 rounded-xl shadow-md border border-white/30">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-blue-500 mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <p class="text-gray-700 mb-6">
                            To upgrade to the <strong>GCSEMate Pro</strong> plan for <strong>£1/month</strong>, please send an email to the address below to arrange payment.
                        </p>
                        <p class="text-lg font-bold text-blue-700 bg-blue-50/50 py-3 rounded-lg border border-blue-200/50 mb-8">
                            <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="8dece9e0e4e3cdeaeefee8e0ecf9e8a3eee2e0">[email&#160;protected]</a>
                        </p>
                        <button onclick="showPage('subject-dashboard-page')" class="inline-flex items-center justify-center px-8 py-4 rounded-lg bg-gray-600 text-white font-bold text-lg hover:bg-gray-700 transition-all" data-tooltip="Go back to dashboard">Return to Dashboard</button>
                    </div>
                </div>
            </div>
        </main>
        <footer id="page-footer" class="bg-gray-100/50 p-4 text-center text-sm text-gray-600 border-t border-gray-200/50 flex-shrink-0">
            <div id="footer-content" class="space-y-2">
                <p>Made with ❤️</p>
                <p>© <span id="copyright-year"></span> GCSEMate. All Rights Reserved. | <a href="#" class="hover:underline" onclick="event.preventDefault(); showPrivacyPolicyModal()">Privacy Policy</a> | <a href="#" class="hover:underline" onclick="event.preventDefault(); showTermsOfServiceModal()">Terms of Service</a> | <a href="#" class="hover:underline" onclick="event.preventDefault(); showDmcaModal()">DMCA Policy</a></p>
                <p class="text-xs text-gray-400">This site is protected by reCAPTCHA and the Google <a href="https://policies.google.com/privacy" target="_blank" rel="noopener" class="underline">Privacy Policy</a> and <a href="https://policies.google.com/terms" target="_blank" rel="noopener" class="underline">Terms of Service</a> apply.</p>
            </div>
        </footer>
    </div>
    
    <div id="toast-container"></div>
    <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden items-center justify-center p-4 z-[9998]"></div>
    <div id="playlist-viewer-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden items-center justify-center p-4 z-[9998]"></div>
    <div id="blog-viewer-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden items-center justify-center p-4 z-[9998]"></div>
    <div id="dmca-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden items-center justify-center p-4 z-[9998]"></div>
    <div id="legal-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden items-center justify-center p-4 z-[9998]"></div>
    <div id="edit-user-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden items-center justify-center p-4 z-[9998]"></div>
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden items-center justify-center p-4 z-[9998]"></div>
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden items-center justify-center p-4 z-[10000]"></div>
    <div id="upgrade-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm hidden items-center justify-center p-4 z-[9999]">
        <div class="bg-white/90 backdrop-blur-lg rounded-xl shadow-2xl p-8 max-w-md text-center fade-in"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-blue-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.293 2.293c.63.63 1.707.63 2.337 0l2.293-2.293M12 21l2.293-2.293c.63-.63 1.707-.63 2.337 0l2.293 2.293M3 12h18M12 3l2.293 2.293c.63.63.184 1.707-.707 1.707H10.414c-.891 0-1.337-1.077-.707-1.707L12 3z" /></svg><h2 class="text-2xl font-bold text-gray-800 mb-2">Upgrade to Pro</h2><p id="upgrade-modal-message" class="text-gray-600 mb-6">To access this feature, please upgrade to our Pro plan. Get unlimited access to all subjects and features for just £1/month.</p><div class="flex flex-col sm:flex-row gap-3 justify-center"><button onclick="document.getElementById('upgrade-modal').style.display='none'" class="w-full px-6 py-3 rounded-lg bg-gray-200 text-gray-800 font-bold hover:bg-gray-300 transition-colors">Maybe Later</button><button onclick="showPage('features-page'); document.getElementById('upgrade-modal').style.display='none';" class="w-full px-6 py-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors">Upgrade Now</button></div></div>
    </div>
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script>
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAGIgvwuqKr5vIPyimCx4CyKdhXlwc9gyo",
        authDomain: "gcsemate.firebaseapp.com",
        projectId: "gcsemate",
        storageBucket: "gcsemate.appspot.com",
        messagingSenderId: "704190559234",
        appId: "1:704190559234:web:dd6ecc107df886c70b231b",
        measurementId: "G-NSRF8YLS2N"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
    </script>
    <script>
        // --- APP STATE---
        let currentUser = null;
        let isGapiReady = false;
        let path = [{ name: 'Root', id: '1lxL66wl3EJw07yfzYM-ime_SqFV7s9dc' }];
        let currentFolderFiles = [];
        let fileBrowserView = 'list'; // 'list' or 'grid'
        let allSubjectFolders = {};
        let allBlogPosts = [];
        let currentDate = new Date();
        let activeCountdowns = [];
        let currentCountdownIndex = 0;
        let clockInterval = null;
        let unsubscribeUserManagement;
        let unsubscribeUsefulLinks;
        let unsubscribeVideoPlaylists;
        let unsubscribeBlogPosts;
        let unsubscribeUserEvents;
        let unsubscribeGlobalEvents;
        let unsubscribeAnnouncement;
        let unsubscribeBlogComments;
        let recaptchaVerifier;
        
        // Performance optimizations
        let animationFrameId = null;
        let debounceTimers = new Map();
        let throttleTimers = new Map();
        
        // Utility functions for performance
        const debounce = (func, wait) => {
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(debounceTimers.get(func));
                    func(...args);
                };
                clearTimeout(debounceTimers.get(func));
                debounceTimers.set(func, setTimeout(later, wait));
            };
        };
        
        const throttle = (func, limit) => {
            return function executedFunction(...args) {
                if (!throttleTimers.get(func)) {
                    func.apply(this, args);
                    throttleTimers.set(func, setTimeout(() => {
                        throttleTimers.delete(func);
                    }, limit));
                }
            };
        };
        // --- CONFIGURATION ---
        const ROOT_FOLDER_ID = '1lxL66wl3EJw07yfzYM-ime_SqFV7s9dc';
        const RECAPTCHA_SITE_KEY = '6LcU7aQrAAAAANXnNxEwnLlMI26R5AkUOdnDg7Wk'; // standard v3 site key
        const SUBJECTS = ['Biology', 'Chemistry', 'Computing', 'English', 'Geography', 'German', 'History', 'Maths', 'Music', 'Philosophy and Ethics', 'Physics'];
        const uniformSubjectIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>`;
        const subjectIconMap = {
            // Biology: tree icon
            biology: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-green-600" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-2.5 0-4.5 2-4.5 4.5 0 .5.1 1 .3 1.5C6 8.2 5 9.7 5 11.5 5 14 7 16 9.5 16H11v3H9a1 1 0 100 2h6a1 1 0 100-2h-2v-3h1.5C17 16 19 14 19 11.5c0-1.8-1-3.3-2.8-3.5.2-.5.3-1 .3-1.5C16.5 4 14.5 2 12 2z"/></svg>`,
            // Physics: thunderbolt
            physics: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-yellow-500" viewBox="0 0 24 24" fill="currentColor"><path d="M13 2L3 14h7l-1 8 11-14h-7l0-6z"/></svg>`,
            // Chemistry: conical flask
            chemistry: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-cyan-600" viewBox="0 0 24 24" fill="currentColor"><path d="M9 3h6v2l-1 1v4.6l4.8 7.2A3 3 0 0115.5 22h-7a3 3 0 01-3.3-4.2L10 10.6V6l-1-1V3z"/><path d="M8.5 14h7l1.6 2.4a1 1 0 01-.8 1.6h-8.6a1 1 0 01-.8-1.6L8.5 14z"/></svg>`,
            // Geography: globe
            geography: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-emerald-600" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1.5 3.1c2.6.4 4.8 2.4 5.4 5h-3.7c-.2-1.8-.8-3.3-1.7-5zM11 5.3c-1.2 1.9-2 3.9-2.2 5.8H5.1c.5-2.8 2.7-5.1 5.9-5.8zM5.1 13h3.7c.2 1.9 1 3.9 2.2 5.8-3.2-.7-5.4-3-5.9-5.8zm6.4 5.9c.9-1.7 1.4-3.3 1.6-5h3.8c-.6 2.6-2.8 4.7-5.4 5z"/></svg>`,
            // English: book lines
            english: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-gray-600" viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h16v2H4z"/><path d="M4 8h10v2H4z"/><path d="M4 12h16v2H4z"/><path d="M4 16h10v2H4z"/></svg>`,
            // Maths: pi symbol outline
            maths: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-indigo-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 8h16"/><path d="M8 8v8"/><path d="M16 8c0 5-2 8-5 8"/></svg>`,
            // History: outlined clock face with hands
            history: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-yellow-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 7v5l4 2"/></svg>`,
            // German: flag
            german: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3" viewBox="0 0 24 24"><rect width="24" height="8" y="0" fill="#000"/><rect width="24" height="8" y="8" fill="#DD0000"/><rect width="24" height="8" y="16" fill="#FFCE00"/></svg>`,
            // Music: outlined note with circles
            music: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-purple-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V6l10-2v10"/><circle cx="7" cy="18" r="3" stroke="currentColor"/><circle cx="19" cy="14" r="3" stroke="currentColor"/></svg>`,
            // Computing: monitor
            computing: `<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-3 text-blue-600" viewBox="0 0 24 24" fill="currentColor"><path d="M4 5h16v10H4z"/><path d="M2 17h20v2H2z"/></svg>`,
            // Philosophy and Ethics: balanced scales outline
            "philosophy and ethics": `<svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-10 w-10 mb-3 text-amber-600\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M12 3v3\"/><path d=\"M7 6h10\"/><path d=\"M6 10l-3 5a3 3 0 006 0l-3-5z\"/><path d=\"M18 10l-3 5a3 3 0 006 0l-3-5z\"/><path d=\"M12 9v9\"/><path d=\"M7 20h10\"/></svg>`
        };
        // =================================================================================
        // CORE INITIALIZATION & AUTHENTICATION
        // =================================================================================
        function ensureInitialView() {
            try {
                const landing = document.getElementById('landing-page');
                const app = document.getElementById('main-app');
                const login = document.getElementById('login-page');
                const verify = document.getElementById('email-verify-page');
                const isVisible = (el) => el && !el.classList.contains('hidden');
                const anyVisible = [app, login, verify, landing].some(isVisible);
                if (!anyVisible && landing) landing.classList.remove('hidden');
            } catch (_) {}
        }

        function hideAppLoading() {
            const overlay = document.getElementById('app-loading');
            if (!overlay) return;
            
            const logo = overlay.querySelector('.animate-logo');
            if (logo) { 
                logo.style.opacity = '1'; 
                logo.style.transform = 'translateY(0)'; 
            }
            
            ensureInitialView();
            
            // Smooth fade out with better timing
            overlay.style.opacity = '0';
            overlay.style.transition = 'opacity 300ms ease-out';
            
            setTimeout(() => { 
                overlay.style.display = 'none';
                // Ensure body scroll is restored
                document.body.style.overflow = '';
            }, 320);
        }
        
        function showAppLoading() {
            const overlay = document.getElementById('app-loading');
            if (!overlay) return;
            
            overlay.style.display = 'flex';
            overlay.style.opacity = '1';
            document.body.style.overflow = 'hidden';
        }

        // Fallback: ensure hide after window load
        // Early slide-in on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            // Use requestIdleCallback for better performance
            if ('requestIdleCallback' in window) {
                requestIdleCallback(() => {
                    const overlay = document.getElementById('app-loading');
                    const logo = overlay?.querySelector?.('.animate-logo');
                    if (logo) { 
                        requestAnimationFrame(() => { 
                            logo.style.opacity = '1'; 
                            logo.style.transform = 'translateY(0)'; 
                        }); 
                    }
                }, { timeout: 1000 });
            } else {
                setTimeout(() => {
                    const overlay = document.getElementById('app-loading');
                    const logo = overlay?.querySelector?.('.animate-logo');
                    if (logo) { 
                        requestAnimationFrame(() => { 
                            logo.style.opacity = '1'; 
                            logo.style.transform = 'translateY(0)'; 
                        }); 
                    }
                }, 0);
            }
        }, { once: true });

        window.addEventListener('load', () => {
            // Trigger logo slide-in immediately on load
            const overlay = document.getElementById('app-loading');
            const logo = overlay?.querySelector?.('.animate-logo');
            if (logo) { requestAnimationFrame(() => { logo.style.opacity = '1'; logo.style.transform = 'translateY(0)'; }); }
            // If auth callback hasn't resolved, ensure the landing view is shown and then hide
            setTimeout(() => { ensureInitialView(); hideAppLoading(); }, 1200);
        }, { once: true });

        auth.onAuthStateChanged(async (user) => {
            // Detach old listeners to prevent memory leaks on re-login
            if (unsubscribeUserManagement) unsubscribeUserManagement();
            if (unsubscribeUsefulLinks) unsubscribeUsefulLinks();
            if (unsubscribeVideoPlaylists) unsubscribeVideoPlaylists();
            if (unsubscribeBlogPosts) unsubscribeBlogPosts();
            if (unsubscribeUserEvents) unsubscribeUserEvents();
            if (unsubscribeGlobalEvents) unsubscribeGlobalEvents();
            if (unsubscribeAnnouncement) unsubscribeAnnouncement();
            if (clockInterval) clearInterval(clockInterval);
            if (user && user.emailVerified) {
                // User is signed in AND verified.
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        currentUser = {
                            uid: user.uid,
                            email: user.email,
                            emailVerified: user.emailVerified,
                            ...userDoc.data()
                        };
                        initializeAppState();
                        hideAppLoading();
                    } else {
                        console.error("User authenticated but no profile found in Firestore.");
                        await handleLogout();
                        hideAppLoading();
                    }
                } catch (error) {
                    console.error("Error fetching user profile:", error);
                    showErrorPage("Login Error", "Could not fetch your user profile. Please try again later.");
                    await handleLogout();
                    hideAppLoading();
                }
            } else if (user && !user.emailVerified) {
                // User is signed in but NOT verified.
                console.log("User is not verified.");
                showVerificationMessagePage(user.email);
                hideAppLoading();
            } else {
                // User is signed out.
                currentUser = null;
                const mainApp = document.getElementById('main-app');
                if (mainApp) {
                    mainApp.classList.add('hidden');
                    mainApp.style.display = 'none'; // ensure inline display doesn't override hidden
                }
                const loginPage = document.getElementById('login-page');
                const verifyPage = document.getElementById('email-verify-page');
                if (loginPage) loginPage.classList.add('hidden');
                if (verifyPage) verifyPage.classList.add('hidden');
                // Close any open modals and mobile menu
                ['mobile-menu','preview-modal','playlist-viewer-modal','blog-viewer-modal','dmca-modal','legal-modal','edit-user-modal','event-modal','confirmation-modal','upgrade-modal']
                    .forEach(id => { const el = document.getElementById(id); if (el) { el.style.display = 'none'; if (!el.classList.contains('hidden')) el.classList.add('hidden'); el.innerHTML = el.id.endsWith('-modal') ? '' : el.innerHTML; } });
                if (typeof unsubscribeBlogComments === 'function') { try { unsubscribeBlogComments(); } catch (_) {} unsubscribeBlogComments = null; }
                const landingPage = document.getElementById('landing-page');
                if (landingPage) {
                    landingPage.classList.remove('hidden');
                    landingPage.classList.add('fade-in');
                }
                hideAppLoading();
            }
        });

        function initializeAppState() {
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('email-verify-page').classList.add('hidden');
            
            const mainApp = document.getElementById('main-app');
            mainApp.classList.remove('hidden');
            mainApp.style.display = 'flex';
            mainApp.classList.add('fade-in');
            updateWelcomeMessage();
            setupRealtimeListeners();
            startClock();
            hideAppLoading();
            
            if (currentUser) {
                renderDashboard();
                // Log client access context for auditing
                logClientAccess().catch(() => {});
            }

            // Restore accent from localStorage
            try {
                const saved = localStorage.getItem('gcsemate_accent');
                if (saved) applyAccent(JSON.parse(saved));
            } catch (e) {}
        }
        function setupRealtimeListeners() {
            // Listen for announcements
            unsubscribeAnnouncement = db.collection('settings').doc('announcement')
                .onSnapshot(doc => {
                    const data = doc.data();
                    showAnnouncement(data ? data.message : '');
                }, err => console.error("Error fetching announcement:", err));
            // Admin listeners
            if (currentUser.role === 'admin') {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('user-settings-panel').classList.add('hidden');
                document.getElementById('add-link-form-container').classList.remove('hidden');
                document.getElementById('add-blog-post-form-container').classList.remove('hidden');
                
                // Listen for all users for the management panel
                unsubscribeUserManagement = db.collection('users').onSnapshot(snapshot => {
                    const allUsers = {};
                    snapshot.forEach(doc => {
                        allUsers[doc.id] = { id: doc.id, ...doc.data() };
                    });
                    renderUserManagementPanel(allUsers);
                }, err => console.error("Error fetching users:", err));
            } else {
                document.getElementById('admin-panel').classList.add('hidden');
                document.getElementById('user-settings-panel').classList.remove('hidden');
                document.getElementById('add-link-form-container').classList.add('hidden');
                document.getElementById('add-blog-post-form-container').classList.add('hidden');
            }
            // Listen for useful links
            unsubscribeUsefulLinks = db.collection('usefulLinks').orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    const links = {};
                    snapshot.forEach(doc => {
                        links[doc.id] = doc.data();
                    });
                    renderUsefulLinks(links);
                }, err => console.error("Error fetching useful links:", err));
                
            // Listen for video playlists
            unsubscribeVideoPlaylists = db.collection('videoPlaylists').orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    const playlists = [];
                    snapshot.forEach(doc => {
                        playlists.push({ id: doc.id, ...doc.data() });
                    });
                    renderVideosPage(playlists);
                }, err => console.error("Error fetching video playlists:", err));
            // Lessons removed
            // Listen for blog posts
            unsubscribeBlogPosts = db.collection('blogPosts').orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    const posts = [];
                    snapshot.forEach(doc => {
                        posts.push({ id: doc.id, ...doc.data() });
                    });
                    allBlogPosts = posts; // Store globally for modal access
                    renderBlogPage(posts);
                }, err => console.error("Error fetching blog posts:", err));
            // Listen for user-specific events
            unsubscribeUserEvents = db.collection('users').doc(currentUser.uid).collection('events')
                .onSnapshot(snapshot => {
                    const events = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (!events[data.date]) events[data.date] = [];
                        events[data.date].push({ id: doc.id, ...data });
                    });
                    renderCalendar(events, null); // Re-render with new user events
                    updateCountdownBanner(); // Update countdown when events change
                }, err => console.error("Error fetching user events:", err));
            // Listen for global events
            unsubscribeGlobalEvents = db.collection('globalEvents')
                .onSnapshot(snapshot => {
                    const events = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (!events[data.date]) events[data.date] = [];
                        events[data.date].push({ id: doc.id, ...data, isGlobal: true });
                    });
                    renderCalendar(null, events); // Re-render with new global events
                    updateCountdownBanner(); // Update countdown when events change
                }, err => console.error("Error fetching global events:", err));
        }
        async function handleRegister() {
            const displayName = document.getElementById('register-displayname').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const messageEl = document.getElementById('register-error');
            const nameErrorEl = document.getElementById('register-name-error');
            const emailErrorEl = document.getElementById('register-email-error');
            const passwordErrorEl = document.getElementById('register-password-error');
            
            // Clear previous errors
            messageEl.textContent = '';
            nameErrorEl.textContent = '';
            emailErrorEl.textContent = '';
            passwordErrorEl.textContent = '';
            
            // Basic validation
            if (!displayName) {
                nameErrorEl.textContent = 'Name is required';
                document.getElementById('register-displayname').focus();
                return;
            }
            
            if (displayName.length < 2) {
                nameErrorEl.textContent = 'Name must be at least 2 characters';
                document.getElementById('register-displayname').focus();
                return;
            }
            
            if (!email) {
                emailErrorEl.textContent = 'Email is required';
                document.getElementById('register-email').focus();
                return;
            }
            
            // Email format validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                emailErrorEl.textContent = 'Please enter a valid email address';
                document.getElementById('register-email').focus();
                return;
            }
            
            if (!password) {
                passwordErrorEl.textContent = 'Password is required';
                document.getElementById('register-password').focus();
                return;
            }
            
            if (password.length < 6) {
                passwordErrorEl.textContent = 'Password must be at least 6 characters';
                document.getElementById('register-password').focus();
                return;
            }
            
            try {
                // Show loading state
                const registerButton = document.getElementById('register-button');
                const originalText = registerButton.textContent;
                registerButton.textContent = 'Creating Account...';
                registerButton.disabled = true;
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Update Firebase Auth profile (best-effort)
                try {
                    await user.updateProfile({ displayName: displayName });
                } catch (e) {
                    console.warn('updateProfile failed, continuing:', e);
                }

                // Save user profile to Firestore (best-effort, non-blocking for verification)
                try {
                    await db.collection('users').doc(user.uid).set({
                        displayName: displayName,
                        email: email,
                        tier: 'free',
                        role: 'user',
                        starredFiles: [],
                        allowedSubjects: null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (e) {
                    console.warn('Firestore profile write failed, user can still verify email:', e);
                }

                // Send verification email: try default first, then fallback with action code settings
                try {
                    try {
                        await user.sendEmailVerification();
                    } catch (primaryError) {
                        console.warn('Default email verification send failed, trying with actionCodeSettings:', primaryError);
                        const actionCodeSettings = {
                            url: window.location.origin + '/',
                            handleCodeInApp: false
                        };
                        await user.sendEmailVerification(actionCodeSettings);
                    }
                } catch (e) {
                    console.error('sendEmailVerification failed:', e);
                }

                // Redirect to the verification instructions page regardless
                showVerificationMessagePage(email);
            } catch (error) {
                console.error("Registration Error:", error);
                
                // Provide more specific error messages
                let errorMessage = 'An error occurred during registration. Please try again.';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'An account with this email already exists.';
                    emailErrorEl.textContent = 'Email already in use';
                    document.getElementById('register-email').focus();
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format.';
                    emailErrorEl.textContent = 'Invalid email format';
                    document.getElementById('register-email').focus();
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak. Please choose a stronger password.';
                    passwordErrorEl.textContent = 'Password is too weak';
                    document.getElementById('register-password').focus();
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your connection and try again.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many failed attempts. Please try again later.';
                }
                
                messageEl.textContent = errorMessage;
            } finally {
                // Reset button state
                const registerButton = document.getElementById('register-button');
                registerButton.textContent = 'Create Free Account';
                registerButton.disabled = false;
            }
        }
        async function handleLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            const messageEl = document.getElementById('auth-error');
            const emailErrorEl = document.getElementById('email-error');
            const passwordErrorEl = document.getElementById('password-error');
            
            // Clear previous errors
            messageEl.textContent = '';
            emailErrorEl.textContent = '';
            passwordErrorEl.textContent = '';
            
            // Basic validation
            if (!email) {
                emailErrorEl.textContent = 'Email is required';
                document.getElementById('email').focus();
                return;
            }
            
            if (!password) {
                passwordErrorEl.textContent = 'Password is required';
                document.getElementById('password').focus();
                return;
            }
            
            // Email format validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                emailErrorEl.textContent = 'Please enter a valid email address';
                document.getElementById('email').focus();
                return;
            }
            
            try {
                // Show loading state
                const loginButton = document.getElementById('login-button');
                const originalText = loginButton.textContent;
                loginButton.textContent = 'Signing in...';
                loginButton.disabled = true;
                
                // Enterprise reCAPTCHA token acquisition
                try {
                    if (window.grecaptcha && RECAPTCHA_SITE_KEY) {
                        await grecaptcha.ready();
                        const token = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'LOGIN' });
                        try {
                            const verifyRes = await fetch('/api/recaptcha-verify', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ token, expectedAction: 'LOGIN' })
                            });
                            if (verifyRes.ok) {
                                const verifyData = await verifyRes.json().catch(() => ({}));
                                if (!verifyData.allowed) {
                                    messageEl.textContent = 'Suspicious activity detected. Please try again.';
                                    return;
                                }
                            } else {
                                // If backend not present, proceed without blocking login
                                console.warn('reCAPTCHA verify endpoint not available, proceeding. Status:', verifyRes.status);
                            }
                        } catch (e) {
                            // Network/endpoint issues should not block legitimate logins
                            console.warn('reCAPTCHA verify request failed, proceeding:', e);
                        }
                    }
                } catch (e) {
                    console.warn('reCAPTCHA token acquisition failed, proceeding:', e);
                }
                
                const persistence = rememberMe 
                    ? firebase.auth.Auth.Persistence.LOCAL 
                    : firebase.auth.Auth.Persistence.SESSION;
                
                await auth.setPersistence(persistence);
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                if (!userCredential.user.emailVerified) {
                    messageEl.textContent = 'Please verify your email before logging in.';
                    // The onAuthStateChanged listener will handle redirecting them to the verification page.
                    return;
                }
                // onAuthStateChanged will handle successful, verified login.
            } catch (error) {
                console.error("Login Error:", error);
                
                // Provide more specific error messages
                let errorMessage = 'An error occurred during login. Please try again.';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email address.';
                    emailErrorEl.textContent = 'No account found with this email';
                    document.getElementById('email').focus();
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password. Please try again.';
                    passwordErrorEl.textContent = 'Incorrect password';
                    document.getElementById('password').focus();
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format.';
                    emailErrorEl.textContent = 'Invalid email format';
                    document.getElementById('email').focus();
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many failed attempts. Please try again later.';
                } else if (error.code === 'auth/network-request-failed') {
                    errorMessage = 'Network error. Please check your connection and try again.';
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = 'This account has been disabled. Please contact support.';
                }
                
                messageEl.textContent = errorMessage;
            } finally {
                // Reset button state
                const loginButton = document.getElementById('login-button');
                loginButton.textContent = 'Login';
                loginButton.disabled = false;
            }
        }
        
        async function handleLogout() {
            try {
                // Destroy reCAPTCHA verifier
                if (recaptchaVerifier) {
                    recaptchaVerifier.clear();
                    recaptchaVerifier = null;
                }
                
                await auth.signOut();
                // onAuthStateChanged will handle UI changes
                path = [{ name: 'Root', id: ROOT_FOLDER_ID }];
                currentFolderFiles = [];
            } catch (error) {
                console.error("Logout failed:", error);
            }
        }
        
        async function resendVerificationEmail() {
            const button = document.getElementById('resend-verification-btn');
            const messageEl = document.getElementById('resend-message');
            if (auth.currentUser && !auth.currentUser.emailVerified) {
                try {
                    button.disabled = true;
                    button.textContent = 'Sending...';
                    try {
                        const actionCodeSettings = {
                            url: window.location.origin + '/',
                            handleCodeInApp: false
                        };
                        await auth.currentUser.sendEmailVerification(actionCodeSettings);
                    } catch (e) {
                        // Fallback to default if actionCodeSettings not supported in this context
                        await auth.currentUser.sendEmailVerification();
                    }
                    messageEl.textContent = 'A new verification link has been sent.';
                    setTimeout(() => {
                        messageEl.textContent = '';
                        button.disabled = false;
                        button.textContent = 'Resend Verification Email';
                    }, 5000);
                } catch (error) {
                    messageEl.textContent = 'Error sending email. Please try again later.';
                    console.error("Error resending verification email:", error);
                    button.disabled = false;
                    button.textContent = 'Resend Verification Email';
                }
            }
        }
        // =================================================================================
        // ADMIN & USER SETTINGS
        // =================================================================================
        function renderUserManagementPanel(allUsers) {
            const container = document.getElementById('user-management-grid');
            container.innerHTML = '';
            Object.values(allUsers).forEach(user => {
                if (user.id === currentUser.uid) return; // Don't show the admin their own card here
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md flex flex-col';
                card.innerHTML = `
                    <div class="flex-grow">
                        <h4 class="font-bold text-lg text-gray-800">${user.displayName}</h4>
                        <p class="text-sm text-gray-500">${user.email}</p>
                        <div class="mt-2 flex gap-2">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${user.tier === 'paid' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${capitalizeFirstLetter(user.tier)}</span>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${user.role === 'admin' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">${capitalizeFirstLetter(user.role)}</span>
                        </div>
                        ${user.lastAccess ? `<div class=\"mt-3 text-xs text-gray-600 space-y-1\">` +
                            `<div><span class=\"font-semibold\">Last Access:</span> ${new Date(user.lastAccess).toLocaleString()}</div>` +
                            `${user.ipInfo ? `<div class=\\\"flex items-center gap-2\\\"><img src=\\\"https://flagcdn.com/24x18/${(user.ipInfo.country_code||'').toLowerCase()}.png\\\" alt=\\\"flag\\\" class=\\\"w-4 h-3 rounded-sm\\\"> <span>${user.ipInfo.ip || ''} • ${user.ipInfo.country || ''} ${user.ipInfo.city ? '• ' + user.ipInfo.city : ''}</span></div>` : ''}` +
                        `</div>` : ''}
                    </div>
                    <button onclick="openEditUserModal('${user.id}')" class="mt-4 w-full text-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors text-sm">Edit User</button>
                `;
                container.appendChild(card);
            });
        }
        
        async function openEditUserModal(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    showToast("User not found!", 'error');
                    return;
                }
                const user = { id: userDoc.id, ...userDoc.data() };
                const modal = document.getElementById('edit-user-modal');
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl w-full max-w-lg flex flex-col fade-in max-h-[90vh]">
                         <div class="p-4 border-b border-gray-200/50 flex justify-between items-center">
                             <h3 class="text-lg font-semibold text-gray-800">Edit User: ${user.displayName}</h3>
                             <button onclick="document.getElementById('edit-user-modal').style.display='none'" class="text-2xl font-bold text-gray-500 hover:text-gray-800 p-1 leading-none" data-tooltip="Close">×</button>
                         </div>
                         <div class="p-6 space-y-4 overflow-y-auto">
                             <form id="edit-user-form" onsubmit="event.preventDefault(); handleUpdateUser('${user.id}')">
                                 <div>
                                     <label for="edit-displayname" class="block text-sm font-medium text-gray-700">Display Name</label>
                                     <input id="edit-displayname" type="text" value="${user.displayName}" class="mt-1 w-full p-2 rounded-lg border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                 </div>
                                 <div>
                                     <label for="edit-tier" class="block text-sm font-medium text-gray-700">User Tier</label>
                                     <select id="edit-tier" class="mt-1 w-full p-2 rounded-lg border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                         <option value="free" ${user.tier === 'free' ? 'selected' : ''}>Free</option>
                                         <option value="paid" ${user.tier === 'paid' ? 'selected' : ''}>Paid</option>
                                     </select>
                                 </div>
                                  <div>
                                     <label for="edit-role" class="block text-sm font-medium text-gray-700">User Role</label>
                                     <select id="edit-role" class="mt-1 w-full p-2 rounded-lg border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                                         <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                         <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                     </select>
                                 </div>
                                 <div>
                                     <label class="block text-sm font-medium text-gray-700">Allowed Subjects</label>
                                     <div id="edit-subject-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-2 text-sm border-t pt-2"></div>
                                 </div>
                                 <div class="flex justify-end gap-3 pt-4">
                                     <button type="button" onclick="document.getElementById('edit-user-modal').style.display='none'" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300">Cancel</button>
                                     <button type="submit" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700">Save Changes</button>
                                 </div>
                             </form>
                         </div>
                    </div>
                `;
                const subjectContainer = modal.querySelector('#edit-subject-checkboxes');
                const userSubjects = user.allowedSubjects || [];
                SUBJECTS.forEach(subject => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 cursor-pointer';
                    label.innerHTML = `
                        <input type="checkbox" name="edit-subjects" value="${subject.toLowerCase()}" ${userSubjects.includes(subject.toLowerCase()) ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span>${subject}</span>
                    `;
                    subjectContainer.appendChild(label);
                });
            } catch (error) {
                console.error("Error opening edit modal:", error);
                showToast("Could not load user data for editing.", 'error');
            }
        }
        async function handleUpdateUser(userId) {
            try {
                const newDisplayName = document.getElementById('edit-displayname').value;
                const newTier = document.getElementById('edit-tier').value;
                const newRole = document.getElementById('edit-role').value;
                const newSubjects = Array.from(document.querySelectorAll('#edit-user-modal input[name="edit-subjects"]:checked')).map(cb => cb.value);
                await db.collection('users').doc(userId).update({
                    displayName: newDisplayName,
                    tier: newTier,
                    role: newRole,
                    allowedSubjects: newSubjects.length > 0 ? newSubjects : null
                });
                
                document.getElementById('edit-user-modal').style.display = 'none';
                showToast('User updated successfully!', 'success');
            } catch (error) {
                console.error("Failed to update user:", error);
                showToast("Failed to save changes.", 'error');
            }
        }
        async function handleUpdateUserSettings() {
            const displayName = document.getElementById('user-displayname').value.trim();
            const newPassword = document.getElementById('user-password').value;
            const messageEl = document.getElementById('user-settings-message');
            messageEl.textContent = '';
            try {
                // Update Firestore display name
                await db.collection('users').doc(currentUser.uid).update({ displayName });
                await auth.currentUser.updateProfile({ displayName: displayName });
                
                // Update password if provided
                if (newPassword) {
                    await auth.currentUser.updatePassword(newPassword);
                }
                
                // Update local state
                currentUser.displayName = displayName;
                updateWelcomeMessage();
                messageEl.textContent = 'Settings saved successfully!';
                messageEl.className = 'text-green-600 text-sm text-center h-4';
                setTimeout(() => messageEl.textContent = '', 3000);
            } catch (error) {
                console.error("Error updating user settings:", error);
                const friendlyMessage = handleAPIError(error, 'updating settings');
                messageEl.textContent = friendlyMessage;
                messageEl.className = 'text-red-600 text-sm text-center h-4 transition-all duration-300';
            }
        }
        
        // Enhanced error handling and user feedback system
        function showErrorMessage(inputElement, message) {
            const messageEl = inputElement.parentElement.querySelector('.error-message') || inputElement.nextElementSibling;
            if (messageEl) {
                messageEl.textContent = message;
                messageEl.className = 'text-red-600 text-sm text-center h-4 transition-all duration-300';
                
                // Add visual feedback to the input field
                inputElement.classList.add('border-red-500', 'bg-red-50');
                inputElement.classList.remove('border-gray-300');
                
                // Auto-clear error when user starts typing
                const handleInput = () => {
                    inputElement.classList.remove('border-red-500', 'bg-red-50');
                    inputElement.classList.add('border-gray-300');
                    messageEl.textContent = '';
                    inputElement.removeEventListener('input', handleInput);
                };
                inputElement.addEventListener('input', handleInput);
            }
        }
        
        // Enhanced toast notification system
        function showToast(message, type = 'info', duration = 4000) {
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            
            const toast = document.createElement('div');
            const bgColor = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'warning': 'bg-yellow-600',
                'info': 'bg-blue-600'
            }[type] || 'bg-blue-600';
            
            const icon = {
                'success': '✓',
                'error': '✕',
                'warning': '⚠',
                'info': 'ℹ'
            }[type] || 'ℹ';
            
            toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 mb-3 transform translate-x-full transition-all duration-300 ease-out gpu-accelerated`;
            toast.innerHTML = `
                <span class="text-lg font-bold">${icon}</span>
                <span class="flex-1">${message}</span>
                <button class="text-white hover:text-gray-200 ml-2" onclick="this.parentElement.remove()">×</button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Trigger slide-in animation
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 10);
            
            // Auto remove
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        }
        
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'fixed top-4 right-4 z-50 max-w-sm';
            document.body.appendChild(container);
            return container;
        }
        
        // Global error handler for better user experience
        function handleAPIError(error, context = '') {
            console.error(`API Error ${context}:`, error);
            
            let userMessage = 'Something went wrong. Please try again.';
            
            if (error.message.includes('network') || error.message.includes('fetch')) {
                userMessage = 'Network error. Please check your connection and try again.';
            } else if (error.message.includes('permission') || error.message.includes('auth')) {
                userMessage = 'Authentication error. Please log in again.';
            } else if (error.message.includes('quota') || error.message.includes('limit')) {
                userMessage = 'Service temporarily unavailable. Please try again later.';
            }
            
            showToast(userMessage, 'error');
            return userMessage;
        }
        
        // =================================================================================
        // PAGE/VIEW MANAGEMENT & RENDERING
        // =================================================================================
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        function generatePfpUrl(email) {
            const initial = (email ? email.charAt(0) : '?').toUpperCase();
            return `https://placehold.co/40x40/3B82F6/FFFFFF?text=${initial}`;
        }
        function updateWelcomeMessage() {
            if (!currentUser) return;
            const welcomeEl = document.getElementById('welcome-message');
            const name = capitalizeFirstLetter(currentUser.displayName);
            welcomeEl.textContent = `Welcome, ${name}!`;
            // Ensure truncation has a title tooltip for full name
            welcomeEl.title = `Welcome, ${name}!`;
            document.getElementById('profile-picture').src = generatePfpUrl(currentUser.email);
            document.getElementById('user-displayname').value = currentUser.displayName;
            document.getElementById('user-email').value = currentUser.email;
        }
        function renderError(container, message) {
            if (container) {
                const colSpanClass = container.id === 'subject-grid' || container.id === 'playlist-grid' ? 'col-span-full' : '';
                container.innerHTML = `<div class="${colSpanClass} text-center text-red-600 p-8 bg-red-50/70 rounded-2xl border border-red-200/50"><h3 class="font-bold text-xl text-red-800">Oops! Something went wrong.</h3><p class="mt-2 text-sm text-red-700">${message}</p></div>`;
            }
        }
        
        function showAuthPage(showLogin = true) {
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const formTitle = document.getElementById('form-title');
            if (showLogin) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                formTitle.textContent = 'Your Ultimate Revision Hub';
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                formTitle.textContent = 'Create a Free Account';
            }
            document.getElementById('auth-error').textContent = '';
            document.getElementById('register-error').textContent = '';
        }
        
        function showVerificationMessagePage(email) {
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('email-verify-page').classList.remove('hidden');
            const emailDisplay = document.getElementById('verification-email-display');
            if (email) {
                emailDisplay.innerHTML = `We've sent a verification link to <strong>${email}</strong>. Please check your inbox (and spam folder) and click the link to activate your account.`;
            }
        }

        function showPage(pageId) {
            const pages = document.querySelectorAll('.page');
            let current = null;
            pages.forEach(page => {
                if (!page.classList.contains('hidden')) current = page;
            });
            const newPage = document.getElementById(pageId);
            if (!newPage) return;

            if (current && current !== newPage) {
                // Modern iOS-like leave
                current.classList.add('page-leave-modern');
                setTimeout(() => {
                    current.classList.add('hidden');
                    current.classList.remove('page-leave-modern');
                }, 340);
            }

            // Enter animation with slight delay to avoid overlap
            // Prevent layout jank by measuring and pre-setting height
            const container = document.getElementById('page-container') || newPage.parentElement;
            const prevHeight = current ? current.offsetHeight : 0;
            const nextHeight = newPage.offsetHeight;
            if (container && prevHeight) container.style.minHeight = prevHeight + 'px';

            requestAnimationFrame(() => {
                newPage.classList.remove('hidden');
                newPage.classList.add('page-enter-modern');
                // Smooth container height morph
                if (container) {
                    const h = newPage.offsetHeight || nextHeight || prevHeight;
                    container.style.transition = 'min-height 360ms cubic-bezier(0.22,1,0.36,1)';
                    container.style.minHeight = h + 'px';
                    setTimeout(() => { container.style.minHeight = ''; container.style.transition = ''; }, 380);
                }
                setTimeout(() => newPage.classList.remove('page-enter-modern'), 540);
            });

            // Update nav active state
            document.querySelectorAll('.nav-link').forEach(l => {
                l.classList.remove('active');
                if (l.dataset.page === pageId) l.classList.add('active');
            });
            // Update document title
            try { if (pageTitles[pageId]) document.title = pageTitles[pageId]; } catch (_) {}
            // Lessons removed
             // Close mobile menu on navigation
            const mobileMenu = document.getElementById('mobile-menu');
            if (!mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.add('hidden');
            }
        }
        function showAnnouncement(message) {
            const announcementBanner = document.getElementById('site-announcement-banner');
            if (message && message.trim() !== '') {
                announcementBanner.innerHTML = `<div class="bg-blue-600 text-white p-3 text-center text-sm font-semibold flex justify-center items-center relative"><span>${message}</span><button onclick="this.parentElement.parentElement.style.display='none'" class="font-bold text-xl px-2 absolute right-2" data-tooltip="Dismiss">×</button></div>`;
                announcementBanner.classList.remove('hidden');
            } else {
                announcementBanner.classList.add('hidden');
            }
        }
        async function postAnnouncement() {
            if (currentUser.role !== 'admin') return;
            const text = document.getElementById('announcement-text').value.trim();
            try {
                await db.collection('settings').doc('announcement').set({ message: text });
                 showToast('Announcement posted!', 'success');
            } catch (error) {
                console.error("Error posting announcement:", error);
                showToast("Could not post announcement.", 'error');
            }
        }
        
        async function clearAnnouncement() {
            if (currentUser.role !== 'admin') return;
            try {
                await db.collection('settings').doc('announcement').set({ message: '' });
                document.getElementById('announcement-text').value = '';
                showToast('Announcement cleared!', 'success');
            } catch (error) {
                console.error("Error clearing announcement:", error);
                showToast("Could not clear announcement.", 'error');
            }
        }
        async function renderDashboard() {
            const subjectGrid = document.getElementById('subject-grid');
            if (!subjectGrid) return;
            // Render skeleton loader
            let skeletonHTML = '';
            for (let i = 0; i < 10; i++) {
                skeletonHTML += '<div class="h-36 skeleton"></div>';
            }
            subjectGrid.innerHTML = skeletonHTML;
            
            try {
                // Try multiple function routes in case Pages is configured differently
                let data = null;
                const subjectUrls = [
                    `/api/drive-subjects?root=${encodeURIComponent(ROOT_FOLDER_ID)}`,
                    `/drive-subjects?root=${encodeURIComponent(ROOT_FOLDER_ID)}`,
                    `/functions/drive-subjects?root=${encodeURIComponent(ROOT_FOLDER_ID)}`
                ];
                let lastErr = null;
                for (const u of subjectUrls) {
                    try {
                        const res = await fetch(u);
                        if (!res.ok) {
                            let reason = `HTTP ${res.status}`;
                            try { const j = await res.json(); reason = j.error || reason; } catch {}
                            throw new Error(reason);
                        }
                        data = await res.json();
                        break;
                    } catch (e) { lastErr = e; }
                }
                if (!data) throw new Error(lastErr ? lastErr.message : 'Proxy not found');
                allSubjectFolders = {};
                if (data.files) {
                    data.files.forEach(folder => {
                        allSubjectFolders[folder.name.toLowerCase()] = folder.id;
                    });
                }
                
                subjectGrid.innerHTML = '';
                const userAllowedSubjects = currentUser.allowedSubjects;
                let subjectsToShow = userAllowedSubjects === null || userAllowedSubjects === undefined ? SUBJECTS : SUBJECTS.filter(s => userAllowedSubjects.includes(s.toLowerCase()));
                if (subjectsToShow.length === 0) {
                    subjectGrid.innerHTML = `<div class="col-span-full text-center text-gray-500 p-10"><h3 class="mt-4 text-lg font-bold text-gray-700">No Subjects Available</h3><p class="mt-1 text-sm text-gray-500">Your account does not have access to any subjects. Please contact an administrator.</p></div>`;
                    return;
                }
                const examBoardBySubject = {
                    // AQA
                    biology: 'AQA', chemistry: 'AQA', physics: 'AQA',
                    // Edexcel
                    music: 'Edexcel', german: 'Edexcel', maths: 'Edexcel', history: 'Edexcel',
                    // OCR
                    computing: 'OCR', geography: 'OCR',
                    // Both
                    english: 'AQA & Edexcel',
                    // Eduqas
                    'philosophy and ethics': 'Eduqas'
                };
                subjectsToShow.forEach(subject => {
                    const subjectId = allSubjectFolders[subject.toLowerCase()];
                    const card = document.createElement('div');
                    const iconSvg = subjectIconMap[subject.toLowerCase()] || uniformSubjectIcon;
                    const board = examBoardBySubject[subject.toLowerCase()];
                    const badge = board ? `<span class="mt-1 inline-flex items-center gap-1 text-[11px] font-semibold px-2 py-0.5 rounded-full bg-white/60 border border-white/40 text-gray-700">${board}</span>` : '';
                    const name = subject && subject.trim() ? subject : 'Subject';
                    // Build DOM nodes instead of innerHTML to avoid any async repaint issue
                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex flex-col items-center justify-center gap-2';
                    const iconHost = document.createElement('div');
                    iconHost.className = 'flex items-center justify-center h-12 w-12';
                    iconHost.innerHTML = `${iconSvg}`;
                    wrapper.appendChild(iconHost);
                    const title = document.createElement('h3');
                    title.className = 'text-xl font-bold text-gray-800';
                    title.textContent = name;
                    title.setAttribute('data-animate','fade-up');
                    wrapper.appendChild(title);
                    if (badge) {
                        const badgeWrap = document.createElement('div');
                        badgeWrap.innerHTML = badge;
                        wrapper.appendChild(badgeWrap.firstChild);
                    }
                    card.appendChild(wrapper);
                    if (subjectId) {
                        card.className = 'p-4 sm:p-6 rounded-2xl shadow-lg cursor-pointer transition-all transform hover:scale-105 hover:shadow-xl flex flex-col items-center justify-center text-center bg-white/70 border border-white/30 brand-gradient hover-raise min-h-[120px]';
                        card.setAttribute('data-tooltip', `Open ${subject} folder`);
                        card.addEventListener('click', () => {
                            if (currentUser.tier === 'free') {
                                document.getElementById('upgrade-modal-message').textContent = 'To access revision files, please upgrade to our Pro plan. Get unlimited access to all subjects and features for just £1/month.';
                                document.getElementById('upgrade-modal').style.display = 'flex';
                                return;
                            }
                            path = [{ name: 'GCSEMate', id: ROOT_FOLDER_ID }, { name: subject, id: subjectId }];
                            handleNavigation(subjectId);
                            showPage('file-browser-page');
                        });
                    } else {
                        card.className = 'p-4 sm:p-6 rounded-2xl shadow-md flex flex-col items-center justify-center text-center bg-gray-200/50 border border-gray-300/30 backdrop-blur-lg opacity-60 cursor-not-allowed min-h-[120px]';
                        card.setAttribute('data-tooltip', `Folder for ${subject} is not yet available`);
                    }
                    subjectGrid.appendChild(card);
                });
            } catch (err) {
                renderError(subjectGrid, `Could not load subjects. ${err.message || ''} Please try again later.`);
                showToast(`Subjects failed to load: ${err.message}`, 'error');
            }
        }
        async function handleNavigation(folderId) {
            await fetchAndRenderFiles(folderId);
        }
        async function fetchAndRenderFiles(folderId) {
            const fileListContainer = document.getElementById('file-list');
            fileListContainer.setAttribute('aria-busy','true');
            // Full-screen smooth overlay
            let overlay = document.getElementById('page-loading-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'page-loading-overlay';
                overlay.className = 'fixed inset-0 z-[1000] hidden flex items-center justify-center';
                overlay.innerHTML = '<div class="flex flex-col items-center gap-4"><div class="loading-orb"></div><div class="flex items-center gap-2"><span class="loading-pulse"></span><span class="loading-pulse"></span><span class="loading-pulse"></span></div><div class="text-sm font-semibold text-gray-600">Loading files…</div></div>';
                document.body.appendChild(overlay);
            }
            overlay.classList.remove('hidden');
            requestAnimationFrame(() => overlay.classList.add('visible'));
            try {
                // Try multiple function routes in case Pages is configured differently
                let data = null;
                const fileUrls = [
                    `/api/drive-files?folderId=${encodeURIComponent(folderId)}`,
                    `/drive-files?folderId=${encodeURIComponent(folderId)}`,
                    `/functions/drive-files?folderId=${encodeURIComponent(folderId)}`
                ];
                let lastErr = null;
                for (const u of fileUrls) {
                    try {
                        const res = await fetch(u);
                        if (!res.ok) {
                            let reason = `HTTP ${res.status}`;
                            try { const j = await res.json(); reason = j.error || reason; } catch {}
                            throw new Error(reason);
                        }
                        data = await res.json();
                        break;
                    } catch (e) { lastErr = e; }
                }
                if (!data) throw new Error(lastErr ? lastErr.message : 'Proxy not found');
                currentFolderFiles = data.files;
                renderItems();
            } catch (err) {
                renderError(fileListContainer, err.message || 'Something went wrong while loading files.');
            } finally {
                renderBreadcrumbs();
                fileListContainer.setAttribute('aria-busy','false');
                if (overlay) {
                    overlay.classList.remove('visible');
                    setTimeout(() => overlay.classList.add('hidden'), 220);
                }
            }
        }
        
        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function timeAgo(date) {
            try {
                const now = new Date();
                const seconds = Math.floor((now.getTime() - date.getTime()) / 1000);
                const rtf = new Intl.RelativeTimeFormat('en', { numeric: 'auto' });
                if (seconds < 60) return rtf.format(-Math.max(1, seconds), 'second');
                if (seconds < 3600) return rtf.format(-Math.floor(seconds/60), 'minute');
                if (seconds < 86400) return rtf.format(-Math.floor(seconds/3600), 'hour');
                if (seconds < 604800) return rtf.format(-Math.floor(seconds/86400), 'day');
                if (seconds < 2592000) return rtf.format(-Math.floor(seconds/604800), 'week');
                if (seconds < 31536000) return rtf.format(-Math.floor(seconds/2592000), 'month');
                return rtf.format(-Math.floor(seconds/31536000), 'year');
            } catch (_) {
                return date.toLocaleString();
            }
        }

        function highlightMatch(text, query) {
            if (!query) return escapeHtml(text);
            const safeText = escapeHtml(text);
            const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const re = new RegExp(escaped, 'gi');
            return safeText.replace(re, (m) => `<span class="bg-yellow-200 text-gray-900 rounded px-0.5">${m}</span>`);
        }

        function renderItems() {
            const container = document.getElementById('file-list');
            const rawQuery = document.getElementById('file-search-input').value || '';
            const searchInput = rawQuery.toLowerCase();
            const searchIconHost = document.querySelector('#file-browser-controls .relative');
            if (searchIconHost && searchInput.length > 0) {
                if (!searchIconHost.querySelector('.dots-spinner')) {
                    const dot = document.createElement('div');
                    dot.className = 'dots-spinner absolute right-3 top-1/2 -translate-y-1/2';
                    dot.innerHTML = '<i></i><i></i><i></i>';
                    searchIconHost.appendChild(dot);
                }
            } else if (searchIconHost) {
                const ds = searchIconHost.querySelector('.dots-spinner');
                if (ds) ds.remove();
            }
            const sortOrder = document.getElementById('file-sort-select').value;
        
            container.innerHTML = ''; // Clear previous items
        
            // 1. Filter
            let filteredFiles = currentFolderFiles.filter(file => 
                file.name.toLowerCase().includes(searchInput)
            );
        
            if (!filteredFiles || filteredFiles.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 p-10"><h3 class="mt-4 text-lg font-bold text-gray-700">No files found.</h3></div>`;
                return;
            }
        
            // 2. Sort
            const starredFiles = currentUser.starredFiles || [];
            filteredFiles.sort((a, b) => {
                const a_isStarred = starredFiles.includes(a.id);
                const b_isStarred = starredFiles.includes(b.id);
                const a_isFolder = a.mimeType === 'application/vnd.google-apps.folder';
                const b_isFolder = b.mimeType === 'application/vnd.google-apps.folder';
        
                if (a_isStarred !== b_isStarred) return a_isStarred ? -1 : 1;
                if (a_isFolder !== b_isFolder) return a_isFolder ? -1 : 1;
        
                return sortOrder === 'az'
                    ? a.name.localeCompare(b.name)
                    : b.name.localeCompare(a.name);
            });
        
            // 3. Render (based on view)
            if (fileBrowserView === 'grid') {
                container.className = 'p-4 overflow-y-auto flex-grow grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 sm:gap-4';
                filteredFiles.forEach((file, index) => {
                    const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
                    const isStarred = starredFiles.includes(file.id);
                    const itemElement = document.createElement('div');
                    itemElement.className = `relative p-3 sm:p-4 rounded-xl flex flex-col items-center justify-center text-center cursor-pointer transition-all duration-200 ease-out transform hover:scale-105 hover:shadow-xl bg-white/50 border ${isStarred ? 'border-yellow-400' : 'border-white/30'} backdrop-blur-lg opacity-0 translate-y-2 min-h-[100px]`;
                    
                    const mainInfo = document.createElement('div');
                    mainInfo.className = 'flex flex-col items-center justify-center flex-grow w-full';
                    const highlightedName = highlightMatch(file.name, rawQuery.trim());
                    mainInfo.innerHTML = `<img src="${file.iconLink}" class="w-12 h-12 mb-2" alt="${escapeHtml(file.name)}"><p class="text-sm font-medium text-gray-800 break-words w-full">${highlightedName}</p>`;
        
                    if (isFolder) {
                        itemElement.addEventListener('click', () => { path.push({ name: file.name, id: file.id }); fetchAndRenderFiles(file.id); });
                    } else {
                        itemElement.addEventListener('click', () => showPreview(file));
                    }
                    
                    if (!isFolder) {
                        const actions = document.createElement('div');
                        actions.className = 'absolute top-1 right-1 flex flex-col gap-1';
                        actions.innerHTML = `
                            <button onclick='handleToggleStar("${file.id}", event)' class="star-icon text-gray-400 hover:text-yellow-400 p-1 rounded-full bg-white/50 ${isStarred ? 'starred' : ''}" data-tooltip="Star File"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg></button>
                            <a href="${file.webContentLink || `https://drive.google.com/uc?export=download&id=${file.id}`}" download target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" data-tooltip="Download File" class="text-gray-600 hover:text-blue-700 p-1 rounded-full bg-white/50 hover:bg-gray-200 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></a>`;
                        itemElement.appendChild(actions);
                    }
                    itemElement.appendChild(mainInfo);
                    container.appendChild(itemElement);
                    // animate in, staggered
                    setTimeout(() => {
                        itemElement.classList.remove('opacity-0','translate-y-2');
                        itemElement.classList.add('opacity-100','translate-y-0');
                        itemElement.style.transition = 'transform 420ms cubic-bezier(0.22, 1, 0.36, 1), opacity 380ms ease';
                    }, Math.min(index, 20) * 22);
                });
            } else { // List view
                container.className = 'p-4 overflow-y-auto flex-grow';
                filteredFiles.forEach((file, index) => {
                    const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
                    const isStarred = starredFiles.includes(file.id);
                    const itemElement = document.createElement('div');
                    itemElement.className = `flex items-center p-3 sm:p-4 rounded-lg hover:bg-black/5 transition-all duration-200 ease-out ${isStarred ? 'bg-yellow-100/50' : ''} opacity-0 translate-y-2 min-h-[60px]`;
                    const mainInfo = document.createElement('div');
                    mainInfo.className = 'flex items-center flex-grow cursor-pointer min-w-0';
                    const highlightedName = highlightMatch(file.name, rawQuery.trim());
                    mainInfo.innerHTML = `<img src="${file.iconLink}" class="w-6 h-6 mr-3 flex-shrink-0" alt="${escapeHtml(file.name)}"><span class="truncate font-medium text-gray-800 text-sm sm:text-base">${highlightedName}</span>`;
                    
                    if (isFolder) {
                        mainInfo.addEventListener('click', () => { path.push({ name: file.name, id: file.id }); fetchAndRenderFiles(file.id); });
                    } else {
                        mainInfo.addEventListener('click', () => showPreview(file));
                    }
                    const actions = document.createElement('div');
                    actions.className = 'flex items-center space-x-1 sm:space-x-2 flex-shrink-0 ml-2 sm:ml-4';
                    if (!isFolder) {
                        actions.innerHTML += `<button onclick='handleToggleStar("${file.id}", event)' class="star-icon text-gray-400 hover:text-yellow-400 p-2 rounded-full ${isStarred ? 'starred' : ''}" data-tooltip="Star File"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg></button>`;
                        const downloadLink = file.webContentLink || `https://drive.google.com/uc?export=download&id=${file.id}`;
                        actions.innerHTML += `<a href="${downloadLink}" download target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" data-tooltip="Download File" class="text-gray-600 hover:text-blue-700 p-2 rounded-full hover:bg-gray-200 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></a>`;
                    }
                    itemElement.appendChild(mainInfo);
                    itemElement.appendChild(actions);
                    container.appendChild(itemElement);
                    setTimeout(() => {
                        itemElement.classList.remove('opacity-0','translate-y-2');
                        itemElement.classList.add('opacity-100','translate-y-0');
                    }, Math.min(index, 20) * 15);
                });
            }
            initializeTooltips(); // Re-initialize tooltips for new elements
        }
        async function handleToggleStar(fileId, event) {
            event.stopPropagation();
            const starButton = event.currentTarget;
            const userRef = db.collection('users').doc(currentUser.uid);
            const starredFiles = currentUser.starredFiles || [];
            const isCurrentlyStarred = starredFiles.includes(fileId);
            const updateAction = isCurrentlyStarred 
                ? firebase.firestore.FieldValue.arrayRemove(fileId)
                : firebase.firestore.FieldValue.arrayUnion(fileId);
            try {
                await userRef.update({ starredFiles: updateAction });
                // Optimistically update UI
                if (isCurrentlyStarred) {
                    currentUser.starredFiles = starredFiles.filter(id => id !== fileId);
                } else {
                    currentUser.starredFiles.push(fileId);
                    // Pop + sparkle burst
                    starButton.classList.add('pop-animation');
                    const burst = document.createElement('div');
                    burst.className = 'sparkle-burst';
                    const rays = 6;
                    for (let i = 0; i < rays; i++) {
                        const s = document.createElement('span');
                        const angle = (Math.PI * 2 * i) / rays;
                        const dist = 16;
                        s.style.setProperty('--tx', `${Math.cos(angle) * dist}px`);
                        s.style.setProperty('--ty', `${Math.sin(angle) * dist}px`);
                        s.style.left = '50%';
                        s.style.top = '50%';
                        s.style.transform = 'translate(-50%,-50%)';
                        s.style.animation = 'sparkleOut 360ms ease-out forwards';
                        burst.appendChild(s);
                    }
                    starButton.appendChild(burst);
                    setTimeout(() => {
                        starButton.classList.remove('pop-animation');
                        burst.remove();
                    }, 380);
                }
                renderItems();
            } catch (error) {
                console.error("Error updating starred files:", error);
                showToast("Could not update star status.", 'error');
            }
        }
        function renderBreadcrumbs() {
            const breadcrumbContainer = document.getElementById('breadcrumb');
            breadcrumbContainer.innerHTML = '';
            path.forEach((crumb, index) => {
                const isLast = index === path.length - 1;
                const crumbElement = document.createElement(isLast ? 'span' : 'a');
                crumbElement.textContent = crumb.name;
                crumbElement.className = isLast ? "font-semibold text-gray-700" : 'cursor-pointer hover:underline text-blue-700';
                if (!isLast) {
                    crumbElement.href = '#';
                    crumbElement.addEventListener('click', (e) => {
                        e.preventDefault();
                        path = path.slice(0, index + 1);
                        if (path.length <= 1) {
                            showPage('subject-dashboard-page');
                        } else {
                            fetchAndRenderFiles(crumb.id);
                        }
                    });
                }
                breadcrumbContainer.appendChild(crumbElement);
                if (!isLast) {
                    const separator = document.createElement('span');
                    separator.textContent = ' / ';
                    separator.className = 'mx-2 text-gray-400';
                    breadcrumbContainer.appendChild(separator);
                }
            });
        }
        
        // =================================================================================
        // VIDEOS LOGIC
        // =================================================================================
        function renderVideosPage(playlists) {
            const grid = document.getElementById('playlist-grid');
            const adminForm = document.getElementById('add-playlist-form-container');
            if (!grid || !adminForm) return;
            // Show admin form if user is admin
            adminForm.style.display = currentUser.role === 'admin' ? 'block' : 'none';
            grid.innerHTML = '';
            if (!playlists || playlists.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500 p-10"><h3 class="mt-4 text-lg font-bold text-gray-700">No Video Playlists Available Yet</h3><p class="mt-1 text-sm text-gray-500">Check back later for curated revision videos.</p></div>`;
                return;
            }
            playlists.forEach(playlist => {
                const card = document.createElement('div');
                card.className = 'relative bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg p-4 flex flex-col cursor-pointer transition-transform transform hover:scale-105';
                card.onclick = () => handlePlaylistClick(playlist);
                card.innerHTML = `
                    <div class="flex-grow flex flex-col justify-center items-center text-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                          <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 class="font-bold text-gray-800 leading-tight">${playlist.title}</h3>
                    </div>
                     <div class="mt-4 pt-3 border-t border-gray-200/60 flex justify-between items-center text-xs text-gray-500 font-semibold">
                         <span>YOUTUBE PLAYLIST</span>
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                           <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
                         </svg>
                    </div>
                    ${currentUser.role === 'admin' ? `
                    <div class="absolute top-2 right-2 flex gap-1">
                        <button onclick="event.stopPropagation(); editPlaylist('${playlist.id}', '${playlist.title.replace(/'/g, "\\'")}')" class="p-1.5 bg-blue-500/80 text-white rounded-full hover:bg-blue-600 transition-colors" data-tooltip="Edit Playlist">
                            <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-4 w-4\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z\" /></svg>
                        </button>
                        <button onclick="event.stopPropagation(); deletePlaylist('${playlist.id}')" class="p-1.5 bg-red-500/80 text-white rounded-full hover:bg-red-600 transition-colors" data-tooltip="Delete Playlist">
                            <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-4 w-4\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" /></svg>
                        </button>
                    </div>` : ''}
                `;
                grid.appendChild(card);
            });
        }

        // =================================================================================
            // Lessons removed

        function getVideoEmbed(url) {
            try {
                const data = parseYoutubeUrl(url);
                if (data && data.type) {
                    const sep = data.embedUrl.includes('?') ? '&' : '?';
                    const finalUrl = `${data.embedUrl}${sep}modestbranding=1&rel=0&playsinline=1&iv_load_policy=3&color=white&fs=0`;
                    return `<div class="aspect-w-16 aspect-h-9 video-brand-wrapper rounded-lg overflow-hidden">
                        <iframe src="${finalUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" class="w-full h-full"></iframe>
                        <div class="video-brand-watermark"><img src="gcsemate%20new.png" alt="GCSEMate" class="h-6 w-auto opacity-80"></div>
                        <div class="video-brand-controls"><button onclick=\"handleVideoWrapperFullscreen(this)\" class=\"px-2 py-1 rounded-md bg-white/20 hover:bg-white/30 text-white border border-white/20 transition-colors\" aria-label=\"Fullscreen\"><svg xmlns=\"http://www.w3.org/2000/svg\" class=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 3H5a2 2 0 00-2 2v3m0 8v3a2 2 0 002 2h3m8-16h3a2 2 0 012 2v3m0 8v3a2 2 0 01-2 2h-3\"/></svg></button></div>
                    </div>`;
                }
                // Fallback generic embed
                return `<div class=\"aspect-w-16 aspect-h-9 video-brand-wrapper rounded-lg overflow-hidden\"><iframe src=\"${url}\" frameborder=\"0\" class=\"w-full h-full\"></iframe><div class=\"video-brand-watermark\"><img src=\"gcsemate%20new.png\" alt=\"GCSEMate\" class=\"h-6 w-auto opacity-80\"></div><div class=\"video-brand-controls\"><button onclick=\\\"handleVideoWrapperFullscreen(this)\\\" class=\\\"px-2 py-1 rounded-md bg-white/20 hover:bg-white/30 text-white border border-white/20 transition-colors\\\" aria-label=\\\"Fullscreen\\\"><svg xmlns=\\\"http://www.w3.org/2000/svg\\\" class=\\\"h-5 w-5\\\" fill=\\\"none\\\" viewBox=\\\"0 0 24 24\\\" stroke=\\\"currentColor\\\"><path stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\" stroke-width=\\\"2\\\" d=\\\"M8 3H5a2 2 0 00-2 2v3m0 8v3a2 2 0 002 2h3m8-16h3a2 2 0 012 2v3m0 8v3a2 2 0 01-2 2h-3\\\"/></svg></button></div></div>`;
            } catch { return ''; }
        }

        // Minimal Markdown renderer for headings, bold, italics, links, lists, code blocks
        function renderMarkdown(md) {
            let html = md
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            html = html.replace(/^###### (.*$)/gim, '<h6>$1</h6>')
                       .replace(/^##### (.*$)/gim, '<h5>$1</h5>')
                       .replace(/^#### (.*$)/gim, '<h4>$1</h4>')
                       .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                       .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                       .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                       .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                       .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                       .replace(/`([^`]+)`/gim, '<code>$1</code>')
                       .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
                       .replace(/\n\n/g, '</p><p>')
                       .replace(/\[(.*?)\]\((.*?)\)/gim, '<a href="$2" target="_blank" rel="noopener">$1</a>');
            html = `<p>${html}</p>`;
            // Lists
            html = html.replace(/<p>\s*[-*] (.*)<\/p>/gim, '<ul><li>$1</li></ul>')
                       .replace(/<\/ul>\s*<ul>/gim, '');
            return html;
        }
        
        async function handleAddPlaylist() {
            if (currentUser.role !== 'admin') return;
            const form = document.getElementById('add-playlist-form');
            const titleInput = document.getElementById('playlist-title');
            const urlInput = document.getElementById('playlist-url');
            const messageEl = document.getElementById('add-playlist-message');
            
            const title = titleInput.value.trim();
            const url = urlInput.value.trim();
            if (!title || !url) {
                messageEl.textContent = 'Please fill in both title and URL.';
                messageEl.className = 'text-red-600 text-sm mt-2 h-4';
                return;
            }
            const youtubeData = parseYoutubeUrl(url);
            if (!youtubeData || youtubeData.type !== 'youtube_playlist') {
                 messageEl.textContent = 'Please enter a valid YouTube Playlist URL.';
                 messageEl.className = 'text-red-600 text-sm mt-2 h-4';
                 return;
            }
            try {
                const playlistData = {
                    title: title,
                    playlistId: youtubeData.id,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('videoPlaylists').add(playlistData);
                messageEl.textContent = 'Playlist added successfully!';
                messageEl.className = 'text-green-600 text-sm mt-2 h-4';
                form.reset();
                setTimeout(() => messageEl.textContent = '', 3000);
            } catch (error) {
                console.error("Error adding playlist:", error);
                messageEl.textContent = 'An error occurred. Please try again.';
                messageEl.className = 'text-red-600 text-sm mt-2 h-4';
            }
        }
        function editPlaylist(id, currentTitle) {
            if (currentUser.role !== 'admin') return;
            const modal = document.getElementById('confirmation-modal');
            modal.innerHTML = `
                <div class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl w-full max-w-md p-6 fade-in">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">Edit Playlist</h3>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input id="edit-playlist-title" class="w-full px-3 py-2 rounded-lg border border-gray-300/60 bg-white/70 focus:outline-none focus:ring-2 focus:ring-blue-500" value="${currentTitle}" />
                    <p class="text-xs text-gray-500 mt-2">Playlist ID cannot be changed here. To replace a playlist, delete and add a new one.</p>
                    <div class="flex justify-end gap-2 mt-4">
                        <button id="edit-cancel" class="px-4 py-2 rounded-md bg-gray-200 text-gray-800 font-semibold hover:bg-gray-300">Cancel</button>
                        <button id="edit-save" class="px-4 py-2 rounded-md bg-blue-600 text-white font-semibold hover:bg-blue-700">Save</button>
                    </div>
                </div>`;
            modal.style.display = 'flex';
            document.getElementById('edit-cancel').onclick = () => { modal.style.display = 'none'; };
            document.getElementById('edit-save').onclick = async () => {
                const newTitle = document.getElementById('edit-playlist-title').value.trim();
                if (!newTitle) return;
                try {
                    await db.collection('videoPlaylists').doc(id).update({ title: newTitle, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                    showToast('Playlist updated', 'success');
                    modal.style.display = 'none';
                } catch (e) {
                    console.error('Update failed', e);
                    showToast('Could not update playlist', 'error');
                }
            };
        }
        function deletePlaylist(id) {
            if (currentUser.role !== 'admin') return;
            showConfirmationModal('Delete this playlist?', async () => {
                try {
                    await db.collection('videoPlaylists').doc(id).delete();
                    showToast('Playlist deleted', 'success');
                } catch (e) {
                    console.error('Delete failed', e);
                    showToast('Could not delete playlist', 'error');
                }
            }, { okText: 'Delete' });
        }
        function handlePlaylistClick(playlist) {
            if (currentUser.tier === 'free') {
                document.getElementById('upgrade-modal-message').textContent = 'To watch revision video playlists, please upgrade to our Pro plan.';
                document.getElementById('upgrade-modal').style.display = 'flex';
                return;
            }
            showPlaylistViewer(playlist);
        }
        function showPlaylistViewer(playlist) {
            const modal = document.getElementById('playlist-viewer-modal');
            modal.innerHTML = `
                <div class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl w-full max-w-4xl flex flex-col fade-in max-h-[90vh]">
                    <div class="p-4 border-b border-gray-200/50 flex justify-between items-center">
                        <div class="flex items-center gap-2 min-w-0">
                            <img src="gcsemate%20new.png" alt="GCSEMate" class="h-6 w-auto hidden sm:block">
                            <h3 class="text-lg font-semibold text-gray-800 truncate">${playlist.title}</h3>
                        </div>
                        <button onclick="document.getElementById('playlist-viewer-modal').style.display='none'; document.getElementById('playlist-viewer-modal').innerHTML='';" class="text-2xl font-bold text-gray-500 hover:text-gray-800 p-1 leading-none" data-tooltip="Close">×</button>
                    </div>
                    <div class="aspect-w-16 aspect-h-9 bg-black">
                        <iframe 
                            src="https://www.youtube.com/embed/videoseries?list=${playlist.playlistId}" 
                            title="YouTube video player" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                            allowfullscreen>
                        </iframe>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }
        // =================================================================================
        // USEFUL LINKS LOGIC (SHARED PARSER)
        // =================================================================================
        
        function parseYoutubeUrl(url) {
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname.includes('youtube.com') || urlObj.hostname.includes('youtu.be')) {
                    const playlistId = urlObj.searchParams.get('list');
                    if (playlistId) {
                        return { type: 'youtube_playlist', id: playlistId, embedUrl: `https://www.youtube.com/embed/videoseries?list=${playlistId}` };
                    }
                    let videoId = urlObj.searchParams.get('v');
                    if (!videoId && urlObj.hostname === 'youtu.be') videoId = urlObj.pathname.slice(1);
                    if (videoId) {
                        return { type: 'youtube_video', id: videoId, embedUrl: `https://www.youtube.com/embed/${videoId}` };
                    }
                }
            } catch (e) { console.error("Could not parse URL", e); }
            return null;
        }
        async function handleAddLink() {
            if (currentUser.role !== 'admin') return;
            const titleInput = document.getElementById('link-title');
            const urlInput = document.getElementById('link-url');
            const messageEl = document.getElementById('add-link-message');
            const title = titleInput.value.trim();
            const url = urlInput.value.trim();
            if (!title || !url) {
                messageEl.textContent = 'Please fill in both title and URL.';
                messageEl.className = 'text-red-600 text-sm mt-2 h-4';
                return;
            }
            try {
                new URL(url); // Validate URL
                const youtubeData = parseYoutubeUrl(url);
                const linkData = {
                    title,
                    url,
                    type: youtubeData ? youtubeData.type : 'link',
                    embedUrl: youtubeData ? youtubeData.embedUrl : null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('usefulLinks').add(linkData);
                messageEl.textContent = 'Link added successfully!';
                messageEl.className = 'text-green-600 text-sm mt-2 h-4';
                titleInput.value = '';
                urlInput.value = '';
                setTimeout(() => messageEl.textContent = '', 3000);
            } catch (error) {
                console.error("Error adding link:", error);
                messageEl.textContent = 'Please enter a valid URL.';
                messageEl.className = 'text-red-600 text-sm mt-2 h-4';
            }
        }
        async function handleRemoveLink(id) {
            if (currentUser.role !== 'admin') return;
             showConfirmationModal('Are you sure you want to delete this link?', async () => {
                try {
                    await db.collection('usefulLinks').doc(id).delete();
                    showToast('Link removed.', 'success');
                } catch (error) {
                    console.error("Error removing link:", error);
                    showToast("Could not remove the link.", 'error');
                }
            });
        }
        function renderUsefulLinks(usefulLinks) {
            const linksContainer = document.getElementById('links-container');
            linksContainer.innerHTML = '';
            if (Object.keys(usefulLinks).length === 0) {
                linksContainer.innerHTML = `<div class="text-center text-gray-500 p-10"><h3 class="mt-4 text-lg font-bold text-gray-700">No Links Yet</h3></div>`;
                return;
            }
            
            Object.entries(usefulLinks).forEach(([id, link]) => {
                const linkElement = document.createElement('div');
                linkElement.className = 'p-4 rounded-lg bg-gray-100/50';
                let contentHTML = '';
                const removeBtn = currentUser.role === 'admin' ? `<button onclick="handleRemoveLink('${id}')" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition-colors" data-tooltip="Remove link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>` : '';
                if (link.type === 'youtube_video' || link.type === 'youtube_playlist') {
                    const sep = (link.embedUrl || '').includes('?') ? '&' : '?';
                    const finalUrl = `${link.embedUrl}${sep}modestbranding=1&rel=0&playsinline=1&iv_load_policy=3&color=white&fs=0`;
                    contentHTML = `<div class="flex justify-between items-start mb-3"><span class="font-bold text-lg text-gray-800">${link.title}</span>${removeBtn}</div>
                        <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden shadow-md video-brand-wrapper">
                            <iframe src="${finalUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" class="w-full h-full"></iframe>
                            <div class="video-brand-watermark"><img src="gcsemate%20new.png" alt="GCSEMate" class="h-6 w-auto opacity-80"></div>
                            <div class="video-brand-controls"><button onclick="handleVideoWrapperFullscreen(this)" class="px-2 py-1 rounded-md bg-white/20 hover:bg-white/30 text-white border border-white/20 transition-colors" aria-label="Fullscreen"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 3H5a2 2 0 00-2 2v3m0 8v3a2 2 0 002 2h3m8-16h3a2 2 0 012 2v3m0 8v3a2 2 0 01-2 2h-3"/></svg></button></div>
                        </div>`;
                } else {
                    contentHTML = `<div class="flex items-center justify-between"><a href="${link.url}" target="_blank" rel="noopener noreferrer" class="flex items-center min-w-0"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3 text-blue-600 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg><span class="font-semibold text-gray-800 truncate" data-tooltip="${link.url}">${link.title}</span></a>${removeBtn}</div>`;
                }
                linkElement.innerHTML = contentHTML;
                linksContainer.appendChild(linkElement);
            });
            initializeTooltips();
        }
        // =================================================================================
        // CALENDAR LOGIC
        // =================================================================================
        let calendarUserEvents = {};
        let calendarGlobalEvents = {};
        function renderCalendar(userEvents, globalEvents) {
            if (userEvents) calendarUserEvents = userEvents;
            if (globalEvents) calendarGlobalEvents = globalEvents;
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearHeader = document.getElementById('month-year-header');
            const yearSelect = document.getElementById('calendar-year-select');
            if (!calendarGrid || !monthYearHeader) return;
            calendarGrid.innerHTML = '';
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            monthYearHeader.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
            // Populate year dropdown around current year
            if (yearSelect && yearSelect.childElementCount === 0) {
                const base = new Date().getFullYear();
                for (let y = base - 2; y <= base + 3; y++) {
                    const opt = document.createElement('option');
                    opt.value = String(y);
                    opt.textContent = String(y);
                    yearSelect.appendChild(opt);
                }
                yearSelect.value = String(year);
                yearSelect.addEventListener('change', () => {
                    const newYear = parseInt(yearSelect.value, 10);
                    currentDate.setFullYear(newYear);
                    renderCalendar(calendarUserEvents, calendarGlobalEvents);
                });
            } else if (yearSelect) {
                yearSelect.value = String(year);
            }
            
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'text-center font-semibold text-gray-600 text-sm py-2';
                dayEl.textContent = day;
                calendarGrid.appendChild(dayEl);
            });
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) calendarGrid.appendChild(document.createElement('div'));
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayEl.className = 'calendar-day text-center py-4 border-t border-l border-gray-200/50 cursor-pointer hover:bg-blue-100/50 transition-colors';
                dayEl.textContent = day;
                dayEl.dataset.date = dateKey;
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayEl.classList.add('today');
                }
                
                if ((calendarUserEvents[dateKey] && calendarUserEvents[dateKey].length > 0) || (calendarGlobalEvents[dateKey] && calendarGlobalEvents[dateKey].length > 0)) {
                    dayEl.classList.add('has-event');
                    if (calendarGlobalEvents[dateKey] && calendarGlobalEvents[dateKey].length > 0) {
                        dayEl.classList.add('has-global-event');
                    }
                }
                
                dayEl.addEventListener('click', () => openEventModal(dateKey));
                calendarGrid.appendChild(dayEl);
            }
            updateCountdownBanner();
        }
        
        // =================================================================================
        // BLOG LOGIC
        // =================================================================================
        function renderBlogPage(posts) {
            const grid = document.getElementById('blog-post-grid');
            if (!grid) return;
            grid.innerHTML = '';
            if (!posts || posts.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500 p-10"><h3 class="mt-4 text-lg font-bold text-gray-700">No Blog Posts Yet</h3><p class="mt-1 text-sm text-gray-500">Check back later for news and revision tips.</p></div>`;
                return;
            }
            posts.forEach(post => {
                const card = document.createElement('div');
                card.className = 'bg-white/50 border border-white/30 backdrop-blur-lg rounded-xl shadow-lg flex flex-col overflow-hidden';
                const contentPreview = post.content.replace(/<[^>]+>/g, '').substring(0, 100);
                const postDate = post.createdAt?.toDate ? post.createdAt.toDate().toLocaleDateString('en-GB') : 'Just now';
                let adminButtons = '';
                if(currentUser.role === 'admin') {
                    adminButtons = `
                        <div class="absolute top-2 right-2 flex gap-1">
                            <button onclick="event.stopPropagation(); editBlogPost('${post.id}')" class="p-1.5 bg-blue-500/80 text-white rounded-full hover:bg-blue-600 transition-colors" data-tooltip="Edit Post">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" /></svg>
                            </button>
                            <button onclick="event.stopPropagation(); deleteBlogPost('${post.id}')" class="p-1.5 bg-red-500/80 text-white rounded-full hover:bg-red-600 transition-colors" data-tooltip="Delete Post">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    `;
                }
                card.innerHTML = `
                    <div class="relative cursor-pointer" onclick="showBlogPostViewer('${post.id}')">
                        ${post.image ? `<img src="${post.image}" alt="${post.title}" class="w-full h-48 object-cover" loading="lazy" decoding="async">` : '<img src="https://images.unsplash.com/photo-1519682337058-a94d519337bc?q=80&w=1600&auto=format&fit=crop" alt="Study desk" class="w-full h-48 object-cover" loading="lazy" decoding="async">'}
                        <div class="p-6 flex-grow flex flex-col">
                            <div class="flex items-start justify-between gap-2 mb-2">
                                <h3 class="text-xl font-bold text-gray-900">${post.title}</h3>
                                <span class="comment-badge text-xs bg-blue-100 text-blue-700 font-semibold px-2 py-1 rounded-full whitespace-nowrap" data-post-id="${post.id}">0 comments</span>
                            </div>
                            <p class="text-gray-600 text-sm flex-grow">${contentPreview}...</p>
                            <p class="text-xs text-gray-500 mt-4">${postDate}</p>
                        </div>
                        ${adminButtons}
                    </div>
                `;
                grid.appendChild(card);
            });
            // Fetch comment counts (lightweight) and animate badges
            try {
                posts.forEach(async (p, i) => {
                    try {
                        const snap = await db.collection('blogPosts').doc(p.id).collection('comments').get();
                        const n = snap.size || 0;
                        const badge = grid.querySelector(`.comment-badge[data-post-id="${p.id}"]`);
                        if (badge) {
                            badge.textContent = n === 1 ? '1 comment' : `${n} comments`;
                            badge.style.transform = 'scale(0.9)';
                            badge.style.transition = 'transform 200ms ease';
                            setTimeout(() => { badge.style.transform = 'scale(1)'; }, 20 + i * 15);
                        }
                    } catch (_) {}
                });
            } catch (_) {}
            initializeTooltips();
        }
        
        async function handleSaveBlogPost() {
            if (currentUser.role !== 'admin') return;
            
            const postId = document.getElementById('blog-post-id').value;
            const title = document.getElementById('blog-post-title').value.trim();
            const content = document.getElementById('blog-post-content').value.trim();
            const image = document.getElementById('blog-post-image').value.trim();
            const messageEl = document.getElementById('add-blog-post-message');
            if (!title || !content) {
                messageEl.textContent = "Title and content are required.";
                messageEl.className = 'text-red-600 text-sm mt-2 h-4';
                return;
            }
            const postData = {
                title,
                content,
                image: image || null,
                authorId: currentUser.uid,
                authorName: currentUser.displayName,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            };
            try {
                if (postId) { // Update existing post
                    await db.collection('blogPosts').doc(postId).update(postData);
                } else { // Create new post
                    postData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('blogPosts').add(postData);
                }
                resetBlogPostForm();
                messageEl.textContent = "Blog post saved successfully!";
                messageEl.className = 'text-green-600 text-sm mt-2 h-4';
                setTimeout(() => messageEl.textContent = '', 3000);
            } catch (error) {
                console.error("Error saving blog post:", error);
                messageEl.textContent = "An error occurred. Please try again.";
                messageEl.className = 'text-red-600 text-sm mt-2 h-4';
            }
        }
        function resetBlogPostForm() {
            document.getElementById('add-blog-post-form').reset();
            document.getElementById('blog-post-id').value = '';
            document.getElementById('blog-form-title').textContent = 'Create New Blog Post';
        }
        function editBlogPost(postId) {
            const post = allBlogPosts.find(p => p.id === postId);
            if (!post) return;
            
            document.getElementById('blog-form-title').textContent = 'Edit Blog Post';
            document.getElementById('blog-post-id').value = post.id;
            document.getElementById('blog-post-title').value = post.title;
            document.getElementById('blog-post-content').value = post.content;
            document.getElementById('blog-post-image').value = post.image || '';
            document.getElementById('add-blog-post-form-container').scrollIntoView({ behavior: 'smooth' });
        }
        async function deleteBlogPost(postId) {
            if (currentUser.role !== 'admin') return;
            showConfirmationModal('Are you sure you want to delete this blog post? This cannot be undone.', async () => {
                try {
                    await db.collection('blogPosts').doc(postId).delete();
                    showToast('Blog post deleted.', 'success');
                } catch (error) {
                    console.error("Error deleting blog post:", error);
                    showToast("Could not delete blog post.", 'error');
                }
            });
        }
        function handleCloseBlogViewer() {
            const modal = document.getElementById('blog-viewer-modal');
            if (modal) {
                modal.style.display = 'none';
                modal.innerHTML = '';
            }
            if (unsubscribeBlogComments) { try { unsubscribeBlogComments(); } catch (_) {} unsubscribeBlogComments = null; }
        }

        function showBlogPostViewer(postId) {
            const post = allBlogPosts.find(p => p.id === postId);
            if (!post) return;
            const modal = document.getElementById('blog-viewer-modal');
            const postDate = post.createdAt?.toDate ? post.createdAt.toDate().toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' }) : '';
            modal.innerHTML = `
                <div class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl w-full max-w-4xl flex flex-col fade-in max-h-[90vh]">
                    <div class="p-4 border-b border-gray-200/50 flex justify-between items-center">
                        <div class="flex items-center gap-2 min-w-0">
                            <img src="gcsemate%20new.png" alt="GCSEMate" class="h-6 w-auto hidden sm:block">
                            <h3 class="text-lg font-semibold text-gray-800 truncate">${post.title}</h3>
                        </div>
                        <button onclick="handleCloseBlogViewer()" class="text-2xl font-bold text-gray-500 hover:text-gray-800 p-1 leading-none" data-tooltip="Close">×</button>
                    </div>
                    <div class="overflow-y-auto">
                        ${post.image ? `<img src="${post.image}" alt="${post.title}" class="w-full h-72 object-cover" loading="lazy" decoding="async">` : ''}
                        <div class="p-8 prose prose-lg max-w-none">
                            <p class="text-sm text-gray-500">Posted on ${postDate} by ${post.authorName}</p>
                            ${post.content}
                            <div class="mt-6 flex items-center gap-2">
                                <button class="px-3 py-1.5 rounded-md bg-gray-100 hover:bg-gray-200 text-sm font-semibold" onclick="navigator.share ? navigator.share({ title: '${post.title.replace(/'/g, "\'")}', url: location.href }) : window.open(location.href, '_blank')">Share</button>
                            </div>
                        </div>
                        <div class="px-8 pb-8">
                            <h4 class="text-xl font-bold text-gray-800 mb-3">Comments</h4>
                            <div id="comments-list" class="space-y-4"></div>
                            ${ (currentUser?.tier === 'paid' || (currentUser?.role||'').toLowerCase() === 'admin') ? `
                            <form id="add-comment-form" class="mt-4 space-y-2">
                                <textarea id="comment-input" class="w-full p-3 rounded-lg border border-gray-300/60 bg-white/70 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Write a comment..." rows="3" required></textarea>
                                <div class="flex justify-end">
                                    <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white font-semibold hover:bg-blue-700">Post Comment</button>
                                </div>
                                <p id="add-comment-message" class="text-sm h-4"></p>
                            </form>` : `
                            <div class="mt-2 text-sm text-gray-600 bg-gray-50 border border-gray-200 rounded-lg p-3">Comments are available to Pro users. <a href="#" class="text-blue-600 font-semibold" onclick="showPage('features-page')">Upgrade to Pro</a> to join the discussion.</div>`}
                        </div>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';

            // Comments realtime listener
            if (unsubscribeBlogComments) { try { unsubscribeBlogComments(); } catch (_) {} }
            unsubscribeBlogComments = db.collection('blogPosts').doc(postId).collection('comments')
                .orderBy('createdAt', 'asc')
                .onSnapshot(snapshot => {
                    const comments = [];
                    snapshot.forEach(doc => comments.push({ id: doc.id, ...doc.data() }));
                    const list = document.getElementById('comments-list');
                    if (!list) return;
                    if (comments.length === 0) {
                        list.innerHTML = `<div class="text-sm text-gray-500">No comments yet. Be the first to comment!</div>`;
                        return;
                    }
                    list.innerHTML = comments.map(c => {
                        const name = escapeHtml(c.authorName || 'User');
                        const text = escapeHtml(c.text || '');
                        const when = c.createdAt?.toDate ? c.createdAt.toDate() : null;
                        const whenRel = when ? timeAgo(when) : '';
                        const canModerate = (currentUser?.role || '').toLowerCase() === 'admin';
                        const canEdit = currentUser && (canModerate || c.authorId === currentUser.uid);
                        return `<div class="bg-white/70 border border-white/40 rounded-lg p-3" data-comment-id="${c.id}">
                            <div class="flex items-center justify-between mb-1">
                                <div class="text-xs text-gray-500">${name} • ${whenRel}</div>
                                ${canEdit ? `<div class="flex items-center gap-2 text-xs">
                                    <button class="comment-edit px-2 py-1 rounded bg-gray-200 hover:bg-gray-300 text-gray-800">Edit</button>
                                    ${canModerate || c.authorId === currentUser.uid ? `<button class="comment-delete px-2 py-1 rounded bg-red-600 text-white hover:bg-red-700">Delete</button>` : ''}
                                </div>` : ''}
                            </div>
                            <div class="text-gray-800 whitespace-pre-wrap comment-text">${text}</div>
                        </div>`;
                    }).join('');

                    // Wire edit/delete actions
                    const listRoot = document.getElementById('comments-list');
                    if (!listRoot) return;
                    listRoot.querySelectorAll('.comment-edit').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const card = e.target.closest('[data-comment-id]');
                            const id = card.getAttribute('data-comment-id');
                            const textEl = card.querySelector('.comment-text');
                            const original = textEl.textContent;
                            const ta = document.createElement('textarea');
                            ta.className = 'w-full p-2 rounded border border-gray-300/60 bg-white/70 mt-1';
                            ta.value = original;
                            const actions = document.createElement('div');
                            actions.className = 'mt-2 flex justify-end gap-2';
                            actions.innerHTML = `<button class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Cancel</button><button class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>`;
                            const [cancelBtn, saveBtn] = actions.children;
                            const parent = textEl.parentElement;
                            textEl.replaceWith(ta);
                            parent.appendChild(actions);
                            cancelBtn.addEventListener('click', () => {
                                actions.remove();
                                ta.replaceWith(textEl);
                            });
                            saveBtn.addEventListener('click', async () => {
                                const newText = ta.value.trim();
                                if (!newText) return;
                                try {
                                    await db.collection('blogPosts').doc(postId).collection('comments').doc(id).update({ text: newText, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                                } catch (err) { console.error('Edit failed', err); }
                            });
                        });
                    });

                    listRoot.querySelectorAll('.comment-delete').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const card = e.target.closest('[data-comment-id]');
                            const id = card.getAttribute('data-comment-id');
                            showConfirmationModal('Delete this comment?', async () => {
                                try {
                                    await db.collection('blogPosts').doc(postId).collection('comments').doc(id).delete();
                                    showToast('Comment deleted', 'success');
                                } catch (err) {
                                    console.error('Delete failed', err);
                                    showToast('Could not delete comment', 'error');
                                }
                            }, { okText: 'Delete' });
                        });
                    });
                }, err => console.error('Error fetching comments:', err));

            // Add comment handler (paid/admin only)
            const form = document.getElementById('add-comment-form');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const textarea = document.getElementById('comment-input');
                    const messageEl = document.getElementById('add-comment-message');
                    const text = (textarea.value || '').trim();
                    messageEl.textContent = '';
                    if (!text) return;
                    const allowed = (currentUser?.tier === 'paid') || ((currentUser?.role || '').toLowerCase() === 'admin');
                    if (!allowed) {
                        messageEl.textContent = 'Only Pro users can comment.';
                        messageEl.className = 'text-red-600 text-sm h-4';
                        return;
                    }
                    try {
                        await db.collection('blogPosts').doc(postId).collection('comments').add({
                            text,
                            authorId: currentUser.uid,
                            authorName: currentUser.displayName || currentUser.email || 'User',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        textarea.value = '';
                        messageEl.textContent = 'Comment posted!';
                        messageEl.className = 'text-green-600 text-sm h-4';
                        setTimeout(() => { if (messageEl) messageEl.textContent=''; }, 2000);
                    } catch (error) {
                        console.error('Error posting comment:', error);
                        messageEl.textContent = 'Could not post comment.';
                        messageEl.className = 'text-red-600 text-sm h-4';
                    }
                });
            }
        }
        // =================================================================================
        // MODAL, UTILITY & NEW FEATURE FUNCTIONS
        // =================================================================================
        async function logClientAccess() {
            try {
                // Use Cloudflare trace (no API key) if available
                const getTraceText = async () => {
                    try { return await fetch('/cdn-cgi/trace', { cache: 'no-store' }).then(r => r.text()); } catch (_) {}
                    try { return await fetch('https://www.cloudflare.com/cdn-cgi/trace', { cache: 'no-store' }).then(r => r.text()); } catch (_) {}
                    return '';
                };
                const txt = await getTraceText();
                const map = {};
                txt.split('\n').forEach(line => { const i = line.indexOf('='); if (i>0) map[line.slice(0,i)] = line.slice(i+1); });
                const ua = navigator.userAgent || '';
                const payload = {
                    uid: currentUser?.uid || null,
                    email: currentUser?.email || null,
                    ip: map.ip || null,
                    ipInfo: {
                        ip: map.ip || null,
                        country: map.loc || null,
                        country_code: map.loc || null,
                        city: null,
                        region: null,
                        latitude: null,
                        longitude: null,
                        org: null,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || null,
                        colo: map.colo || null
                    },
                    userAgent: ua,
                    screen: { w: window.screen.width, h: window.screen.height, dpr: window.devicePixelRatio || 1 },
                    accessedAt: new Date().toISOString()
                };
                try { await db.collection('accessLogs').add(payload); } catch(_) {}
                try { if (currentUser?.uid) await db.collection('users').doc(currentUser.uid).set({ lastAccess: payload.accessedAt, ipInfo: payload.ipInfo }, { merge: true }); } catch(_) {}
            } catch (e) { console.warn('Access log failed', e); }
        }
        // Toast notifications (success, error, warning) rendered top-center
        function showToast(message, type = 'success', options = {}) {
            const { duration = 3500, title } = options;
            const container = document.getElementById('toast-container');
            if (!container) return alert(message);
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.setAttribute('role', 'status');
            toast.setAttribute('aria-live', 'polite');
            toast.innerHTML = title ? `<div class="font-bold mb-0.5">${title}</div><div>${message}</div>` : message;
            container.appendChild(toast);
            const timeout = setTimeout(() => toast.remove(), duration);
            toast.addEventListener('click', () => { clearTimeout(timeout); toast.remove(); });
        }

        function initializeTooltips() {
            // Delegate tooltip handling to the document to cover dynamically added elements
            let tooltipElement = null;
            let hideTimeout = null;

            function showTooltip(target) {
                const text = target.getAttribute('data-tooltip');
                if (!text) return;
                if (hideTimeout) { clearTimeout(hideTimeout); hideTimeout = null; }
                if (!tooltipElement) {
                    tooltipElement = document.createElement('div');
                    tooltipElement.className = 'custom-tooltip';
                    document.body.appendChild(tooltipElement);
                }
                tooltipElement.textContent = text;
                tooltipElement.classList.remove('show');
                tooltipElement.style.opacity = '0';
                const targetRect = target.getBoundingClientRect();
                // Pre-measure
                tooltipElement.style.top = '-9999px';
                tooltipElement.style.left = '-9999px';
                const tooltipRect = tooltipElement.getBoundingClientRect();
                let top = targetRect.top - tooltipRect.height - 8 + window.scrollY;
                let left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2) + window.scrollX;
                if (top < window.scrollY) top = targetRect.bottom + 8 + window.scrollY;
                if (left < window.scrollX) left = window.scrollX + 5;
                const maxLeft = window.scrollX + window.innerWidth - tooltipRect.width - 5;
                if (left > maxLeft) left = maxLeft;
                tooltipElement.style.top = `${top}px`;
                tooltipElement.style.left = `${left}px`;
                // Animate in
                requestAnimationFrame(() => tooltipElement.classList.add('show'));
            }

            function hideTooltip() {
                if (!tooltipElement) return;
                tooltipElement.classList.remove('show');
                hideTimeout = setTimeout(() => {
                    if (tooltipElement) {
                        tooltipElement.remove();
                        tooltipElement = null;
                    }
                }, 180);
            }

            document.addEventListener('mouseover', (e) => {
                const target = e.target.closest('[data-tooltip]');
                if (target) showTooltip(target);
            });
            document.addEventListener('mouseout', (e) => {
                const from = e.target.closest('[data-tooltip]');
                const to = e.relatedTarget && e.relatedTarget.closest ? e.relatedTarget.closest('[data-tooltip]') : null;
                if (from && from !== to) hideTooltip();
            });
            window.addEventListener('scroll', () => hideTooltip(), { passive: true });
            window.addEventListener('resize', () => hideTooltip());
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideTooltip(); });
        }

        // Dynamic document title per page
        const pageTitles = {
            'subject-dashboard-page': 'Subjects - GCSEMate',
            'videos-page': 'Videos - GCSEMate',
            'blog-page': 'Blog - GCSEMate',
            'calendar-page': 'Calendar - GCSEMate',
            'useful-links-page': 'Useful Links - GCSEMate',
            'file-browser-page': 'Files - GCSEMate',
            'account-settings-page': 'Account - GCSEMate',
            'about-page': 'About - GCSEMate',
            'gcsemategpt-page': 'GCSEMateGPT - GCSEMate',
            'features-page': 'Features & Pricing - GCSEMate',
            'help-page': 'Help/FAQ - GCSEMate',
            'checkout-page': 'Upgrade - GCSEMate'
        };

        function initializeFaqAccordion() {
            const faqContainer = document.getElementById('faq-container');
            if (!faqContainer) return;
            // Accordion expand/collapse with dynamic height
            faqContainer.addEventListener('click', (e) => {
                const questionHeader = e.target.closest('.faq-question');
                if (!questionHeader) return;
                const faqItem = questionHeader.parentElement;
                const answer = faqItem.querySelector('.faq-answer');
                if (!answer) return;
                const isOpen = faqItem.classList.contains('open');

                // Close others for an accordion behavior
                faqContainer.querySelectorAll('.faq-item.open').forEach(openItem => {
                    if (openItem !== faqItem) {
                        const openAnswer = openItem.querySelector('.faq-answer');
                        if (openAnswer) {
                            openAnswer.style.maxHeight = '0px';
                            openAnswer.style.paddingBottom = '0px';
                            openItem.classList.remove('open');
                        }
                    }
                });

                if (!isOpen) {
                    faqItem.classList.add('open');
                    // Set padding first, then measure height so content isn't cut off.
                    // Use a temp auto height to get true content height for transitions.
                    answer.style.paddingBottom = '1.25rem';
                    answer.style.maxHeight = 'none';
                    const full = answer.scrollHeight;
                    answer.style.maxHeight = '0px';
                    // Next frame set to measured height to animate
                    requestAnimationFrame(() => { answer.style.maxHeight = full + 'px'; });
                } else {
                    answer.style.maxHeight = '0px';
                    answer.style.paddingBottom = '0px';
                    faqItem.classList.remove('open');
                }
            });

            // Initialize: force closed state first, then compute size on click for accuracy
            faqContainer.querySelectorAll('.faq-answer').forEach(ans => {
                ans.style.maxHeight = '0px';
                ans.style.paddingBottom = '0px';
            });
        }
        function showConfirmationModal(message, onConfirm, options = {}) {
            const { okText = 'OK', cancelText = 'Cancel', showCancel = true } = options;
            const modal = document.getElementById('confirmation-modal');
            modal.innerHTML = `
                <div class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl w-full max-w-sm p-6 text-center fade-in">
                    <p class="text-lg font-semibold text-gray-800 mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        ${showCancel ? `<button id="confirm-cancel" class="px-6 py-2 bg-gray-200 text-gray-800 font-bold rounded-md hover:bg-gray-300">${cancelText}</button>` : ''}
                        <button id="confirm-yes" class="px-6 py-2 bg-red-600 text-white font-bold rounded-md hover:bg-red-700">${okText}</button>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
            document.getElementById('confirm-yes').onclick = () => {
                onConfirm();
                modal.style.display = 'none';
            };
            if (showCancel) {
                document.getElementById('confirm-cancel').onclick = () => {
                    modal.style.display = 'none';
                };
            }
        }

        function showDeleteAccountModal() {
            showConfirmationModal(
                'Are you sure you want to permanently delete your account? This action cannot be undone.',
                handleDeleteAccount,
                { okText: 'Delete Account' }
            );
        }

        async function handleDeleteAccount() {
            if (!currentUser) return;
            try {
                const userId = currentUser.uid;
                // First delete Firestore document
                await db.collection('users').doc(userId).delete();
                // Then delete auth user
                await auth.currentUser.delete();
                showToast('Your account has been successfully deleted.', 'success');
                // onAuthStateChanged will handle the UI redirect
            } catch (error) {
                console.error("Account deletion failed:", error);
                showToast(`Error deleting account: ${error.message}`, 'error');
                // Handle re-authentication if needed
                if (error.code === 'auth/requires-recent-login') {
                    showToast('Please log out and log back in to delete your account.', 'error');
                }
            }
        }
        function showTermsOfServiceModal() {
            const modal = document.getElementById('legal-modal');
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl w-full max-w-2xl flex flex-col fade-in max-h-[90vh]">
                     <div class="p-4 border-b border-gray-200/50 flex justify-between items-center">
                         <h3 class="text-lg font-semibold text-gray-800">Terms of Service</h3>
                         <button onclick="document.getElementById('legal-modal').style.display='none'" class="text-2xl font-bold text-gray-500 hover:text-gray-800 p-1 leading-none" data-tooltip="Close">×</button>
                     </div>
                     <div class="p-6 space-y-4 overflow-y-auto prose">
                        <p>Welcome to GCSEMate. By accessing or using our website and services, you agree to be bound by these Terms of Service. If you do not agree, do not use the service.</p>
                        <h4 class="font-bold">1. Eligibility and Acceptance</h4>
                        <p>You must be able to enter into a legally binding agreement to use GCSEMate. If you are under 18, you represent that you have consent from a parent or guardian.</p>
                        <h4 class="font-bold">2. Accounts and Security</h4>
                        <ul>
                            <li>You are responsible for maintaining the confidentiality of your login credentials and for all activity under your account.</li>
                            <li>Notify us immediately at <a href="mailto:admin@gcsemate.com">admin@gcsemate.com</a> of any unauthorized use or security breach.</li>
                        </ul>
                        <h4 class="font-bold">3. Subscription and Payment</h4>
                        <ul>
                            <li>Some features require a paid subscription ("Pro"). Pricing is displayed within the app.</li>
                            <li>Payments are handled off-platform by arrangement. Access is provisioned after confirmation.</li>
                            <li>We may change pricing with reasonable prior notice.</li>
                        </ul>
                        <h4 class="font-bold">4. Acceptable Use</h4>
                        <ul>
                            <li>Do not misuse the service, including attempting to gain unauthorized access, scraping, automated bulk access, or interfering with normal operation.</li>
                            <li>Do not upload or distribute illegal, infringing, or harmful content.</li>
                        </ul>
                        <h4 class="font-bold">5. Educational Content and Third‑Party Services</h4>
                        <p>We organize links and previews to third‑party resources such as Google Drive and YouTube. GCSEMate does not own or control third‑party content and is not responsible for its availability, accuracy, or policies.</p>
                        <h4 class="font-bold">6. Intellectual Property</h4>
                        <p>All trademarks, branding, UI, and original content on GCSEMate are owned by us or our licensors. You may not copy, modify, distribute, or create derivative works except as permitted by law or with our prior written consent.</p>
                        <h4 class="font-bold">7. User Feedback</h4>
                        <p>If you provide feedback or suggestions, you grant us a non‑exclusive, worldwide, royalty‑free license to use it for any purpose.</p>
                        <h4 class="font-bold">8. DMCA and Content Removal</h4>
                        <p>We comply with applicable copyright law. See our DMCA policy for details on submitting notices. We may remove content alleged to infringe and terminate repeat infringers.</p>
                        <h4 class="font-bold">9. Termination</h4>
                        <p>We may suspend or terminate your access at any time for any reason, including breach of these terms. You may stop using the service at any time. Account deletion removes associated personal data as described in the Privacy Policy.</p>
                        <h4 class="font-bold">10. Disclaimers</h4>
                        <p>GCSEMate is provided on an "AS IS" and "AS AVAILABLE" basis. We do not warrant uninterrupted, error‑free service or accuracy of content. Your use is at your own risk.</p>
                        <h4 class="font-bold">11. Limitation of Liability</h4>
                        <p>To the fullest extent permitted by law, GCSEMate and its affiliates shall not be liable for any indirect, incidental, special, consequential, or exemplary damages, or loss of data, profits, or goodwill.</p>
                        <h4 class="font-bold">12. Indemnification</h4>
                        <p>You agree to defend, indemnify, and hold harmless GCSEMate from claims arising out of your use of the service or violation of these terms.</p>
                        <h4 class="font-bold">13. Changes to the Service and Terms</h4>
                        <p>We may modify the service or these terms at any time. Continued use after changes constitute acceptance. Material changes will be communicated via the app or email.</p>
                        <h4 class="font-bold">14. Governing Law</h4>
                        <p>These terms are governed by the laws of England and Wales. Courts located in England shall have exclusive jurisdiction, except where applicable law provides otherwise.</p>
                        <h4 class="font-bold">15. Contact</h4>
                        <p>Questions? Contact <a href="mailto:admin@gcsemate.com">admin@gcsemate.com</a>.</p>
                        <p><em>Last updated: August 2025</em></p>
                     </div>
                </div>`;
        }
        function showPrivacyPolicyModal() {
            const modal = document.getElementById('legal-modal');
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl w-full max-w-2xl flex flex-col fade-in max-h-[90vh]">
                     <div class="p-4 border-b border-gray-200/50 flex justify-between items-center">
                         <h3 class="text-lg font-semibold text-gray-800">Privacy Policy</h3>
                         <button onclick="document.getElementById('legal-modal').style.display='none'" class="text-2xl font-bold text-gray-500 hover:text-gray-800 p-1 leading-none" data-tooltip="Close">×</button>
                     </div>
                     <div class="p-6 space-y-4 overflow-y-auto prose">
                        <p>This Privacy Policy explains how GCSEMate ("we", "us") collects, uses, and shares your information when you use our website and services.</p>
                        <h4 class="font-bold">1. Data Controller</h4>
                        <p>The data controller is GCSEMate. Contact: <a href="mailto:admin@gcsemate.com">admin@gcsemate.com</a>.</p>
                        <h4 class="font-bold">2. Information We Collect</h4>
                        <ul>
                            <li><strong>Account Information</strong>: display name, email address, subscription tier, role, allowed subjects.</li>
                            <li><strong>Usage Data</strong>: actions within the app (e.g., starred files, calendar events), pages viewed, timestamps.</li>
                            <li><strong>Device/Technical Data</strong>: IP address, browser type, and device information automatically provided by your browser.</li>
                            <li><strong>Cookies and Similar Technologies</strong>: used to maintain sessions and preferences.</li>
                        </ul>
                        <h4 class="font-bold">3. Sources of Information</h4>
                        <p>Information is provided directly by you or generated when you use the service (e.g., saving preferences). We may also receive limited technical data from service providers.</p>
                        <h4 class="font-bold">4. How We Use Information</h4>
                        <ul>
                            <li>Provide and operate the service (authentication, rendering content, saving preferences).</li>
                            <li>Maintain security, prevent abuse, and troubleshoot issues.</li>
                            <li>Communicate with you about updates or important service notices.</li>
                            <li>Comply with legal obligations.</li>
                        </ul>
                        <h4 class="font-bold">5. Legal Bases</h4>
                        <p>Under UK/EU GDPR, our processing bases include performance of a contract, legitimate interests (e.g., service improvement, security), and consent where applicable.</p>
                        <h4 class="font-bold">6. Sharing and Processors</h4>
                        <p>We use third‑party processors to provide the service, including Firebase (authentication and database) and Google services (e.g., Drive and YouTube embeds). These providers process data on our behalf per their terms.</p>
                        <h4 class="font-bold">7. Data Retention</h4>
                        <p>We retain personal data for as long as necessary to provide the service and comply with legal obligations. You may request deletion at any time via Account settings or by contacting us.</p>
                        <h4 class="font-bold">8. Security</h4>
                        <p>We take reasonable measures to protect your information; however, no method of transmission or storage is 100% secure.</p>
                        <h4 class="font-bold">9. International Transfers</h4>
                        <p>Your data may be processed outside your country. Where required, we implement appropriate safeguards.</p>
                        <h4 class="font-bold">10. Your Rights</h4>
                        <ul>
                            <li>Access, correction, deletion, and portability of your data.</li>
                            <li>Restriction or objection to processing in certain circumstances.</li>
                            <li>Withdraw consent where processing is based on consent.</li>
                            <li>Lodge a complaint with the UK ICO or your local authority.</li>
                        </ul>
                        <h4 class="font-bold">11. Children's Privacy</h4>
                        <p>GCSEMate is designed for students. If you are under 13, use only with parent/guardian consent as required by local laws.</p>
                        <h4 class="font-bold">12. Cookies</h4>
                        <p>We use cookies essential to the operation of the service. Your browser may allow you to block cookies, but the service may not work properly if you do.</p>
                        <h4 class="font-bold">13. Changes</h4>
                        <p>We may update this policy to reflect legal or operational changes. We will post updates in the app and update the date below.</p>
                        <h4 class="font-bold">14. Contact</h4>
                        <p>Questions about privacy? Contact: <a href="mailto:admin@gcsemate.com">admin@gcsemate.com</a>.</p>
                        <p><em>Last updated: August 2025</em></p>
                      </div>
                </div>`;
        }

        function showDmcaModal() {
            const modal = document.getElementById('dmca-modal');
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl w-full max-w-2xl flex flex-col fade-in max-h-[90vh]">
                     <div class="p-4 border-b border-gray-200/50 flex justify-between items-center">
                         <h3 class="text-lg font-semibold text-gray-800">DMCA & Content Removal Policy</h3>
                         <button onclick="document.getElementById('dmca-modal').style.display='none'" class="text-2xl font-bold text-gray-500 hover:text-gray-800 p-1 leading-none" data-tooltip="Close">×</button>
                     </div>
                     <div class="p-6 space-y-4 overflow-y-auto">
                         <p>GCSEMate respects the intellectual property rights of others and expects its users to do the same. In accordance with the Digital Millennium Copyright Act (DMCA), we will respond promptly to notices of alleged copyright infringement.</p>
                         <h4 class="font-bold pt-2">Content Removal Requests:</h4>
                         <p>If you are a copyright owner and believe that your copyrighted work has been used on this site in a way that constitutes copyright infringement, please provide our designated agent with a written communication that includes the following:</p>
                         <ul class="list-disc list-inside space-y-1 text-sm">
                             <li>A physical or electronic signature of a person authorized to act on behalf of the owner of an exclusive right that is allegedly infringed.</li>
                             <li>Identification of the copyrighted work claimed to have been infringed.</li>
                             <li>Identification of the material that is claimed to be infringing and information reasonably sufficient to permit us to locate the material.</li>
                             <li>Information reasonably sufficient to permit us to contact you, such as an address, telephone number, and, if available, an email address.</li>
                             <li>A statement that you have a good faith belief that use of the material in the manner complained of is not authorized by the copyright owner, its agent, or the law.</li>
                             <li>A statement that the information in the notification is accurate, and under penalty of perjury, that you are authorized to act on behalf of the owner of an exclusive right that is allegedly infringed.</li>
                         </ul>
                         <p class="text-sm pt-2">Please send your notice to our designated agent at: <strong>admin@gcsemate.com</strong></p>
                     </div>
                </div>`;
        }
        function showPasswordResetModal(email = '') {
            const modal = document.getElementById('legal-modal');
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl w-full max-w-sm p-8 space-y-4 fade-in">
                    <h3 class="text-xl font-bold text-gray-800 text-center">Reset Your Password</h3>
                    <p class="text-sm text-gray-600 text-center">Enter your account's email address and we will send you a link to reset your password.</p>
                    <input id="reset-email-input" type="email" value="${email}" placeholder="Enter your email" required class="w-full p-3 rounded-lg border border-gray-300/50 bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <button onclick="handleSendPasswordReset()" class="w-full p-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors">Send Reset Link</button>
                    <p id="reset-message" class="text-sm text-center h-4"></p>
                    <div class="text-center">
                        <button onclick="document.getElementById('legal-modal').style.display='none'" class="text-sm text-gray-600 hover:underline">Cancel</button>
                    </div>
                </div>
            `;
        }
        async function handleSendPasswordReset() {
            const emailInput = document.getElementById('reset-email-input');
            const messageEl = document.getElementById('reset-message');
            const email = emailInput.value.trim();
            if (!email) {
                messageEl.textContent = 'Please enter an email address.';
                messageEl.className = 'text-red-600 text-sm text-center h-4';
                return;
            }
            try {
                await auth.sendPasswordResetEmail(email);
                messageEl.textContent = 'Reset link sent! Check your inbox.';
                messageEl.className = 'text-green-600 text-sm text-center h-4';
                emailInput.disabled = true;
            } catch (error) {
                console.error("Password reset error:", error);
                const friendlyMessage = handleAPIError(error, 'password reset');
                messageEl.textContent = friendlyMessage;
                messageEl.className = 'text-red-600 text-sm text-center h-4 transition-all duration-300';
            }
        }
        // Returns an embeddable preview URL for supported types, or null if not supported
        function getPreviewEmbedUrl(file) {
            const mime = (file.mimeType || '').toLowerCase();
            // Google Workspace native types
            if (mime === 'application/vnd.google-apps.document') {
                return `https://docs.google.com/document/d/${file.id}/preview?embedded=true`;
            }
            if (mime === 'application/vnd.google-apps.spreadsheet') {
                return `https://docs.google.com/spreadsheets/d/${file.id}/preview?embedded=true`;
            }
            if (mime === 'application/vnd.google-apps.presentation') {
                return `https://docs.google.com/presentation/d/${file.id}/preview?embedded=true`;
            }
            if (mime === 'application/vnd.google-apps.drawing') {
                return `https://docs.google.com/drawings/d/${file.id}/preview?embedded=true`;
            }
            // Special handling for PDFs to prevent auto-download
            if (mime === 'application/pdf') {
                // Use the file/d/ID/preview format which is better for embedding and doesn't auto-download
                return `https://drive.google.com/file/d/${file.id}/preview`;
            }
            
            // Image types - use drive preview that doesn't trigger downloads
            if (mime.startsWith('image/')) {
                return `https://drive.google.com/uc?export=view&id=${file.id}`;
            }
            
            // Microsoft Office and other document types
            const drivePreviewMimes = [
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'application/vnd.ms-excel',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-powerpoint',
                'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'text/plain',
                'text/csv'
            ];
            
            if (drivePreviewMimes.includes(mime)) {
                return `https://drive.google.com/file/d/${file.id}/preview`;
            }
            
            // Video and audio files
            if (mime.startsWith('video/') || mime.startsWith('audio/')) {
                return `https://drive.google.com/uc?export=view&id=${file.id}`;
            }
            return null;
        }

        function showPreview(file) {
            const modal = document.getElementById('preview-modal');
                const embedUrl = getPreviewEmbedUrl(file);
            let content = '';
            if (embedUrl) {
                const openUrl = file.webViewLink || `https://drive.google.com/file/d/${file.id}/view`;
                content = `
                    <div class="w-full h-full relative">
                        <div id="preview-loading" class="absolute inset-0 flex items-center justify-center bg-black/30">
                            <div class="dots-spinner"><i></i><i></i><i></i></div>
                            <span class="ml-2 text-white font-semibold">Loading preview…</span>
                            <img src="gcsemate%20new.png" alt="GCSEMate" class="ml-3 h-6 w-auto opacity-90">
                        </div>
                        <iframe id="file-preview-frame" src="${embedUrl}" class="w-full h-full border-0 bg-black" allow="autoplay; clipboard-write; encrypted-media" allowfullscreen referrerpolicy="no-referrer-when-downgrade"></iframe>
                        <div id="preview-fallback" class="absolute inset-0 hidden items-center justify-center text-center p-6">
                            <div class="bg-white/95 backdrop-blur-md p-6 rounded-xl shadow-xl max-w-md border border-gray-200">
                                <div class="flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-yellow-100 rounded-full">
                                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h4 class="text-lg font-bold text-gray-800 mb-2">Preview Unavailable</h4>
                                <p class="text-sm text-gray-600 mb-4">This file cannot be previewed directly. This might be due to browser security settings, file format limitations, or temporary connectivity issues.</p>
                                <div class="flex flex-col gap-3">
                                    <button id="reload-preview-btn" class="px-4 py-2 rounded-md bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                        Try Again
                                    </button>
                                    <div class="flex flex-col sm:flex-row gap-2">
                                        <a href="${openUrl}" target="_blank" rel="noopener noreferrer" class="px-4 py-2 rounded-md bg-green-600 text-white font-semibold hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                            </svg>
                                            View Online
                                        </a>
                                        <button onclick="downloadFile('${file.id}', '${file.name}', '${file.webContentLink || `https://drive.google.com/uc?export=download&id=${file.id}`}')" class="px-4 py-2 rounded-md bg-gray-700 text-white font-semibold hover:bg-gray-800 transition-colors flex items-center justify-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else {
                content = `
                    <div class="text-center bg-gray-100 p-8 rounded-lg">
                        <img src="${file.iconLink}" class="w-16 h-16 mx-auto mb-4" alt="${file.name}">
                        <h4 class="text-xl font-bold text-gray-800 mb-2">Preview not available</h4>
                        <p class="text-gray-600 mb-6">This file type (${file.mimeType}) cannot be previewed directly in the app.</p>
                        <a href="${file.webViewLink}" target="_blank" rel="noopener noreferrer" class="px-6 py-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors inline-flex items-center gap-2">
                            <img src="gcsemate%20new.png" alt="GCSEMate" class="h-5 w-5">
                            Open in Google Drive
                        </a>
                    </div>
                `;
            }
            const externalUrl = file.webViewLink || `https://drive.google.com/file/d/${file.id}/view`;
            modal.innerHTML = `
                <div class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl w-full max-w-6xl h-[90vh] flex flex-col fade-in">
                    <div class="p-4 border-b border-gray-200/50 flex justify-between items-center flex-shrink-0">
                        <div class="flex items-center min-w-0 gap-2">
                            <img src="gcsemate%20new.png" alt="GCSEMate" class="h-6 w-auto hidden sm:block">
                            <h3 class="text-lg font-semibold text-gray-800 truncate pr-4">${file.name}</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <a href="${externalUrl}" target="_blank" rel="noopener noreferrer" class="px-3 py-1.5 rounded-md bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700" data-tooltip="Open in Google Drive">Open</a>
                            <button onclick="document.getElementById('preview-modal').style.display='none'" class="text-2xl font-bold text-gray-500 hover:text-gray-800 p-1 leading-none flex-shrink-0" data-tooltip="Close">×</button>
                        </div>
                    </div>
                    <div class="flex-grow bg-gray-800">${content}</div>
                </div>
            `;
            modal.style.display = 'flex';
            // Setup enhanced preview load/fallback logic
            try {
                const frame = document.getElementById('file-preview-frame');
                const loading = document.getElementById('preview-loading');
                const fallback = document.getElementById('preview-fallback');
                const reloadBtn = document.getElementById('reload-preview-btn');
                
                if (frame && loading && fallback) {
                    let loaded = false;
                    let retryCount = 0;
                    const maxRetries = 2;
                    
                    const hideLoading = () => {
                        loading.classList.add('hidden');
                        loading.classList.remove('flex');
                    };
                    
                    const showFallback = () => {
                        hideLoading();
                        fallback.classList.remove('hidden');
                        fallback.classList.add('flex');
                    };
                    
                    const showLoading = () => {
                        fallback.classList.add('hidden');
                        fallback.classList.remove('flex');
                        loading.classList.remove('hidden');
                        loading.classList.add('flex');
                    };
                    
                    // Enhanced timeout with progressive delays
                    const timeoutId = setTimeout(() => {
                        if (!loaded) {
                            console.warn('Preview load timeout after 6 seconds');
                            showFallback();
                        }
                    }, 6000); // Increased timeout for better reliability
                    
                    // Handle successful load
                    frame.addEventListener('load', () => {
                        // For cross-origin iframes (like Google Drive), we can't access contentDocument
                        // but the load event still fires when the iframe loads successfully
                        loaded = true;
                        clearTimeout(timeoutId);
                        hideLoading();
                        console.log('Preview loaded successfully');
                        
                        // Double-check after a short delay to ensure content is visible
                        setTimeout(() => {
                            if (frame.style.display !== 'none' && frame.offsetHeight > 0) {
                                // Frame is visible and has content
                                console.log('Preview confirmed visible');
                            }
                        }, 500);
                    }, { once: true });
                    
                    // Handle load errors
                    frame.addEventListener('error', (e) => {
                        loaded = false;
                        clearTimeout(timeoutId);
                        console.error('Preview load error:', e);
                        showFallback();
                    }, { once: true });
                    
                    // Reload button functionality
                    if (reloadBtn) {
                        reloadBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            loaded = false;
                            retryCount = 0;
                            showLoading();
                            
                            // Add cache-busting parameter
                            const originalSrc = frame.src.split('?')[0].split('&')[0];
                            frame.src = originalSrc + '?reload=' + Date.now();
                            
                            console.log('Manual preview reload triggered');
                        });
                    }
                }
            } catch (error) {
                console.error('Preview setup error:', error);
            }
        }

        // Controlled download function - only downloads when explicitly requested
        function downloadFile(fileId, fileName, downloadUrl) {
            try {
                // Show download feedback
                showToast(`Downloading ${fileName}...`, 'info');
                
                // Create a temporary link and trigger download
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName || 'download';
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                
                // Append to body, click, and remove
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message after a brief delay
                setTimeout(() => {
                    showToast(`${fileName} download started`, 'success');
                }, 500);
                
            } catch (error) {
                console.error('Download failed:', error);
                showToast('Download failed. Please try again.', 'error');
            }
        }
        
        // Error pages rendering helpers
        function showErrorPage(title, message) {
            document.body.innerHTML = `
                <div class="w-full min-h-screen flex items-center justify-center bg-gray-100 p-4">
                     <div class="bg-white/80 backdrop-blur-lg p-8 rounded-2xl shadow-xl border border-white/40 max-w-lg w-full text-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M12 2L2 22h20L12 2z" /></svg>
                         <h2 class="text-3xl font-bold text-gray-800 mb-2">${title}</h2>
                         <p class="text-gray-600 mb-6">${message}</p>
                         <a href="/" class="px-6 py-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700 transition-colors">Return Home</a>
                     </div>
                </div>`;
        }
        function showNotFoundPage() {
            showErrorPage('404 - Page not found', 'The page you are looking for does not exist or has been moved.');
        }
        
        // --- GAPI LOADER ---
        window.gapiLoaded = function() {
            isGapiReady = true;
            if (currentUser && currentUser.emailVerified) {
                renderDashboard();
            }
        }
        // --- RUN ON STARTUP ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('copyright-year').textContent = new Date().getFullYear();
            document.getElementById('landing-copyright-year').textContent = new Date().getFullYear();
            // Initialize reCAPTCHA widget if enterprise API is present
            try {
                if (window.grecaptcha && RECAPTCHA_SITE_KEY) {
                    // If explicit rendering is needed, enterprise auto-renders by class
                    // Ensure container has correct attributes already set in markup
                }
            } catch (e) {
                console.error('reCAPTCHA init failed:', e);
            }
            // Setup login/register form toggling
            document.getElementById('show-register-form').addEventListener('click', (e) => {
                e.preventDefault();
                showAuthPage(false);
            });
            document.getElementById('show-login-form').addEventListener('click', (e) => {
                e.preventDefault();
                showAuthPage(true);
            });
            // Setup password visibility toggle
            document.getElementById('show-password-btn').addEventListener('click', () => {
                const passwordInput = document.getElementById('password');
                const eyeOpen = document.getElementById('eye-open');
                const eyeClosed = document.getElementById('eye-closed');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    eyeOpen.classList.add('hidden');
                    eyeClosed.classList.remove('hidden');
                } else {
                    passwordInput.type = 'password';
                    eyeOpen.classList.remove('hidden');
                    eyeClosed.classList.add('hidden');
                }
            });
            
            // Setup other buttons
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('mobile-logout-button').addEventListener('click', handleLogout);
            document.getElementById('add-link-btn').addEventListener('click', handleAddLink);
            document.getElementById('post-announcement-btn').addEventListener('click', postAnnouncement);
            document.getElementById('clear-announcement-btn').addEventListener('click', clearAnnouncement);
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar(calendarUserEvents, calendarGlobalEvents);
                updateCountdownBanner(); // Update countdown when month changes
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar(calendarUserEvents, calendarGlobalEvents);
                updateCountdownBanner(); // Update countdown when month changes
            });
            // Setup file browser controls
            // Debounced auto-search with smooth feedback
            let searchDebounce;
            const searchInputEl = document.getElementById('file-search-input');
            searchInputEl.addEventListener('input', () => {
                if (searchDebounce) clearTimeout(searchDebounce);
                const host = document.querySelector('#file-browser-controls .relative');
                if (host && !host.querySelector('.dots-spinner')) {
                    const dot = document.createElement('div');
                    dot.className = 'dots-spinner absolute right-3 top-1/2 -translate-y-1/2';
                    dot.innerHTML = '<i></i><i></i><i></i>';
                    host.appendChild(dot);
                }
                searchDebounce = setTimeout(() => {
                    renderItems();
                }, 160);
            });
            document.getElementById('file-sort-select').addEventListener('change', () => renderItems());
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('.view-btn.bg-blue-100')?.classList.remove('bg-blue-100', 'text-blue-700');
                    btn.classList.add('bg-blue-100', 'text-blue-700');
                    fileBrowserView = btn.dataset.view;
                    renderItems();
                });
            });
            document.querySelector('.view-btn[data-view="list"]').classList.add('bg-blue-100', 'text-blue-700');

            // Scroll-to-top button
            const scrollTopBtn = document.getElementById('scroll-top');
            const contentArea = document.getElementById('page-content');
            if (scrollTopBtn && contentArea) {
                contentArea.addEventListener('scroll', () => {
                    if (contentArea.scrollTop > 400) {
                        scrollTopBtn.classList.remove('hidden');
                        scrollTopBtn.classList.add('fade-in');
                    } else {
                        scrollTopBtn.classList.add('hidden');
                    }
                }, { passive: true });
                scrollTopBtn.addEventListener('click', () => {
                    contentArea.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }

            // Animate pricing table rows on intersection
            try {
                const body = document.getElementById('pricing-compare-body');
                if (body) {
                    const rows = Array.from(body.querySelectorAll('tr'));
                    const io = new IntersectionObserver((entries) => {
                        entries.forEach((entry) => {
                            if (entry.isIntersecting) {
                                rows.forEach((row, i) => {
                                    setTimeout(() => {
                                        row.classList.remove('opacity-0','translate-y-2');
                                        row.classList.add('opacity-100','translate-y-0');
                                    }, i * 80);
                                });
                                io.disconnect();
                            }
                        });
                    }, { threshold: 0.2 });
                    io.observe(body);
                }
            } catch (_) {}

            // Setup nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetPage = link.dataset.page;
                    if (!targetPage) return;
                    showPage(targetPage);
                });
            });

            // Keyboard shortcuts and navigation
            let goPrefix = false; // 'g' then key
            document.addEventListener('keydown', (e) => {
                // Don't interfere with form inputs
                if (e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
                
                // Don't interfere with modals
                const activeModals = document.querySelectorAll('[id$="-modal"]');
                const hasOpenModal = Array.from(activeModals).some(modal => 
                    modal.style.display === 'flex' || !modal.classList.contains('hidden')
                );
                if (hasOpenModal) return;
                
                if (e.key === '?') {
                    e.preventDefault();
                    showPage('help-page');
                } else if (e.key === '/') {
                    e.preventDefault();
                    const fs = document.getElementById('file-search-input');
                    if (fs) {
                        fs.focus();
                        fs.select();
                    }
                } else if (e.key === 'Escape') {
                    // Close mobile menu if open
                    const mobileMenu = document.getElementById('mobile-menu');
                    if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                        // Use the same close animation
                        mobileMenu.style.transform = 'translateX(100%)';
                        mobileMenu.style.opacity = '0';
                        const hamburgerButton = document.getElementById('hamburger-button');
                        if (hamburgerButton) {
                            hamburgerButton.setAttribute('aria-expanded', 'false');
                        }
                        
                        setTimeout(() => {
                            mobileMenu.classList.add('hidden');
                            mobileMenu.style.display = 'none';
                            document.body.style.overflow = '';
                            if (hamburgerButton) {
                                hamburgerButton.focus();
                            }
                        }, 300);
                    }
                } else if (e.key.toLowerCase() === 'g') {
                    goPrefix = true;
                    setTimeout(() => { goPrefix = false; }, 800);
                } else if (goPrefix) {
                    const k = e.key.toLowerCase();
                    goPrefix = false;
                    const map = { 
                        d: 'subject-dashboard-page', 
                        v: 'videos-page', 
                        b: 'blog-page', 
                        c: 'calendar-page', 
                        u: 'useful-links-page', 
                        a: 'about-page', 
                        f: 'features-page', 
                        h: 'help-page', 
                        g: 'gcsemategpt-page' 
                    };
                    const target = map[k];
                    if (target) {
                        e.preventDefault();
                        showPage(target);
                    }
                }
            });
            
            // Improve focus management for better accessibility
            document.addEventListener('focusin', (e) => {
                // Add focus ring to focused elements
                if (e.target.matches('button, a, input, select, textarea, [tabindex]')) {
                    e.target.classList.add('focus-ring');
                }
            });
            
            document.addEventListener('focusout', (e) => {
                // Remove focus ring when element loses focus
                if (e.target.matches('button, a, input, select, textarea, [tabindex]')) {
                    e.target.classList.remove('focus-ring');
                }
            });

            // FAQ search
            const faqSearch = document.getElementById('faq-search');
            const faqContainer = document.getElementById('faq-container');
            const faqCount = document.getElementById('faq-results-count');
            if (faqSearch && faqContainer) {
                faqSearch.addEventListener('input', () => {
                    const q = faqSearch.value.trim().toLowerCase();
                    const items = faqContainer.querySelectorAll('.faq-item');
                    let visible = 0;
                    items.forEach(item => {
                        const txt = item.textContent.toLowerCase();
                        const match = txt.includes(q);
                        item.dataset.hidden = match ? 'false' : 'true';
                        if (match) visible++;
                    });
                    if (faqCount) faqCount.textContent = q ? `${visible} match${visible!==1?'es':''}` : '';
                });
            }

            // Accent color picker handling
            const picker = document.getElementById('accent-picker');
            const resetBtn = document.getElementById('reset-accent');
            if (picker) {
                picker.addEventListener('input', () => {
                    const rgb = hexToRgb(picker.value);
                    if (!rgb) return;
                    const palette = generateAccentPalette(rgb);
                    applyAccent(palette);
                    localStorage.setItem('gcsemate_accent', JSON.stringify(palette));
                });
                // Initialize picker value based on current accent if stored
                try {
                    const saved = localStorage.getItem('gcsemate_accent');
                    if (saved) {
                        const p = JSON.parse(saved);
                        const [r,g,b] = p.fiveHundred || p.fivehundred || p.fiveHundred || p.fiveHundred;
                        if (Array.isArray(p.fiveHundred)) {
                            picker.value = '#' + p.fiveHundred.map(v => v.toString(16).padStart(2,'0')).join('');
                        }
                    }
                } catch {}
            }
            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    const def = { fifty:[239,246,255], hundred:[219,234,254], threeHundred:[147,197,253], fourHundred:[96,165,250], fiveHundred:[59,130,246], sixHundred:[37,99,235], sevenHundred:[29,78,216] };
                    applyAccent(def);
                    localStorage.removeItem('gcsemate_accent');
                });
            }
            // Setup modals
            ['preview-modal', 'playlist-viewer-modal', 'blog-viewer-modal', 'dmca-modal', 'legal-modal', 'edit-user-modal', 'event-modal', 'confirmation-modal', 'upgrade-modal'].forEach(id => {
                const modal = document.getElementById(id);
                if(modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target.id === id) {
                            modal.style.display = 'none';
                            // Special case for viewers to stop media playback
                            if (id === 'playlist-viewer-modal' || id === 'blog-viewer-modal' || id === 'preview-modal') {
                                modal.innerHTML = '';
                            }
                        }
                    });
                    // Escape to close
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && modal.style.display === 'flex') {
                            modal.style.display = 'none';
                            if (id === 'playlist-viewer-modal' || id === 'blog-viewer-modal' || id === 'preview-modal') {
                                modal.innerHTML = '';
                            }
                        }
                    });
                }
            });
            
            // Setup Hamburger Menu
            const hamburgerButton = document.getElementById('hamburger-button');
            const closeMenuButton = document.getElementById('close-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileLogoutButton = document.getElementById('mobile-logout-button');
            
            if (hamburgerButton && mobileMenu && closeMenuButton) {
                hamburgerButton.addEventListener('click', () => {
                    // Show menu first, then animate in
                    mobileMenu.style.display = 'block';
                    mobileMenu.classList.remove('hidden');
                    hamburgerButton.setAttribute('aria-expanded', 'true');
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                    
                    // Trigger animation on next frame
                    requestAnimationFrame(() => {
                        mobileMenu.style.transform = 'translateX(0)';
                        mobileMenu.style.opacity = '1';
                    });
                    
                    // Focus management for accessibility
                    const firstFocusableElement = mobileMenu.querySelector('a, button');
                    if (firstFocusableElement) {
                        setTimeout(() => firstFocusableElement.focus(), 100);
                    }
                });
                
                closeMenuButton.addEventListener('click', () => {
                    // Animate out first, then hide
                    mobileMenu.style.transform = 'translateX(100%)';
                    mobileMenu.style.opacity = '0';
                    hamburgerButton.setAttribute('aria-expanded', 'false');
                    
                    // Hide menu after animation completes
                    setTimeout(() => {
                        mobileMenu.classList.add('hidden');
                        mobileMenu.style.display = 'none';
                        document.body.style.overflow = ''; // Restore scrolling
                        hamburgerButton.focus(); // Return focus to hamburger button
                    }, 300);
                });
                
                // Handle mobile menu links
                const mobileMenuLinks = mobileMenu.querySelectorAll('.nav-link');
                mobileMenuLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        closeMobileMenu();
                    });
                });
                
                // Handle mobile logout button
                if (mobileLogoutButton) {
                    mobileLogoutButton.addEventListener('click', () => {
                        closeMobileMenu();
                        handleLogout();
                    });
                }
                
                // Close mobile menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (!mobileMenu.contains(e.target) && !hamburgerButton.contains(e.target) && !mobileMenu.classList.contains('hidden')) {
                        closeMobileMenu();
                    }
                });
                
                // Close mobile menu when pressing Escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !mobileMenu.classList.contains('hidden')) {
                        closeMobileMenu();
                    }
                });
                
                // Close mobile menu when resizing to desktop
                window.addEventListener('resize', throttle(() => {
                    if (window.innerWidth >= 1024 && !mobileMenu.classList.contains('hidden')) {
                        closeMobileMenu();
                    }
                }, 250));
                
                // Helper function to close mobile menu with animation
                function closeMobileMenu() {
                    // Animate out first, then hide
                    mobileMenu.style.transform = 'translateX(100%)';
                    mobileMenu.style.opacity = '0';
                    hamburgerButton.setAttribute('aria-expanded', 'false');
                    
                    // Hide menu after animation completes
                    setTimeout(() => {
                        mobileMenu.classList.add('hidden');
                        mobileMenu.style.display = 'none';
                        document.body.style.overflow = ''; // Restore scrolling
                        hamburgerButton.focus(); // Return focus to hamburger button
                    }, 300);
                }
            }
            
            // Initialize new features
            initializeTooltips();
            initializeFaqAccordion();

            // Lightweight AOS on scroll
            const watch = Array.from(document.querySelectorAll('[data-animate]'));
            const ioAos = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        const el = entry.target;
                        const type = el.dataset.animate || 'fade-up';
                        el.classList.add('aos-animate');
                        const map = { 'fade-up':'aos-fade-up', 'blur-in':'aos-blur-in', 'zoom-in':'aos-zoom-in', 'slide-right':'aos-slide-right' };
                        el.classList.add(map[type] || 'aos-fade-up');
                        ioAos.unobserve(el);
                    }
                });
            }, { threshold: 0.18, rootMargin: '40px' });
            watch.forEach(el => ioAos.observe(el));

            // Load Google Drive API script
            const gapiScript = document.createElement('script');
            gapiScript.src = "https://apis.google.com/js/api.js";
            gapiScript.onload = () => window.gapiLoaded();
            gapiScript.onerror = () => console.error('Failed to load Google API script');
            document.head.appendChild(gapiScript);
        });

        // Global error handling to prevent silent failures
        window.addEventListener('error', (e) => {
            console.error('Unhandled error:', e.error || e.message);
            try { 
                showToast('An unexpected error occurred. Please refresh the page.', 'error'); 
            } catch (_) {
                // Fallback if toast system is not available
                console.error('Error showing toast:', _);
            }
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            try { 
                showToast('Something went wrong. Please try again.', 'error'); 
            } catch (_) {
                console.error('Error showing toast:', _);
            }
        });
        
        // Network status monitoring
        window.addEventListener('online', () => {
            showToast('Connection restored!', 'success');
        });
        
        window.addEventListener('offline', () => {
            showToast('You are offline. Some features may not work.', 'warning');
        });
        
        // Better error recovery
        function handleNetworkError(error, context = '') {
            console.error(`Network Error ${context}:`, error);
            
            if (!navigator.onLine) {
                showToast('You are offline. Please check your connection.', 'error');
                return 'Network connection required';
            }
            
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                showToast('Network error. Please check your connection and try again.', 'error');
                return 'Network error occurred';
            }
            
            showToast('Something went wrong. Please try again.', 'error');
            return 'An error occurred';
        }
        // Accent helpers
        function hexToRgb(hex) {
            const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return m ? [parseInt(m[1], 16), parseInt(m[2], 16), parseInt(m[3], 16)] : null;
        }
        function mix(a, b, t) { return Math.round(a + (b - a) * t); }
        function tint([r,g,b], t) { return [mix(r,255,t), mix(g,255,t), mix(b,255,t)]; }
        function shade([r,g,b], t) { return [mix(r,0,t), mix(g,0,t), mix(b,0,t)]; }
        function generateAccentPalette(rgb) {
            return {
                fifty: tint(rgb, 0.9),
                hundred: tint(rgb, 0.8),
                threeHundred: tint(rgb, 0.5),
                fourHundred: tint(rgb, 0.35),
                fiveHundred: rgb,
                sixHundred: shade(rgb, 0.2),
                sevenHundred: shade(rgb, 0.4),
                sevenHunded: shade(rgb, 0.4)
            };
        }
        function applyAccent(p) {
            const r = document.documentElement;
            const get = (k)=>Array.isArray(k)?k:k.split(',');
            r.style.setProperty('--accent-50', get(p.fifty).join(' '));
            r.style.setProperty('--accent-100', get(p.hundred).join(' '));
            r.style.setProperty('--accent-300', get(p.threeHundred).join(' '));
            r.style.setProperty('--accent-400', get(p.fourHundred).join(' '));
            r.style.setProperty('--accent-500', get(p.fiveHundred).join(' '));
            r.style.setProperty('--accent-600', get(p.sixHundred).join(' '));
            r.style.setProperty('--accent-700', get(p.sevenHundred || p.sevenHunded || p.sixHundred).join(' '));
        }
        
        // --- CALENDAR MODAL FUNCTIONS (CONTINUED) ---
        function openEventModal(date) {
            const modal = document.getElementById('event-modal');
            const userIsAdmin = currentUser.role === 'admin';
            const eventsForDay = calendarUserEvents[date] || [];
            const globalEventsForDay = calendarGlobalEvents[date] || [];
            
            let eventsHtml = '<p class="text-gray-500 text-sm">No events for this day.</p>';
            if (eventsForDay.length > 0 || globalEventsForDay.length > 0) {
                eventsHtml = [...globalEventsForDay, ...eventsForDay].map(event => `
                    <div class="p-3 rounded-lg ${event.isGlobal ? 'bg-green-100' : 'bg-blue-100'}">
                        <p class="font-bold text-gray-800">${event.title}</p>
                        <p class="text-sm text-gray-600">${event.description || ''}</p>
                        <div class="text-right mt-2">
                            <button onclick="editEvent('${date}', '${event.id}', ${event.isGlobal})" class="text-sm font-semibold text-blue-600 hover:underline">Edit</button>
                            <button onclick="deleteEvent('${date}', '${event.id}', ${event.isGlobal})" class="text-sm font-semibold text-red-600 hover:underline ml-2">Delete</button>
                        </div>
                    </div>
                `).join('');
            }
            modal.innerHTML = `
                <div class="bg-white/90 backdrop-blur-lg rounded-lg shadow-xl w-full max-w-lg flex flex-col fade-in max-h-[90vh]">
                    <div class="p-4 border-b border-gray-200/50 flex justify-between items-center">
                        <div class="flex items-center gap-2 min-w-0">
                            <img src="gcsemate%20new.png" alt="GCSEMate" class="h-6 w-auto hidden sm:block">
                            <h3 class="text-lg font-semibold text-gray-800 truncate">Events for ${new Date(date + 'T00:00:00').toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h3>
                        </div>
                        <button onclick="document.getElementById('event-modal').style.display='none'; resetEventForm();" class="text-2xl font-bold text-gray-500 hover:text-gray-800 p-1 leading-none" data-tooltip="Close">×</button>
                    </div>
                    <div class="p-6 space-y-4 overflow-y-auto">
                        <div class="space-y-3">${eventsHtml}</div>
                        <hr class="my-4">
                        <h4 class="font-bold text-gray-800" id="event-form-title">Add New Event</h4>
                        <form id="event-form" class="space-y-3" onsubmit="event.preventDefault(); handleSaveEvent('${date}')">
                             <input type="hidden" id="event-id">
                             <input id="event-title" type="text" placeholder="Event Title" required class="w-full p-2 rounded-lg border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-400">
                             <textarea id="event-description" placeholder="Description (optional)" class="w-full p-2 rounded-lg border-gray-300 bg-white focus:outline-none focus:ring-2 focus:ring-blue-400 h-24"></textarea>
                             <div class="space-y-2">
                                 <label class="flex items-center text-sm text-gray-700 select-none">
                                     <input id="event-countdown" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-yellow-500 focus:ring-yellow-400">
                                     <span class="ml-2 font-semibold">Enable Countdown Banner</span>
                                 </label>
                                 ${userIsAdmin ? `
                                     <label class="flex items-center text-sm text-gray-700 select-none">
                                         <input id="event-sync" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
                                         <span class="ml-2 font-semibold">Sync to all users (Global Event)</span>
                                     </label>
                                 ` : ''}
                             </div>
                             <div class="flex justify-end gap-3 pt-2">
                                 <button type="button" onclick="resetEventForm()" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300">Cancel</button>
                                 <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">Save Event</button>
                             </div>
                        </form>
                    </div>
                </div>
            `;
            modal.style.display = 'flex';
        }
        async function handleSaveEvent(date) {
            const title = document.getElementById('event-title').value.trim();
            if (!title) return;
            const eventId = document.getElementById('event-id').value || db.collection('dummy').doc().id;
            const isGlobal = document.getElementById('event-sync')?.checked || false;
            
            const eventData = {
                title,
                description: document.getElementById('event-description').value.trim(),
                enableCountdown: document.getElementById('event-countdown').checked,
                date: date
            };
            try {
                const collectionRef = isGlobal 
                    ? db.collection('globalEvents')
                    : db.collection('users').doc(currentUser.uid).collection('events');
                
                await collectionRef.doc(eventId).set(eventData);
                document.getElementById('event-modal').style.display = 'none';
                resetEventForm();
                 showToast('Event saved!', 'success');
            } catch (error) {
                console.error("Error saving event:", error);
                showToast("Could not save the event.", 'error');
            }
        }
        function editEvent(date, eventId, isGlobal) {
            const eventList = isGlobal ? calendarGlobalEvents[date] : calendarUserEvents[date];
            const event = eventList?.find(e => e.id === eventId);
            if (!event) return;
            document.getElementById('event-form-title').textContent = 'Edit Event';
            document.getElementById('event-id').value = event.id;
            document.getElementById('event-title').value = event.title;
            document.getElementById('event-description').value = event.description;
            document.getElementById('event-countdown').checked = event.enableCountdown;
            if (document.getElementById('event-sync')) {
                document.getElementById('event-sync').checked = isGlobal;
            }
        }
        async function deleteEvent(date, eventId, isGlobal) {
            showConfirmationModal("Are you sure you want to delete this event?", async () => {
                try {
                    const collectionRef = isGlobal
                        ? db.collection('globalEvents')
                        : db.collection('users').doc(currentUser.uid).collection('events');
                    await collectionRef.doc(eventId).delete();
                    openEventModal(date); // Re-open modal to show updated list
                    showToast('Event deleted.', 'success');
                } catch (error) {
                    console.error("Error deleting event:", error);
                    showToast("Could not delete the event.", 'error');
                }
            });
        }
        function resetEventForm() {
            document.getElementById('event-form-title').textContent = 'Add New Event';
            document.getElementById('event-form').reset();
            document.getElementById('event-id').value = '';
        }
        function updateCountdownBanner() {
            // This function combines both global and user events to find active countdowns
            const banner = document.getElementById('event-countdown-banner');
            activeCountdowns = [];
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            const allEvents = [];
            Object.values(calendarGlobalEvents).flat().forEach(event => allEvents.push({ ...event, dateObj: new Date(event.date + 'T00:00:00') }));
            Object.values(calendarUserEvents).flat().forEach(event => allEvents.push({ ...event, dateObj: new Date(event.date + 'T00:00:00') }));
            
            activeCountdowns = allEvents
                .filter(event => event.enableCountdown && event.dateObj >= now)
                .sort((a, b) => a.dateObj - b.dateObj);
            if (activeCountdowns.length > 0) {
                currentCountdownIndex = Math.min(currentCountdownIndex, activeCountdowns.length - 1);
                const nextEvent = activeCountdowns[currentCountdownIndex];
                const diffTime = (nextEvent?.dateObj instanceof Date ? nextEvent.dateObj.getTime() : new Date(nextEvent?.dateObj).getTime()) - now.getTime();
                const msPerDay = 1000 * 60 * 60 * 24;
                const rawDays = Number.isFinite(diffTime) ? diffTime / msPerDay : NaN;
                const diffDays = Number.isFinite(rawDays) ? Math.max(0, Math.ceil(rawDays)) : null;
                let countdownText = `${diffDays} day${diffDays !== 1 ? 's' : ''} until ${nextEvent.title}!`;
                if (diffDays === 0) countdownText = `Today: ${nextEvent.title}!`;
                if (diffDays === null) {
                    countdownText = `${nextEvent?.title ? nextEvent.title : 'Upcoming event'}`;
                }
                banner.innerHTML = `<div class="bg-yellow-400 text-yellow-900 p-3 text-center text-sm font-semibold flex justify-center items-center relative gap-3"><span>${countdownText}</span><button id="dismiss-countdown" class="px-2 py-0.5 rounded bg-yellow-500/40 hover:bg-yellow-500/60 text-yellow-950 text-xs">Dismiss</button></div>`;
                banner.classList.remove('hidden');
                const btn = document.getElementById('dismiss-countdown');
                if (btn) {
                    btn.onclick = () => {
                        banner.classList.add('hidden');
                    };
                }
            } else {
                banner.classList.add('hidden');
            }
        }
        // --- Clock Function ---
        function startClock() {
            const timeEl = document.getElementById('clock-time');
            const dateEl = document.getElementById('clock-date');
            if (!timeEl || !dateEl) return;
            function update() {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                dateEl.textContent = now.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
            update();
            clockInterval = setInterval(update, 1000);
        }
        
        // --- PERFORMANCE OPTIMIZATIONS ---
        // Intersection Observer for lazy loading
        const lazyLoadObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const element = entry.target;
                    if (element.dataset.src) {
                        element.src = element.dataset.src;
                        element.removeAttribute('data-src');
                        lazyLoadObserver.unobserve(element);
                    }
                }
            });
        }, {
            rootMargin: '50px 0px',
            threshold: 0.1
        });
        
        // Performance monitoring
        let performanceMetrics = {
            pageLoadTime: 0,
            firstContentfulPaint: 0,
            largestContentfulPaint: 0
        };
        
        // Track performance metrics
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const navigation = performance.getEntriesByType('navigation')[0];
                    if (navigation) {
                        performanceMetrics.pageLoadTime = navigation.loadEventEnd - navigation.loadEventStart;
                    }
                    
                    // Track Core Web Vitals
                    if ('PerformanceObserver' in window) {
                        const paintObserver = new PerformanceObserver((list) => {
                            for (const entry of list.getEntries()) {
                                if (entry.name === 'first-contentful-paint') {
                                    performanceMetrics.firstContentfulPaint = entry.startTime;
                                }
                            }
                        });
                        paintObserver.observe({ entryTypes: ['paint'] });
                        
                        const lcpObserver = new PerformanceObserver((list) => {
                            for (const entry of list.getEntries()) {
                                performanceMetrics.largestContentfulPaint = entry.startTime;
                            }
                        });
                        lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });
                    }
                }, 1000);
            });
        }
        
        // Optimize scroll performance
        const optimizedScrollHandler = throttle(() => {
            // Handle scroll-based animations or effects
            const scrollY = window.scrollY;
            const elements = document.querySelectorAll('[data-scroll-animate]');
            
            elements.forEach(element => {
                const rect = element.getBoundingClientRect();
                const isVisible = rect.top < window.innerHeight && rect.bottom > 0;
                
                if (isVisible) {
                    element.classList.add('animate-in');
                }
            });
        }, 16); // ~60fps
        
        window.addEventListener('scroll', optimizedScrollHandler, { passive: true });
        
        // Memory management
        window.addEventListener('beforeunload', () => {
            // Clean up observers and timers
            if (lazyLoadObserver) lazyLoadObserver.disconnect();
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            debounceTimers.forEach(timer => clearTimeout(timer));
            throttleTimers.forEach(timer => clearTimeout(timer));
        });
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"96e0902719929532","version":"2025.7.0","r":1,"token":"541e634d1bf9422f847b0ad79711efd4","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}}}' crossorigin="anonymous"></script>
</body>
</html>
